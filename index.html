<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>dplatz.de - notes of a java developer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <!--link href="css/bootstrap.min.css" rel="stylesheet"-->
    <link href="css/themes/sandstone.css" rel="stylesheet">
    <link href="css/asciidoctor.css" rel="stylesheet">
    <link href="css/base.css" rel="stylesheet">
    <link href="css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114748485-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-114748485-1');
    </script>
    
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->  

<nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary">

  <div class="container">
    <a class="navbar-brand" href="">dplatz.de</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarColor01">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Blog</a></li>
        <li class="nav-item"><a class="nav-link" href="https://dplatz.de/aiblog/">AI Blog</a></li>

        <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
        <li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
        <li class="nav-item"><a class="nav-link" href="tags/">Tags</a></li>
        <li class="nav-item"><a class="nav-link" href="feed.xml">Subscribe</a></li>
        <!--li  class="nav-item dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Notes <b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a href="git.html">Git</a></li>
            <li><a href="wildfly.html">Wildfly</a></li>
            
          </ul>
        </li-->

        <li class="nav-item">
          <a class="nav-link" href="https://github.com/38leinaD"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
          </span><span class="username">38leinaD</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/38leinaD"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
          </span><span class="username">38leinaD</span></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">

	<div class="page-header">
		<h1>Blog</h1>
	</div>
	
		<a href="blog/2025/idea-wsl.html"><h1>Window decoration for IntelliJ Idea in WSL</h1></a>
		<p class="postingdate"><em>29 June 2025</em></p>

		<p><div class="paragraph">
<p>You can thank me later but first go to <code>Help &#8594; Edit custom VM Options..</code> and add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># custom IntelliJ IDEA VM options (expand/override 'bin/idea64.vmoptions')
-Dawt.toolkit.name=WLToolkit</pre>
</div>
</div>
<div class="openblock clearfix">
<div class="content">
<div class="imageblock left">
<div class="content">
<img src="/blog/2025/images/idea-wsl/before.jpg" alt="Before" width="400">
</div>
<div class="title">Figure 1. Before; showing ugly WSL window decoration</div>
</div>
<div class="imageblock left">
<div class="content">
<img src="/blog/2025/images/idea-wsl/after.jpg" alt="After" width="400">
</div>
<div class="title">Figure 2. After; looks like Idea running natively under Windows</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The issue on the Jetbrains issue-tracker is <a href="https://youtrack.jetbrains.com/issue/JBR-6223/jetbrains-products-look-ugly-in-wslg">this</a>.</p>
</div></p>
  	
		<a href="blog/2024/langchain4j-ollama.html"><h1>Running a local LLM on Ollama and LangChain4J</h1></a>
		<p class="postingdate"><em>01 January 2024</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>When working on my personal projects, I see myself quiet often reaching out to ChatGPT for a quick explaination or tip. Unfortunately, this is not possible/allowed in most corporate environments.
That&#8217;s why I was naturally very interested in what it takes to run a Large Language Model (LLM) locally on my machine and maybe even enrich it with some domain knowledge and see if it can help in my daytime job for some use-case (either by fine-tuning wich is harder or by retrieval augmented generation (RAG)).</p>
</div>
<div class="paragraph">
<p>The AI journey for me just started, that&#8217;s why the goal of this post is to show how easy it is to run an LLM locally and access it from a Java-based application leveraging <a href="https://github.com/langchain4j/langchain4j">LangChain4J</a>.
As everyone has some favorite tools in his belt, it is natural to use them. That&#8217;s why my code example below is a self-contained JBang script that is leverarging <a href="https://quarkus.io/">Quarkus</a> and it&#8217;s <a href="https://github.com/quarkiverse/quarkus-langchain4j">LangChain4J extension</a>.
You can just as easily cut Quarkus out of the picture and use LangChain4J directly, but I was especially interested in the state of the Quarkus Integration for LangChain4J.</p>
</div>
<div class="paragraph">
<p>So, as you might have understood by now, LangChain4J is a big part of what allows you to access an LLM. What is important to understand here, is that it is only an abstraction to program against different AI services. LangChain4J does not actually run/host an LLM.
For that we will need another service that runs the LLM and exposes it so LangChain4J can access it. As a matter of fact, LangChain4J can integrate with OpenAI&#8217;s GPT models as they expose a Restful API for it.
In a similar fashion we can run an LLM locally with <a href="https://ollama.ai/">Ollama</a> and configure the exposed Restful endpoint for LangChain4J to use.
As this is just the beginning of the journey for me, I cannot explain to you what it would take to run/host an LLM in Java natively. For sure it must be technically possible, but then again, what is the big benefit?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installing_ollama">Installing Ollama</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So, first step is to install Ollama. I ran it under WSL on a Windows machine and the steps you can find <a href="https://ollama.ai/download/linux">here</a> are as simple as they get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>curl https://ollama.ai/install.sh | sh</pre>
</div>
</div>
<div class="paragraph">
<p>After this you need to download a model and then can interact with it via the commandline. If you have an already rather old Graphics cards like an NVidia RTX 2060 (with 6 GB VRAM), you can run a mid-sized model like Mistral 7b without problems on your GPU alone.
Run <code>ollama run mistral</code> which will download the model and then start a prompt to interact with it. The download is 4 GB, so it might take a few minutes depending on your internet speed.
If you feel like your PC is not capable of running this model, maybe try <a href="https://ollama.ai/library/orca-mini/tags">orca-mini</a> instead and run <code>ollama run orca-mini:3b</code>.
Generally, the models should be capable to run on a compatible GPU or fall back to running on the CPU. In case of running on the CPU, you will need a corresponding amount of RAM to load it.</p>
</div>
<div class="paragraph">
<p>Ollama will install as a service and expose a Restful API on port 11434. So, instead of using the command prompt you can also try to hit it via curl for a first test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>curl -i -X POST http://127.0.0.1:11434/api/generate -d '{"model": "mistral", "prompt": "Why is the sky blue?"}'</pre>
</div>
</div>
<div class="paragraph">
<p>Note that you have to provide your model that you download before as the <code>model</code> parameter.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quarkus_and_langchain4j">Quarkus and Langchain4J</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If this is working we can come to the next step and use the LLM from within our Java application. For that, we need the LangChain4J library which can talk to our Ollama service.
Also, as I am a big fan of JBang and Quarkus, these were my natural choice for integrating with LangChain4J. But you can just as well use Langchain4J directly without any framework. See <a href="https://github.com/langchain4j/langchain4j/blob/main/langchain4j-ollama/src/test/java/dev/langchain4j/model/ollama/OllamaLanguageModelIT.java">this test</a> for the most basic integration between Langchain4J and Ollama.</p>
</div>
<div class="paragraph">
<p>Now lets come to this self-contained JBang script that will interact with the Ollama-based LLM:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">///usr/bin/env jbang "$0" "$@" ; exit $?
//DEPS io.quarkus.platform:quarkus-bom:3.6.4@pom
//DEPS io.quarkus:quarkus-picocli
//DEPS io.quarkus:quarkus-arc
//DEPS io.quarkiverse.langchain4j:quarkus-langchain4j-ollama:0.5.1 <b class="conum">(1)</b>

//JAVAC_OPTIONS -parameters
//JAVA_OPTIONS -Djava.util.logging.manager=org.jboss.logmanager.LogManager

//Q:CONFIG quarkus.banner.enabled=false
//Q:CONFIG quarkus.log.level=WARN
//Q:CONFIG quarkus.log.category."dev.langchain4j".level=DEBUG
//Q:CONFIG quarkus.langchain4j.ollama.chat-model.model-id=mistral <b class="conum">(2)</b>

import static java.lang.System.out;

import com.fasterxml.jackson.annotation.JsonCreator;

import dev.langchain4j.service.SystemMessage;
import dev.langchain4j.service.UserMessage;
import io.quarkiverse.langchain4j.RegisterAiService;
import jakarta.enterprise.context.control.ActivateRequestContext;
import jakarta.inject.Inject;
import picocli.CommandLine;

@CommandLine.Command
public class QuarkusLangchainOllama implements Runnable {

    @Inject
    TriageService triage;

    @Override
    @ActivateRequestContext <b class="conum">(3)</b>
    public void run() {
        String review = "I really love this bank. Not!";
        out.println("Review: " + review);
        out.println("...");
        TriagedReview result = triage.triage(review);

        out.println("Sentiment: " + result.evaluation());
        out.println("Message: " + result.message());
    }
}

@RegisterAiService
interface TriageService {
    @SystemMessage("""
        You are working for a bank, processing reviews about
        financial products. Triage reviews into positive and
        negative ones, responding with a JSON document.
        """
    )
    @UserMessage("""
        Your task is to process the review delimited by ---.
        Apply sentiment analysis to the review to determine
        if it is positive or negative, considering various languages.

        For example:
        - `I love your bank, you are the best!` is a 'POSITIVE' review
        - `J'adore votre banque` is a 'POSITIVE' review
        - `I hate your bank, you are the worst!` is a 'NEGATIVE' review

        Respond with a JSON document containing:
        - the 'evaluation' key set to 'POSITIVE' if the review is
        positive, 'NEGATIVE' otherwise
        - the 'message' key set to a message thanking or apologizing
        to the customer. These messages must be polite and match the
        review's language.

        ---
        {review}
        ---
    """)
    TriagedReview triage(String review);
}

record TriagedReview(Evaluation evaluation, String message) {
    @JsonCreator
    public TriagedReview {}
}

enum Evaluation {
    POSITIVE,
    NEGATIVE
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The required dependency to interact with Ollama.</p>
</li>
<li>
<p>The model needs to be configured as this is needed for the <code>model</code> parameter in the Restful request to Ollama.</p>
</li>
<li>
<p>Without this, I got an error that RequestScope is not initalized. But the error-message from Quarkus was very helpful and directly gave me the solution.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can find the source-code/the JBang script <a href="https://github.com/38leinaD/jbang-catalog/blob/master/src/QuarkusLangchainOllama.java">here</a>.
I don&#8217;t want to explain the main code that much as I just took the example from this awesome <a href="https://quarkus.io/blog/quarkus-meets-langchain4j/">LangChain4J post by the Quarkus guys</a> and you can read about it over there, but I think there is one quiet awesome fact that needs to be pointed out about it:
In the prompt we are telling the LLM to return a JSON structure with specific key names. Based on this, we are setting up our JSON-serializable POJOs named <code>TriageReview</code> and <code>Evaluation</code>.
In case the LLM returns a correct JSON structure (which the Mistral model did for me), Quarkus can deserialize it into an instance of <code>TriagedReview</code>. So, even though LLMs are widely seen as chat bots and usally return human-readable text, it is not limited to this.
There is no need to do any kind of manual parsing of the responses. As it is directly returning JSON, it is just as if you were calling an Restful endpoint via an OpenAI specification.</p>
</div>
<div class="paragraph">
<p>As I was saying before, LangChain4J offers an abstraction over different AI services. You could have skipped the setup of Ollama completly and just tried it out with OpenAI&#8217;s GPT-3 or GPT-4. The main difference would have just been to change the dependency from <code>io.quarkiverse.langchain4j:quarkus-langchain4j-ollama:0.5.1</code> to <code>io.quarkiverse.langchain4j:quarkus-langchain4j-openai:0.5.1</code>.</p>
</div>
<div class="paragraph">
<p>The last thing to do is to run the script via the JBang CLI. It should rate the sentiment of the given comment as negative in case it works as expected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>jbang run --quiet QuarkusLangchainOllama.java</pre>
</div>
</div>
<div class="paragraph">
<p>Have fun with it.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2023/jupyter-diary.html"><h1>Ramblings in AI</h1></a>
		<p class="postingdate"><em>21 November 2023</em></p>

		<p><div class="paragraph">
<p>As I am progressing with my learnings in AI, I wanted to have a way to keep a diary. Though JBake is great for my main Java-based blog, it is not perfect for documenting in the Python realm. Here, Jupyter notebooks are king.
For that reason, I set up a seperate page to document my ramblings in Python and AI under <a href="https://dplatz.de/aiblog/" class="bare">https://dplatz.de/aiblog/</a>).</p>
</div></p>
  	
		<a href="blog/2023/aws-cdk-eks-alb.html"><h1>Deploying a Quarkus application using sticky sessions to AWS EKS using AWS CDK</h1></a>
		<p class="postingdate"><em>17 September 2023</em></p>

		<p><div class="paragraph">
<p>JSF applications rely on sticky sessions. This means, the server-side JVM maintains state (usally in memory) for a particular user/client. For this, each request needs to be routed to the same JVM; in Kubernetes language: to the same pod. The relation between client and server is achieved by sending a session-cookie to the browser. The browser sends this cookie to the server in every request. Now the infrastructure in between needs to be set up so it recognizes this cookie (it needs to be aware about this cookie / the name of the cookie) and routes / pins the request appropriately to the same pod.</p>
</div>
<div class="paragraph">
<p>I wanted to see how exactly this needs to be set up in the context of AWS Elastic Kubernetes Service (EKS). For that I created this <a href="https://github.com/38leinaD/aws-playground">Github repository</a>. It uses AWS' Java CDK to deploy the infrastructure (Elastic Container Registry, Elastic Kubernetes Service) and then deploys a simple Quarkus application that helped me verify the correct handling of the cookie / the stickyness.</p>
</div>
<div class="paragraph">
<p>The only step to run is <code>./deploy.sh all</code>. This will provision the AWS infrastructure and then deploy the application assuming you have used AWS on your system before and have valid AWS credentials configured.</p>
</div>
<div class="paragraph">
<p>Running <code>kubectl get pods -o wide</code> you should see that because we have provisioned two EC2 nodes as part of the Kubernetes cluster that the pods are running on different nodes.</p>
</div>
<div class="paragraph">
<p>The output of the <code>deploy.sh</code> should have given you the public endpoint that was provisioned (<code>Access @ <a href="http://&lt;aws-public-endpoint&gt;/hello" class="bare">http://&lt;aws-public-endpoint&gt;/hello</a></code> should have been printed). Accessing this endpoing will print all environment variables of the pod. If you run <code><a href="http://&lt;aws-public-endpoint&gt;/hello?var=HOSTNAME" class="bare">http://&lt;aws-public-endpoint&gt;/hello?var=HOSTNAME</a></code> it will print only the hostname of the pod. You should see that on each request you get a different pod due to the load balancer.
If you access <code><a href="http://&lt;aws-public-endpoint&gt;/hello/session" class="bare">http://&lt;aws-public-endpoint&gt;/hello/session</a></code> instead, you should see that it should connect to the same pod each time because a cookie gets used.
The cookie name that is created in the code (<a href="https://github.com/38leinaD/aws-playground/blob/master/app/src/main/java/de/dplatz/TestResource.java#L29" class="bare">https://github.com/38leinaD/aws-playground/blob/master/app/src/main/java/de/dplatz/TestResource.java#L29</a>) needs to match the configuration of the Application Loadbalancer (ALB) in the ingress configuration (<a href="https://github.com/38leinaD/aws-playground/blob/master/deployment/k8s/services.yaml#L65" class="bare">https://github.com/38leinaD/aws-playground/blob/master/deployment/k8s/services.yaml#L65</a>; see <code>stickiness.app_cookie.cookie_name=mycookie</code>).</p>
</div>
<div class="paragraph">
<p>Please note that for the ingress to work properly, the ALB controller needs to be configured as part of provisioning the EKS cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">Cluster eksCluster = Cluster.Builder.create(this,"eks-cluster")
        .vpc(vpc)
        .vpcSubnets(List.of(
                SubnetSelection.builder().subnetType(SubnetType.PUBLIC).build(),
                SubnetSelection.builder().subnetType(SubnetType.PUBLIC).build(),
                SubnetSelection.builder().subnetType(SubnetType.PUBLIC).build()))
        .defaultCapacity(2)
        .defaultCapacityInstance(InstanceType.of(InstanceClass.T3, InstanceSize.SMALL))
        .defaultCapacityType(DefaultCapacityType.EC2)
        .mastersRole(clusterAdminRole)
        .albController(AlbControllerOptions.builder() <b class="conum">(1)</b>
                .version(AlbControllerVersion.V2_5_1)
                .build())
        .version(KubernetesVersion.V1_27).build();</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>ALB controller required by the ingress</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>See <a href="https://github.com/38leinaD/aws-playground/blob/master/deployment/aws/src/main/java/de/dplatz/CDKStack.java#L66-L68">here</a> for the full CDK stack.</p>
</div>
<div class="paragraph">
<p>Don&#8217;t forget to run <code>./deploy.sh destroy</code> at the end to shut everything down again.</p>
</div></p>
  	
		<a href="blog/2022/webstandards-with-rollup.html"><h1>Minimalist Webstandards with rollup.js</h1></a>
		<p class="postingdate"><em>16 October 2022</em></p>

		<p><div class="paragraph">
<p>I have been a long-time fan of what once was called <a href="https://www.pikapkg.com/blog/pika-web-a-future-without-webpack/">Pika</a> and now is called <a href="https://www.snowpack.dev/">Snowpack</a>.
Basically, it was the revolution how JavaScript web-apps are built. Instead of requiring a custom dev-server and doing a lot of "bundler magic" behind the scenes (basically every framework out there like Angular, Vue, etc. using Webpack), it just processed the Node dependencies and converted them into standard ES6 modules. What you could do now is reference this standard ES6 modules from your App without the need of a special build step on your application or custom dev-server. Modern browser can process imports like <code>import { html, LitElement } from './lib/lit-element.js';</code>. Just copy your HTML, standard/vanilla JS on a plain web-server (or use a generic tool like browser-sync) and way you go. You can read more about the general approach in one of my <a href="blog/2019/es6-bare-imports.html">previous posts</a>.</p>
</div>
<div class="paragraph">
<p>To me this approach always felt very natural, intuitive and did not introduce too much dependency on complex tools that lock you in.
With Snowpack 3, I am getting the same vibe now like previously with Webpack. It has become a complex tool (includes bundeling, minification, etc.) that requires you to now use it&#8217;s own dev-server.</p>
</div>
<div class="paragraph">
<p>For this reason, I have now moved back to a lower-level tool which is called <a href="https://rollupjs.org/guide/en/">rollup.js</a>. With rollup.js, we can convert Node dependency into standard ES6 modules. Nothing more and nothing less. You can find the full example project <a href="https://github.com/38leinaD/webstandards-starter">on GitHub</a>.</p>
</div>
<div class="paragraph">
<p>The main parts are the <code>package.json</code> with dependecy to <code>rollup</code> and the <code>webDependencies</code> section that I have kept analogous to how Pika/Snowpack have it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">{
  "name": "webstandards-starter",
  "version": "1.0.0",
  "description": "Starter project for web-development using the web's latest standards.",
  "main": "src/AppMain.js",
  "scripts": {
    "postinstall": "rollup -c", <b class="conum">(1)</b>
    "start": "browser-sync src -f src --single --cors --no-notify --single"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/38leinaD/webstandards-starter.git"
  },
  "author": "",
  "license": "ISC",
  "bugs": {
    "url": "https://github.com/38leinaD/webstandards-starter/issues"
  },
  "homepage": "https://github.com/38leinaD/webstandards-starter#readme",
  "devDependencies": {
    "browser-sync": "^2.27.10",
    "rollup": "^3.2.1", <b class="conum">(2)</b>
    "@rollup/plugin-node-resolve": "^15.0.0"
  },
  "dependencies": {
    "@vaadin/router": "^1.7.4",
    "lit-element": "^3.2.2"
  },
  "rollup": {
    "webDependencies": [ <b class="conum">(3)</b>
      "@vaadin/router/dist/vaadin-router.js",
      "lit-element/lit-element.js",
      "lit-html/directives/async-append.js",
      "lit-html/directives/async-replace.js",
      "lit-html/directives/cache.js",
      "lit-html/directives/class-map.js",
      "lit-html/directives/guard.js",
      "lit-html/directives/if-defined.js",
      "lit-html/directives/repeat.js",
      "lit-html/directives/style-map.js",
      "lit-html/directives/unsafe-html.js",
      "lit-html/directives/until.js"
    ]
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>postinstall</code> runs rollup when executing <code>npm install</code></p>
</li>
<li>
<p>devDependency to rollup and rollup plugin</p>
</li>
<li>
<p>Similar <code>webDependencies</code> configuration as known from Pika/Snowpack</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can see that I added a <code>postinstall</code> step executing <code>rollup -c</code>. What this will do is call rollup on <code>npm install</code> and use the <code>rollup.config.mjs</code> file which looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">import { nodeResolve} from '@rollup/plugin-node-resolve';
import * as fs from 'fs';
import * as path from 'path';

function outDir(relPath) {
  const nodeModulesPath = `./node_modules/${relPath}`
  const parentDir = path.dirname(relPath)

  // Just some basic logic how to generated output-paths under src/lib
  if (`${path.basename(parentDir)}.js` === path.basename(relPath)) {
    // lit-element/lit-element.js is simplified to 'src/lib/lit-element.js'
    return path.dirname(parentDir)
  }
  else {
    return path.dirname(relPath)
  }
}

export default JSON.parse(fs.readFileSync('package.json', 'utf8')).rollup.webDependencies.map(relPath =&gt; {
  console.log("Processing:", relPath)

  const nodeModulesPath = `./node_modules/${relPath}`

  return {
    input: [
      nodeModulesPath
    ],
    output: {
      dir: 'src/lib/' + outDir(relPath),
      format: 'esm',
    },
    plugins: [nodeResolve({
      browser: true
    })]
  };
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>What this does is the bare minimum of what Pika and Snowpack are also doing: Process each of the elements in <code>webDependencies</code> and convert the dependency into a standard ES6 module. The ES6 module is created under <code>src/lib</code> and allows for easy referencing via <code>import</code> from the application. After running the install-step, you can copy the app to any standard web-server; or use <code>browser-sync</code> for that matter.</p>
</div>
<div class="paragraph">
<p>I am not saying that this is the way to go for bigger commerical projects, but to me this makes for a simple and understandable setup that at least serves me well for learning purposes and personal projects. Eventually, most libraries/dependencies will come out of the box as  modules and the rollup step can be eliminated completely.</p>
</div></p>
  	
		<a href="blog/2022/aws-rds-iam.html"><h1>AWS RDS with IAM Auth</h1></a>
		<p class="postingdate"><em>06 August 2022</em></p>

		<p><div class="paragraph">
<p>When looking up things in the offical AWS Docs, code examples often still refer to AWS SDK version 1. Whereas the latest version of the SDK is version 2 and completly different API-wise.
Same so the other day when I needed to find out <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.Connecting.Java.html">how to generate an IAM token to access the AWS RDS Aurora database</a>.</p>
</div>
<div class="paragraph">
<p>Digging through a <a href="https://github.com/aws/aws-sdk-java-v2/issues/1157">Github issue</a> and a <a href="https://github.com/aws/aws-sdk-java-v2/pull/2057">pull-request</a> lead me to the solution:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">import software.amazon.awssdk.auth.credentials.DefaultCredentialsProvider;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.rds.RdsUtilities;
import software.amazon.awssdk.services.rds.model.GenerateAuthenticationTokenRequest;

public class IamTokenGenerator {

    public static String retrieveIamToken(String hostname, int port, String username) {
        RdsUtilities rdsUtilities = RdsUtilities.builder()
                .credentialsProvider(DefaultCredentialsProvider.create())
                .region(Region.EU_CENTRAL_1)
                .build();
        GenerateAuthenticationTokenRequest tokenRequest = GenerateAuthenticationTokenRequest.builder()
                .credentialsProvider(DefaultCredentialsProvider.create())
                .region(Region.EU_CENTRAL_1)
                .hostname(hostname)
                .port(port)
                .username(username)
                .build();
        return rdsUtilities.generateAuthenticationToken(tokenRequest);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following dependency is needed (<code>RdsUtilities</code> was only introduced in <code>2.16.3</code>!):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>implementation 'software.amazon.awssdk:rds:2.16.3'</pre>
</div>
</div>
<div class="paragraph">
<p>Maybe this can save someone a few minutes.</p>
</div></p>
  	
		<a href="blog/2021/quarkus-oidc-login.html"><h1>Quarkus - OIDC - Offering a Login button</h1></a>
		<p class="postingdate"><em>02 April 2021</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus offers an integration with OpenIdConnect (OIDC). This means, you can use indentity providers like Keycloak, ForgeRock or AWS Cognito to delegate your authentication needs. With Keycloak, you can also have identity brokering with other identity providers. This means, people can sign up with your application/service via Keycloak directly or people can also select an option like "Login with GitHub".</p>
</div>
<div class="paragraph">
<p>For the general usage of OIDC with Quarkus, please refer to <a href="https://quarkus.io/guides/security-openid-connect-web-authentication">this guide</a>. My post is about the specific need of offering a Login-button in your application; which I would have thought to be an out of the box feature. Don&#8217;t get me wrong; this is not hard to achieve, but also not trivial and well documented.</p>
</div>
<div class="paragraph">
<p>My general setup is a Quarkus application with server-side-rendered Web frontend. This may be JSF (the Quarkus Universe offers a MyFaces extension), but for me it was using the more lightweight <a href="https://quarkus.io/guides/qute-reference">Qute template library</a>; which feels more like Spring MVC with Thymeleaf.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_problem_statement">Problem Statement</h3>
<div class="paragraph">
<p>So, what exactly do we want? If a user is not logged in, there should be a Login-button. Once this button is pressed, the user should be redirected to the identity provider&#8217;s login page. Once the login is done, I would like to redirect the user to same URL he was coming from. I.e. the user might be browsing a specific page or product in the catalog and decides to log in.</p>
</div>
<div class="paragraph">
<p>The thing with offering a login button is that there is no URL to the login page. The redirects to the identity provider happen in Quarkus internally by intercepting the requests and checking if a URL is protected or not. If a URL is protected and there is not valid Access Token already exchanged, the login is triggered.
Also, in my case, most pages are not really protected but can be accessed by a unauthenticated as well as by a logged in user. The difference is just what actions are possible on the page.</p>
</div>
<div class="paragraph">
<p>This is the basic configuration for OIDC with Keycloak as my identity provider. You see, that <code>quarkus.http.auth.permission.permit1</code> gives full access all URLs also users that are not logged in.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>quarkus.oidc.enabled=true
quarkus.oidc.auth-server-url=http://localhost:8180/auth/realms/quarkus
quarkus.oidc.client-id=frontend
quarkus.oidc.application-type=web_app
quarkus.oidc.logout.path=/logout
quarkus.oidc.logout.post-logout-path=/
quarkus.oidc.token.refresh-expired=true
quarkus.oidc.authentication.session-age-extension=30M

quarkus.http.auth.permission.permit1.paths=/*
quarkus.http.auth.permission.permit1.policy=permit
quarkus.http.auth.permission.permit1.methods=GET,POST</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_solution">Solution</h3>
<div class="paragraph">
<p>The way to offer a login button is by registering a URL/endpoint that is actually protected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>quarkus.http.auth.permission.authenticated.paths=/login
quarkus.http.auth.permission.authenticated.policy=authenticated</pre>
</div>
</div>
<div class="paragraph">
<p>This URL is not provided by Quarkus but needs to be provided by ourselfs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Path("/")
public class IndexResource {

    // Other methods...

    @GET
    @Path("login")
    public Response login(@QueryParam("redirect") String redirect) {
        return Response.temporaryRedirect(URI.create(redirect)).build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>On my HTML page (Qute template), I offer a login button like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="html">&lt;a class="button is-light" href="javascript:location.href='/login?redirect=' + encodeURIComponent(location.href)"&gt;
    Login
&lt;/a&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>How exactly does this work when the user presses the Login button?</p>
</div>
<div class="paragraph">
<p>The Login button will send a GET request for the page <code>/login?redirect=&#8230;&#8203;</code>. The GET request contains a <code>redirect=&#8230;&#8203;</code> query parameter with the URL of the currently open page. The redirect is so after the login we can get back to this page.
Quarkus will notice from the config <code>quarkus.http.auth.permission.permit1</code> that <code>/login</code> is protected. If the user is not logged in, we will be redirected to the Keycloak login page. Once the login is done, Keycloak will redirect to the <code>/login</code> page. This will invoke our <code>IndexResource.login</code> method, where we will again redirect to the <code>redirect</code> parameter URL; bringing us back to the initial page the user pressed the Login button on. He is now logged in.</p>
</div>
<div class="paragraph">
<p>I hope the process is clear and it helps others to implement the same flow. To me, it looked like this is not very well documented and it felt to me like I had to come up with this solution myself and get confirmation that this was indeed the right approach.</p>
</div>
</div></p>
  	
		<a href="blog/2021/aws-cdk.html"><h1>AWS CDK &amp; JBang</h1></a>
		<p class="postingdate"><em>01 March 2021</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I am a big of AWS and the services it offers. What I am not a big fan of, is CloudFormation; in the sense that I don&#8217;t like to write huge YAML files to define my AWS resources.
An alternative approach is to use a tool like Ansible, where learning it, at least can be used also for other Cloud providers like Azure. But still, as a Java Developer, I don&#8217;t feel comforable writing extensive/large YAML or JSON files.</p>
</div>
<div class="paragraph">
<p>Meet the <a href="https://docs.aws.amazon.com/cdk/index.html">AWS Cloud Development Kit</a> (CDK), which essentially allows you to define your AWS resources by writing Java code.</p>
</div>
<div class="paragraph">
<p>CDK comes with a Node-based commandline, so you will first have to install Node 10+; now, install the <code>aws-cdk</code> CLI tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sudo npm install -g aws-cdk</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_maven">Maven</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What you could be doing now, is scaffold a Maven project and use it to define your recourses in Java code.
Within an empty directory for your project run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cdk init app --language=java</pre>
</div>
</div>
<div class="paragraph">
<p>You can now import this into your IDE of choice, define resource in Java and then deploy it using <code>cdk deploy</code> assuming you have a default profile for AWS set up on your system/user (check ~/.aws/credentials).</p>
</div>
<div class="paragraph">
<p>This is already quiet nice and I can recommand you to have a look at the <a href="https://www.youtube.com/watch?v=R3G35YAZUeg&amp;list=PLFjB4VDnlT_2ESzRwRrPnj47pn13K60iL">Video series by rickpil</a> and the great <a href="https://docs.aws.amazon.com/cdk/api/latest/docs/aws-construct-library.html">CDK API reference</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jbang">JBang</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What is even cooler, is that we can use it with JBang as well.
If you take a look at the Maven project, it is just a regular project without any specific plugins. The only thing that makes it work and ties it to the cdk CLI tool, is the <code>cdk.json</code> in the root folder. It contains an <code>app</code> parameter which gives it a command to run the application (<code>mvn -e -q compile exec:java</code>). Actually, what is happening, is that the Java application will produce a CloudFormation template, which is than feed to AWS.</p>
</div>
<div class="paragraph">
<p>So, what we need for a minimalist AWS deployment script using JBang, is the below two files only.</p>
</div>
<div class="listingblock">
<div class="title">awsdeployment.java</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">///usr/bin/env jbang "$0" "$@" ; exit $?
//DEPS software.amazon.awscdk:core:1.91.0
//DEPS software.amazon.awscdk:s3:1.91.0

import software.amazon.awscdk.core.App;
import software.amazon.awscdk.core.Construct;
import software.amazon.awscdk.core.Stack;
import software.amazon.awscdk.core.StackProps;
import software.amazon.awscdk.services.s3.Bucket;

import static java.lang.System.*;
import java.util.Arrays;

public class awsdeployment extends Stack {
    public static void main(final String[] args) {
        App app = new App();

        new awsdeployment(app, "AwsCdkTestStack");

        app.synth();
    }

    public awsdeployment(final Construct scope, final String id) {
        this(scope, id, null);
    }

    public awsdeployment(final Construct scope, final String id, final StackProps props) {
        super(scope, id, props);

        // Create an S3 bucket
        new Bucket(this, "MyBucket");

        // Create other resources...
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">cdk.json</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="json">{
  "app": "jbang awsdeployment.java",
  "context": {
    "@aws-cdk/core:enableStackNameDuplicates": "true",
    "aws-cdk:enableDiffNoFail": "true",
    "@aws-cdk/core:stackRelativeExports": "true",
    "@aws-cdk/aws-ecr-assets:dockerIgnoreSupport": true,
    "@aws-cdk/aws-secretsmanager:parseOwnedSecretName": true,
    "@aws-cdk/aws-kms:defaultKeyPolicies": true,
    "@aws-cdk/aws-s3:grantWriteWithoutAcl": true
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run <code>cdk deploy</code>, it should deploy an S3 bucket named "MyBucket" to AWS.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2021/firestarter.html"><h1>Firestarter - A fireplace with JBang and Quarkus</h1></a>
		<p class="postingdate"><em>17 February 2021</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>My dad built us a "fake fireplace" as decoration some time ago. Actually, it was a gift for my wife&#8217;s birthday.
After beeing placed in the hall for some time, it finally found the perfect spot in our living room.
With its new spot also came a power outlet right behind it. We thought it would be nice if the fireplace actually would be even "more fake"; so I got a spare Monitor, a Raspberry Pi and added a few lines of Java using <a href="https://quarkus.io/">Quarkus</a> and <a href="https://github.com/jbangdev/jbang">JBang</a>.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/38leinaD/jbang-catalog/blob/master/src/firestarter">Firestarter</a> is the final result. Essentially, it opens a browser in fullscreen and plays whichever YouTube clip you have configured. As I do not want to ask my wife to connect to the Raspberry Pi via SSH to change the clip, I added a small web-interface that can be easily opened on the phone.</p>
</div>
<div width="100%" align="center" >
<iframe width="560" height="315" src="https://www.youtube.com/embed/Er8jJSSBXEI" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, check via <code>java -version</code> if you have JDK 11 installed on the Raspberry Pi. If not, run</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sudo apt install default-jdk</pre>
</div>
</div>
<div class="paragraph">
<p>The simplest way to use Firestarter (which uses JBang) on the Raspberry Pi is via the <a href="https://github.com/jbangdev/jbang#zero-install">zero-installation approach</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>curl -Ls https://sh.jbang.dev | bash -s - firestarter@38leinaD</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_autostart">Autostart</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you would like to have Firestarter autostart after booting to the desktop, you just have to place below file in <code>~/.config/autostart/</code></p>
</div>
<div class="listingblock">
<div class="title">firestarter.desktop</div>
<div class="content">
<pre>[Desktop Entry]
Type=Application
Name=firestarter
uomment=Starts the firestarter app on startup
Exec=/bin/bash -c "sleep 10 &amp;&amp; curl -Ls https://sh.jbang.dev | bash -s - firestarter@38leinaD"
NotShowIn=GNOME;KDE;XFCE;</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>sleep</code> is just to wait a few seconds after boot so the Wifi is connected. Otherwise, the curl might fail. There are <a href="https://raspberrypi.stackexchange.com/questions/45769/how-to-wait-for-networking-on-login-after-reboot">more reliable alternatives</a> but it is good enough for me.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_move_mouse">Move mouse</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I had the problem that the mouse was placed on the taskbar after boot. That position is over the YouTube clip in Chrome later on and thus title and controls will stay visible.
To move the mouse out of the way, I used the answer to <a href="https://raspberrypi.stackexchange.com/questions/67791/how-to-move-mouse-pointer-to-a-specific-location-on-the-screen-at-boot">this stackoverflow question</a> and removed <code>@point-rpi</code> from <code>/home/pi/.config/lxsession/LXDE-pi/autostart</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_changing_the_fireplace_video">Changing the Fireplace Video</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Open <a href="http://pi.local:8080/firestarter">http://pi.local:8080/firestarter</a> (or whatever is the name/IP of your Raspberry Pi on the local network) from any Browser in your local network and paste the Url of a YouTube clip.</p>
</div>
<div class="paragraph">
<p>This one is especially nice if you are a fan of pixel-art: <a href="https://www.youtube.com/watch?v=mfkmcEtUVxQ">A Pixel Fireplace</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jbang_installation_on_rasperry_pi">JBang Installation on Rasperry Pi</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Just as a side-note: JBang is just a great tool for writing small scripts with Java. There are multiple ways to use/install JBang on the Raspberry Pi. One possibility is to install it via <a href="https://snapcraft.io/install/jbang/ubuntu">Snap</a>. Unfortunately, it does not have the latest version of JBang currently (see <a href="https://github.com/jbangdev/jbang-snap/issues/1">here</a>). So, firestarter will not work with the JBang version from Snap currently. Once the JBang version on Snap is updated, you could use it like this as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sudo snap install jbang --classic
jbang run firestarter@38leinaD</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Update: As of now, Snap hosts JBang 0.66.1 which is the latest version and is working with firestarter as well.
</td>
</tr>
</table>
</div>
</div>
</div></p>
  	
		<a href="blog/2020/quarkus-system-out-logging.html"><h1>Quarkus - StdOut to Log</h1></a>
		<p class="postingdate"><em>14 November 2020</em></p>

		<p><div class="paragraph">
<p>Quarkus uses JBoss Logging as it&#8217;s default logging implementation but you will not see <code>System.out.println</code> calls gettings routed to a logger.
From from JBoss/Wildfly, I am used to this and thus these calls end up in the log-file.
This is currently not done in Quarkus (see <a href="https://github.com/quarkusio/quarkus/issues/6766">this issue</a>.</p>
</div>
<div class="paragraph">
<p>If you <a href="https://quarkus.io/guides/logging">enable logging to a file</a> via <code>quarkus.log.file.enable=true</code> in your <code>application.properties</code>, you will not see these calls in your log-file.</p>
</div>
<div class="paragraph">
<p>Below is a simple class you can use to route all <code>System.out.println</code> calls in Quarkus to the logging system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">import java.io.OutputStream;
import java.io.PrintStream;

import org.jboss.logging.Logger;
import org.jboss.logging.Logger.Level;

public class JBossLoggingOutputStream extends OutputStream {
    private final Logger logger;
    private final Level level;
    private final StringBuffer buffer = new StringBuffer();

    public JBossLoggingOutputStream (Logger logger, Level level) {
        this.logger = logger;
        this.level = level;
    }

    public void write (int b) {
        byte[] bytes = new byte[1];
        bytes[0] = (byte) (b &amp; 0xff);
        String str = new String(bytes);

        if (str.equals("\n")) {
            flush ();
        }
        else {
            buffer.append(str);
        }
    }

    public void flush () {
        logger.log (level, buffer);
        buffer.setLength(0);
    }

    public static PrintStream createPrintStream(Logger logger, Level level) {
        return new PrintStream(new JBossLoggingOutputStream(logger, level));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should activate this class early on in your application. For example, by observing the <code>StartupEvent</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ApplicationScoped
public class Startup {

    void onStart(@Observes StartupEvent ev) {
        System.setOut(JBossLoggingOutputStream.createPrintStream(Logger.getLogger("io.quarkus"), Level.INFO));
        System.out.println("Application started.")
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see that the text <code>Application started</code> is shown in the console output with proper timestamp and thread information. Also, it ends up in your log-file if you have configured it properly.</p>
</div></p>
  	
		<a href="blog/2020/gradle-cache-files.html"><h1>Access of Jars from Gradle cache</h1></a>
		<p class="postingdate"><em>25 September 2020</em></p>

		<p><div class="paragraph">
<p>There are times where you quickly need the path to a JAR-file from the Gradle cache. For Maven this is quiet straight-forward as the path of a file in the local Maven cache (<code>~/.m2/repository</code>) is determined alone by the GAV coordinates.
This is not the case for Gradle. Files are located under <code>~/.gradle/caches</code> but the folder-names look like they are hash-values and the only way I know how to get the path of a JAR-file is by actually running a Gradle build-script that downloads and resolves the dependency.</p>
</div>
<div class="paragraph">
<p>For this reason, I now have a small shell-script that does it exactly that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="sh">#!/bin/bash
# gradle-resolve.sh
tmp_dir=$(mktemp -d)
cat &lt;&lt; EOF &gt; $tmp_dir/build.gradle
plugins {
    id 'java'
}

repositories {
    jcenter()
}

dependencies {
    implementation "$2"
}

tasks.register("getClasspath") {
    doLast {
        println configurations.runtimeClasspath.join(':')
    }
}

tasks.register("getJar") {
    doLast {
        println configurations.runtimeClasspath[0]
    }
}
EOF

(cd $tmp_dir &amp;&amp; gradle $1 --console=plain --quiet)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can be invoked with <code>getJar</code> to get the path of the JAR in the Gradle cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>gradle-resolve.sh getJar org.jboss:jandex:2.0.5.Final
/home/daniel/.gradle/caches/modules-2/files-2.1/org.jboss/jandex/2.0.5.Final/7060f67764565b9ee9d467e3ed0cb8a9c601b23a/jandex-2.0.5.Final.jar</pre>
</div>
</div>
<div class="paragraph">
<p>Or it can be invoked with <code>getClasspath</code> to get the whole runtime-classpath.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>gradle-resolve.sh getClasspath org.eclipse.jetty:jetty-server:9.4.29.v20200521
/home/daniel/.gradle/caches/modules-2/files-2.1/org.eclipse.jetty/jetty-server/9.4.29.v20200521/2c6590067589a0730223416c3157b1d4d121b95b/jetty-server-9.4.29.v20200521.jar:/home/daniel/.gradle/caches/modules-2/files-2.1/javax.servlet/javax.servlet-api/3.1.0/3cd63d075497751784b2fa84be59432f4905bf7c/javax.servlet-api-3.1.0.jar:/home/daniel/.gradle/caches/modules-2/files-2.1/org.eclipse.jetty/jetty-http/9.4.29.v20200521/21b761eae53b8e5201fb8fdf03b9865116a29b47/jetty-http-9.4.29.v20200521.jar:/home/daniel/.gradle/caches/modules-2/files-2.1/org.eclipse.jetty/jetty-io/9.4.29.v20200521/ffadd07dc4e9d0783531922ed565b667ad95766e/jetty-io-9.4.29.v20200521.jar:/home/daniel/.gradle/caches/modules-2/files-2.1/org.eclipse.jetty/jetty-util/9.4.29.v20200521/4866aa5271465f1d9035c4726209e4926fe1599c/jetty-util-9.4.29.v20200521.jar</pre>
</div>
</div>
<div class="paragraph">
<p>So, to run the <code>Main-Class</code> from the jandex jar, you can execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar $(gradle-resolve.sh getJar org.jboss:jandex:2.0.5.Final)</pre>
</div>
</div></p>
  	
		<a href="blog/2020/quarkus-custom-cdi-scope.html"><h1>Quarkus - Custom CDI Scopes</h1></a>
		<p class="postingdate"><em>11 September 2020</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus provides no full CDI implementation and as such, no support for CDI extension. This is because CDI extensions are inherently runtime-based and thus do not fit into Quarkus' model of doing as much as possible during build-time. No support for CDI extensions also means no standard support for registration of custom CDI scopes.</p>
</div>
<div class="paragraph">
<p>Well, it sounds like quiet a limitation, but actually Arc (Quarkus' CDI implementation) provides an API to register custom scopes.
And as you will see, implementing a custom scope is 99% the same as you know it from standard CDI.</p>
</div>
<div class="paragraph">
<p>In this post, I will show the code for a simple custom scope that that is local to the current thread; i.e. the context keeps track of thread-local state.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_annotation">Annotation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The scope is called <code>CallScoped</code> and that is also the the name of the annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Documented
@NormalScope
@Inherited
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})
public @interface CallScoped {}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_context">Context</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The context-class, which contains the main login of any custom scope, I will not put here in it&#8217;s entirety but only describe what is different to a standard CDI context. You can find the <code>CallScopeContext</code> <a href="https://github.com/38leinaD/quarkus-sandbox/blob/feature/custom-scope/extension/src/main/java/org/acme/CallScopeContext.java">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class CallScopeContext implements InjectableContext {

    static final ThreadLocal&lt;Map&lt;Contextual&lt;?&gt;, ContextInstanceHandle&lt;?&gt;&gt;&gt; ACTIVE_SCOPE_ON_THREAD = new ThreadLocal&lt;&gt;();

    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The context-class needs to implement <code>InjectableContext</code> which is Quarkus specific, but extends from the standard <code>AlterableContext</code>. So, there are only two additional methods to implement: <code>destroy</code> and <code>getState</code>. The first is to destroy the active scope entirely; and the second allows to capture and browse the state of the context. E.g. it enables <a href="https://quarkus.io/guides/cdi-reference#dev-mode">this dev-mode feature</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Override
public void destroy() {
    Map&lt;Contextual&lt;?&gt;, ContextInstanceHandle&lt;?&gt;&gt; context = ACTIVE_SCOPE_ON_THREAD.get();
    if (context == null) {
        throw new ContextNotActiveException();
    }
    context.values().forEach(ContextInstanceHandle::destroy);
}

@Override
public ContextState getState() {
    return new ContextState() {

        @Override
        public Map&lt;InjectableBean&lt;?&gt;, Object&gt; getContextualInstances() {
            Map&lt;Contextual&lt;?&gt;, ContextInstanceHandle&lt;?&gt;&gt; activeScope = ACTIVE_SCOPE_ON_THREAD.get();

            if (activeScope != null) {
                return activeScope.values().stream()
                        .collect(Collectors.toMap(ContextInstanceHandle::getBean, ContextInstanceHandle::get));
            }
            return Collections.emptyMap();
        }
    };
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_registration">Registration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The registration of the custom scope and context happens during built-time in a <code>@BuildStep</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class ApplicationExtensionProcessor {

    @BuildStep
    public void transactionContext(
            BuildProducer&lt;ContextRegistrarBuildItem&gt; contextRegistry) {

        contextRegistry.produce(new ContextRegistrarBuildItem(new ContextRegistrar() {
            @Override
            public void register(RegistrationContext registrationContext) {
                registrationContext.configure(CallScoped.class).normal().contextClass(CallScopeContext.class) // it needs to be of type InjectableContext...
                        .done();
            }
        }, CallScoped.class));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is one slight difference to a standard CDI context. As you see, the context-class is registered during build-time by just giving the type. With CDI and a CDI extension, you would provide an instance to CDI. This way, you can create and share a single reference to your context with the CDI implementation and the application-side. I.e. for our <code>CallScoped</code>, the <code>CallScopeContext</code> offers an API to the application to start a scope on the current thread via <code>enter</code> and <code>exit</code> methods (see <a href="https://github.com/38leinaD/quarkus-sandbox/blob/feature/custom-scope/extension/src/main/java/org/acme/CallScopeContext.java#L112-L148">here</a>).</p>
</div>
<div class="paragraph">
<p>Currently, this is a limitation of Quarkus as there is no possibility to share a single instance or access the runtime instance. But because state is usually stored in statics or thread-local, there is no problem in having actually two instances of the context-class; one used by Quarkus internally, one by the application-side. But support for this is already under consideration.</p>
</div>
<div class="paragraph">
<p>You can find the full code example <a href="https://github.com/38leinaD/quarkus-sandbox/tree/feature/custom-scope">here</a>. It&#8217;s on a branch of my <a href="https://github.com/38leinaD/quarkus-sandbox/tree/feature/custom-scope">quarkus-sandbox</a> repo which is a good starting point if you want to experiment with Quarkus + Quarkus Extensions (using Gradle).</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2020/jitpack-and-gradle-plugin-fix.html"><h1>jitpack.io for Gradle Plugins</h1></a>
		<p class="postingdate"><em>29 June 2020</em></p>

		<p><div class="paragraph">
<p>I extensively use the <a href="https://github.com/TwoStone/gradle-eclipse-compiler-plugin">gradle-eclipse-compiler-plugin</a>. This is a Gradle plugin that allows me to use the Eclipse JDT compiler for my Gradle builds instead of standard <code>javac</code> of my installed JDK.
Why is this useful? Because when I deploy e.g. a WAR file built with Gradle to an app-server and want to do remote-debugging and also hot-swap code in the debug session from my IDE, it is better to use the same compiler for both IDE and Gradle.
Otherwise this causes problems where constructs like lambda expression are compiled differently and the debug-session will not be able to swap the code; e.g. saying that methods where added or removed.</p>
</div>
<div class="paragraph">
<p>But this post is not about the usefulness of the plugin itself, but rather that it stopped working for me with Gradle 6 and I quickly wanted a fix that I can also distribute to other people.
Obviously, I filed an issue and made a pull-request; but until the pull-request is merged how provide the fix to others?
Meet <a href="https://jitpack.io/#38leinaD/gradle-eclipse-compiler-plugin/fix~unrecognized-option-SNAPSHOT">jitpack.io</a> which provides a maven repository for all of Github. You can request artifacts from this repository and what it will do is check out the code from GitHub and build it on the fly. You can use the version to reference specific branches or commits.</p>
</div>
<div class="paragraph">
<p>So, to use my fix/PR, I had to add the following to my Gradle project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">buildscript {
    repositories {
            maven { url 'https://jitpack.io' }
    }
    dependencies {
        classpath group: 'com.github.38leinaD', name: 'gradle-eclipse-compiler-plugin', version: 'fix~unrecognized-option-SNAPSHOT'
    }
}

apply plugin: 'de.set.ecj'</code></pre>
</div>
</div></p>
  	
		<a href="blog/2020/async-profiler.html"><h1>Async Profiler for Java</h1></a>
		<p class="postingdate"><em>02 May 2020</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/jvm-profiling-tools/async-profiler">Async-profiler</a> is a low overhead sampling profiler for Java that produces nice flamegraphs to quickly see where CPU-cycles are eaten (<code>event=cpu</code>). It&#8217;s nice that it also shows where cycles are eaten in native code and is not biased twoards your application byte-code.
It also allows to analyze heap allocations (<code>event=alloc</code>).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/jvm-profiling-tools/async-profiler/raw/master/demo/SwingSet2.svg?sanitize=true" alt="SwingSet2">
</div>
</div>
<div class="paragraph">
<p>You can either attach it to an already running Java application or use an agent to to attach it on startup.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_attach_via_agent_on_startup">Attach via agent on startup</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>java -agentpath:/home/daniel/tools/async-profiler-1.7-linux-x64/build/libasyncProfiler.so=start,event=cpu,file=/tmp/profile-cpu.svg,interval=1000000,framebuf=2000000,simple -jar target/myapp.jar</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_attach_to_already_running_process">Attach to already running process</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>profiler.sh -e cpu -f /tmp/profile-cpu.svg  -i 1000000 -b 2000000 -s &lt;process-id&gt;</pre>
</div>
</div>
</div>
</div></p>
  	
		<a href="blog/2020/quarkus-native-image-windows.html"><h1>Quarkus - Building Native Images on Windows</h1></a>
		<p class="postingdate"><em>26 April 2020</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I have been having trouble in the past to build native images for Quarkus applications under Windows due to a chain of issues.</p>
</div>
<div class="paragraph">
<p>With Quarkus 1.3.2.Final, I can finally confirm that I am sucessfully able to build. See below for the steps and exact environment used.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_steps">Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As I don&#8217;t have a Windows system, I downloaded the VirtualBox image of Windows 10 from <a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">Microsoft</a>.</p>
</div>
<div class="paragraph">
<p>Within the VM, I installed <a href="https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-20.0.0/graalvm-ce-java11-windows-amd64-20.0.0.zip">GraalVM 2.0.0 for Java 11</a>.
See <a href="https://github.com/graalvm/graalvm-ce-builds/releases">here</a> for the latest releases.</p>
</div>
<div class="paragraph">
<p>I extracted GraalVM and from within the <code>bin</code> folder I ran <code>gu install native-image</code> to install the native-image tool.
I also set up <code>PATH</code>, <code>GRAALVM_HOME</code> and <code>JAVA_HOME</code> to point to the GraalVM folder. Well, <code>PATH</code> obviously to the <code>bin</code> folder.</p>
</div>
<div class="paragraph">
<p>Now, I installed Visual Studio 2019 as it is required for the native compilation. (the description on the <a href="https://www.graalvm.org/docs/reference-manual/native-image/#prerequisites">GraalVM page</a> is only very high-level)</p>
</div>
<div class="paragraph">
<p>Just because it is easier to describe and provide commands, I first <a href="https://chocolatey.org/docs/installation">installed Chocolatey</a> which is a package manager for Windows.</p>
</div>
<div class="paragraph">
<p>After this, you should be able to install Visual Studio from your Powershell (as Admin) like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="shell">choco install visualstudio2019-workload-vctools</code></pre>
</div>
</div>
<div class="paragraph">
<p>After this, you should find this file on your filesystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="shell">C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Auxiliary\Build\vcvars64.bat</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, run your native-image build from a Command-prompt. Note that you have to call the <code>vcvars64.bat</code> to have the proper build environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="shell">call "C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Auxiliary\Build\vcvars64.bat"
mvnw package -Pnative -DskipTests</code></pre>
</div>
</div>
</div>
</div></p>
  	
		<a href="blog/2020/quarkus-test-against-master.html"><h1>Quarkus - Testing against the latest code on master</h1></a>
		<p class="postingdate"><em>13 April 2020</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus is changing quickly. If you don&#8217;t want to wait for the next release or just need to test a fix quickly, there are two options to test against the latest code on master.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_locally">Build locally</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First option is to build Quarkus on your local system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/quarkusio/quarkus.git
cd quarkus
./mvnw clean install -Dquickly</pre>
</div>
</div>
<div class="paragraph">
<p>Now, reference the version <code>999-SNAPSHOT</code> in your <code>gradle.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>quarkusPluginVersion=999-SNAPSHOT
quarkusPlatformArtifactId=quarkus-bom
quarkusPlatformVersion=999-SNAPSHOT
quarkusPlatformGroupId=io.quarkus</pre>
</div>
</div>
<div class="paragraph">
<p>This works because you should have this in your <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">repositories {
    mavenLocal() // First look into local Maven repository under ~/.m2/repository
    mavenCentral()
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_latest_ci_snapshots">Latest CI snapshots</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Building Quarkus locally take a few minutes depending on your machine. Alternative is to use the latest snapshot that is published after each commit to master.</p>
</div>
<div class="paragraph">
<p>For this, you have to change your <code>build.gradle</code> to look into the snapshot repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">repositories {
    mavenLocal()
    maven {
       url "https://oss.sonatype.org/content/repositories/snapshots"
    }
    mavenCentral()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will have to do essentially the same in your <code>settings.gradle</code> because the repository for the Gradle plugin is resolved from here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">pluginManagement {
    repositories {
        mavenLocal()
        // Added the snapshots repo here!
        maven {
            url "https://oss.sonatype.org/content/repositories/snapshots"
        }
        mavenCentral()
        gradlePluginPortal()
    }
    plugins {
      id 'io.quarkus' version "${quarkusPluginVersion}"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Obviously, you will also have to make the change to your <code>gradle.properties</code> like above.</p>
</div>
<div class="paragraph">
<p>Gradle by default caches snaptshots for 24 hours. If you want to force Gradle to pull the latest snapshot, you can run the build like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./gradlew build --refresh-dependencies</pre>
</div>
</div>
</div>
</div></p>
  	
		<a href="blog/2020/quarkus-debug-test-under-gradle.html"><h1>Debugging Quarkus tests (from Gradle-based build)</h1></a>
		<p class="postingdate"><em>11 April 2020</em></p>

		<p><div class="paragraph">
<p>If you dive deeper into Quarkus and develop more serious applications it shows that Gradle is only the second consideration after Maven.
But it is unfair to make that argument because Quarkus also states that the Gradle-integrations is only in Preview.
Anyway, I sometimes struggle to find the correct configurations that work for Gradle.</p>
</div>
<div class="paragraph">
<p>One useful config to know is: How to enable remote-debugging for your <code>@QuarkusTest</code> and step through the test?</p>
</div>
<div class="paragraph">
<p>It seems, the Quarkus Gradle plugin collects <code>jvmArgs</code> from any existing <code>Test</code> task. That&#8217;s why you can enable the debugger like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">test {
    jvmArgs '-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005'
}</code></pre>
</div>
</div></p>
  	
		<a href="blog/2020/quarkus-graalvm-reflection.html"><h1>Quarkus - Understanding GraalVM native-image &amp; Reflection on the example of XML-parsing</h1></a>
		<p class="postingdate"><em>10 April 2020</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>A long time ago I wrote <a href="/blog/2018/graal-native-app.html">a post</a> on how to build a native-image with GraalVM.
Lately, I have been doing the same in the context of <a href="https://quarkus.io">Quarkus</a>.
In this post I want describe what I have learned about native-image and reflection in the context of Quarkus; but not necessarily limited to Quarkus.</p>
</div>
<div class="paragraph">
<p>It started with me wanting to build a native application for a simple Quarkus application that uses a JDK API for XML processing.
I.e. it uses code like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">private boolean isValidXmlFile(Path p) {
    try {
        if (p == null) return false;
        if (!p.toFile().exists()) return false;

        SAXParserFactory factory = SAXParserFactory.newInstance();
        factory.setValidating(false);
        factory.setNamespaceAware(true);

        SAXParser parser = factory.newSAXParser();

        XMLReader reader = parser.getXMLReader();
        reader.parse(new InputSource(new FileInputStream(p.toFile())));

        return true;
    }
    catch (SAXParseException spe) {
        return false;
    }
    catch (Exception e) {
        logger.error(String.format("Error while determining if file (%s) is a valid XML-file.",  p.getFileName().toString()), e);
        return false;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I tried to build a native image by executing <code>./gradlew nativeImage</code> and got this error when runing the native application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Exception in thread "main" javax.xml.parsers.FactoryConfigurationError: Provider com.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl not found
    at javax.xml.parsers.FactoryFinder.newInstance(FactoryFinder.java:194)
    at javax.xml.parsers.FactoryFinder.newInstance(FactoryFinder.java:147)
    at javax.xml.parsers.FactoryFinder.find(FactoryFinder.java:271)
    at javax.xml.parsers.SAXParserFactory.newInstance(SAXParserFactory.java:147)
    at de.dplatz.bpmndiff.entity.Diff.isValidXmlFile(Diff.java:122)
    at de.dplatz.bpmndiff.entity.Diff.determineIfSupported(Diff.java:113)
    at de.dplatz.bpmndiff.entity.Diff.ofPaths(Diff.java:95)
    at de.dplatz.bpmndiff.entity.Diff.ofPaths(Diff.java:73)
    at de.dplatz.bpmndiff.control.Differ.diff(Differ.java:39)
    at de.dplatz.bpmndiff.boundary.DiffResource.diff(DiffResource.java:31)
    at de.dplatz.bpmndiff.boundary.DiffResource_ClientProxy.diff(DiffResource_ClientProxy.zig:51)
    at de.dplatz.bpmndiff.UICommand.call(UICommand.java:65)
    at de.dplatz.bpmndiff.UICommand.call(UICommand.java:27)
    at picocli.CommandLine.executeUserObject(CommandLine.java:1783)
    at picocli.CommandLine.access$900(CommandLine.java:145)
    at picocli.CommandLine$RunLast.executeUserObjectOfLastSubcommandWithSameParent(CommandLine.java:2150)
    at picocli.CommandLine$RunLast.handle(CommandLine.java:2144)
    at picocli.CommandLine$RunLast.handle(CommandLine.java:2108)
    at picocli.CommandLine$AbstractParseResultHandler.execute(CommandLine.java:1975)
    at picocli.CommandLine.execute(CommandLine.java:1904)
    at de.dplatz.bpmndiff.UICommand.run(UICommand.java:55)
    at de.dplatz.bpmndiff.UICommand_ClientProxy.run(UICommand_ClientProxy.zig:72)
    at io.quarkus.runtime.ApplicationLifecycleManager.run(ApplicationLifecycleManager.java:111)
    at io.quarkus.runtime.Quarkus.run(Quarkus.java:61)
    at io.quarkus.runtime.Quarkus.run(Quarkus.java:38)
    at io.quarkus.runner.GeneratedMain.main(GeneratedMain.zig:30)
Caused by: java.lang.ClassNotFoundException: com.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl
    at com.oracle.svm.core.hub.ClassForNameSupport.forName(ClassForNameSupport.java:60)
    at java.lang.Class.forName(DynamicHub.java:1197)
    at javax.xml.parsers.FactoryFinder.getProviderClass(FactoryFinder.java:119)
    at javax.xml.parsers.FactoryFinder.newInstance(FactoryFinder.java:183)
    ... 25 more</pre>
</div>
</div>
<div class="paragraph">
<p>If you have read my previous post, you already know that a JSON-file needs to be provided to native-image so reflection can be used on these classes during runtime of the native application.</p>
</div>
<div class="paragraph">
<p>Based on the error, I was able to construct a file <code>reflect-config.json</code> with this content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[
  {
    "name": "com.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl",
    "methods": [
      {
        "name": "&lt;init&gt;",
        "parameterTypes": []
      }
    ]
  }
]</pre>
</div>
</div>
<div class="paragraph">
<p>Where does this file have to be placed so native-image picks it up? For Quarkus, there are three options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Place in <code>src/main/resources</code> and reference via application.properties (see <a href="https://quarkus.io/guides/writing-native-applications-tips">QUARKUS - TIPS FOR WRITING NATIVE APPLICATIONS</a>)</p>
</li>
<li>
<p>Place in <code>src/main/resources</code> and reference via build.gradle (see <a href="https://quarkus.io/guides/writing-native-applications-tips">QUARKUS - TIPS FOR WRITING NATIVE APPLICATIONS</a>)</p>
</li>
<li>
<p>Place in <code>src/main/resources/META-INF/native-image</code> and no further configuration is needed. It will be picked up automatically by convention.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For some reason, this third and simplest solution is not mentioned in the Quarkus guide; but maybe this is a new feature in GraalVM.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resource_bundles">Resource Bundles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After having done this, I build the native image again and ran my application. When it tried to parse a non-XML-file I was getting this new error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java.util.MissingResourceException: Could not load any resource bundle by com.sun.org.apache.xerces.internal.impl.msg.XMLMessages
    at jdk.xml.internal.SecuritySupport.lambda$getResourceBundle$5(SecuritySupport.java:274)
    at java.security.AccessController.doPrivileged(AccessController.java:81)
    at jdk.xml.internal.SecuritySupport.getResourceBundle(SecuritySupport.java:267)
    at com.sun.org.apache.xerces.internal.impl.msg.XMLMessageFormatter.formatMessage(XMLMessageFormatter.java:74)
    at com.sun.org.apache.xerces.internal.impl.XMLErrorReporter.reportError(XMLErrorReporter.java:357)
    at com.sun.org.apache.xerces.internal.impl.XMLErrorReporter.reportError(XMLErrorReporter.java:327)
    at com.sun.org.apache.xerces.internal.impl.XMLScanner.reportFatalError(XMLScanner.java:1471)
    at com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl$PrologDriver.next(XMLDocumentScannerImpl.java:1013)
    at com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl.next(XMLDocumentScannerImpl.java:605)
    at com.sun.org.apache.xerces.internal.impl.XMLNSDocumentScannerImpl.next(XMLNSDocumentScannerImpl.java:112)
    at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:534)
    at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:888)
    at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:824)
    at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:141)
    at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse(AbstractSAXParser.java:1216)
    at com.sun.org.apache.xerces.internal.jaxp.SAXParserImpl$JAXPSAXParser.parse(SAXParserImpl.java:635)
    at de.dplatz.bpmndiff.entity.Diff.isValidXmlFile(Diff.java:129)
    at de.dplatz.bpmndiff.entity.Diff.determineIfSupported(Diff.java:113)
    at de.dplatz.bpmndiff.entity.Diff.ofPaths(Diff.java:95)
    at de.dplatz.bpmndiff.entity.Diff.ofPaths(Diff.java:73)
    at de.dplatz.bpmndiff.control.Differ.diff(Differ.java:39)
    at de.dplatz.bpmndiff.boundary.DiffResource.diff(DiffResource.java:31)
    at de.dplatz.bpmndiff.boundary.DiffResource_ClientProxy.diff(DiffResource_ClientProxy.zig:51)
    at de.dplatz.bpmndiff.UICommand.call(UICommand.java:65)
    at de.dplatz.bpmndiff.UICommand.call(UICommand.java:27)
    at picocli.CommandLine.executeUserObject(CommandLine.java:1783)
    at picocli.CommandLine.access$900(CommandLine.java:145)
    at picocli.CommandLine$RunLast.executeUserObjectOfLastSubcommandWithSameParent(CommandLine.java:2150)
    at picocli.CommandLine$RunLast.handle(CommandLine.java:2144)
    at picocli.CommandLine$RunLast.handle(CommandLine.java:2108)
    at picocli.CommandLine$AbstractParseResultHandler.execute(CommandLine.java:1975)
    at picocli.CommandLine.execute(CommandLine.java:1904)
    at de.dplatz.bpmndiff.UICommand.run(UICommand.java:55)
    at de.dplatz.bpmndiff.UICommand_ClientProxy.run(UICommand_ClientProxy.zig:72)
    at io.quarkus.runtime.ApplicationLifecycleManager.run(ApplicationLifecycleManager.java:111)
    at io.quarkus.runtime.Quarkus.run(Quarkus.java:61)
    at io.quarkus.runtime.Quarkus.run(Quarkus.java:38)
    at io.quarkus.runner.GeneratedMain.main(GeneratedMain.zig:30)</pre>
</div>
</div>
<div class="paragraph">
<p>So, it seems not only reflection needs to be configured for native-image builds, but also resources and resource-bundles (e.g. localized error message). I solved this by placing a <code>resource-config.json</code> in the same folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "resources": [],
    "bundles": [
        {"name":"com.sun.org.apache.xerces.internal.impl.msg.XMLMessages"}
    ]
}</pre>
</div>
</div>
<div class="paragraph">
<p>After this, my native application was working succesfully.</p>
</div>
<div class="paragraph">
<p>There are two things to note here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Normally, this kind of configuration should not be needed for JDK-internal classes and APIs like the SAXParser. Unfortunately, there is a pending issue about the <code>java.xml</code> module: <a href="https://github.com/oracle/graal/issues/1387" class="bare">https://github.com/oracle/graal/issues/1387</a>.</p>
</li>
<li>
<p>Adding the <code>com.sun.org.apache.xerces.internal.impl.msg.XMLMessages</code> resource-bundle should also not be necessary. But even if it would be working, there is still an issue that  only the default locale is added to the native application; other locales would need to be added via the mechansim I have described (e.g. <code>com.sun.org.apache.xerces.internal.impl.msg.XMLMessages_de</code> for german messages). See the issue for details: <a href="https://github.com/oracle/graal/issues/911" class="bare">https://github.com/oracle/graal/issues/911</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automatically_generating_config_files">Automatically generating config files.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What I have done up to now is write the files manually. Is there a simpler way?
Well, I don&#8217;t really have much experience yet with generating these files but it can be done:</p>
</div>
<div class="paragraph">
<p>GraalVM comes with an agent that can be used to trace all the reflective access when running your application in normal JVM-mode.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -agentlib:native-image-agent=trace-output=/home/daniel/junk/trace.json -jar my-app.jar</pre>
</div>
</div>
<div class="paragraph">
<p>This will generate a trace of all reflective access and you can use it as help to generate your configuration manually.</p>
</div>
<div class="paragraph">
<p>Even simpler, the agent can be used to create the files that you can place under <code>src/main/resources/META-INF/native-image</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -agentlib:native-image-agent=experimental-class-loader-support,config-output-dir=../src/main/resources/META-INF/native-image/ -jar my-app.jar</pre>
</div>
</div>
<div class="paragraph">
<p>Would this have helped us with the SAXParser problem from above? Unfortunately not. At least not currently, because the agent specifically will not generate configuration for relective access of JDK-internal classes; it is only meant for libraries external to the JDK. Why? Because normally, it is assumed that all JDK internals are handled without any configuration needed. Unfortnunately, we have seen that this is currently not the case for the <code>jaxa.xml</code> module.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2020/using-java-preview-features-in-gradle-project.html"><h1>Using JDK Preview Features from a Gradle-based Eclipse-project</h1></a>
		<p class="postingdate"><em>01 March 2020</em></p>

		<p><div class="paragraph">
<p>This post is about working with preview features of Java (e.g. <a href="https://blog.codefx.org/java/switch-expressions/">JDK 13&#8217;s switch expressions preview</a>) from your Gradle project within Eclipse IDE with zero manual configuration. On top of that, my project uses <a href="https://quarkus.io/">Quarkus</a> which only makes a minimal difference as we have to consider the dev-mode as well.</p>
</div>
<div class="paragraph">
<p>If you are working with <code>javac</code> and <code>java</code> on the command-line only, it is very simple in general: You have to pass <code>--enable-preview</code> as an argument to <code>javac</code> and <code>java</code>.</p>
</div>
<div class="paragraph">
<p>In your <code>build.gradle</code> file you can do it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">// Enable for Java Compiler on src/main/java
compileJava {
    options.compilerArgs += ["--enable-preview"]
}

// Enable for Java Compiler on src/test/java
compileTestJava {
    options.compilerArgs += ["--enable-preview"]
}

// Enable for running tests
test {
    jvmArgs '--enable-preview'
}

// Enable for Quarkus DevMode runner which was my main use-case
quarkusDev {
    jvmArgs '--enable-preview'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you use preview features in your source-code, running a <code>gradlew build</code> on the commandline should now compile your code.
You can run the built JAR with <code>java --enable-preview -jar app.jar</code>.
In case you want to run your application from Gradle, you will have to configure the JVM args for this as well in your <code>build.gradle</code>; See the <a href="https://docs.gradle.org/current/dsl/org.gradle.api.tasks.JavaExec.html">JavaExec task</a>.</p>
</div>
<div class="paragraph">
<p>Unfortunately, Eclipse will not automatically infer the right settings for the Eclipse compiler and will show compile errors in your IDE.
The quick fix is to manually enable the preview feature in the Java Compiler project-settings (right-click on the project; Properties &gt; Java Compiler; check 'Enable preview features for Java 13'), but I would prefer that there are no manual steps needed.
I.e. a team member should be able to clone a Git repo, import it into Eclipse and all should be set up automatically.</p>
</div>
<div class="paragraph">
<p>On our way of achieving this, you first have to add this to our <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">// Add plugin at top of your build.gradle
apply plugin: 'eclipse'

// ...

//Buildship doesn't use that hooks (https://discuss.gradle.org/t/when-does-buildship-eclipse-customization-run/20781/2)
//you need to run `gradle eclipseJdt` separately
eclipse.jdt.file.withProperties { props -&gt;
    props['org.eclipse.jdt.core.compiler.problem.enablePreviewFeatures']= 'enabled'
    props['org.eclipse.jdt.core.compiler.problem.reportPreviewFeatures']= 'ignore'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It found it in this <a href="https://github.com/eclipse/eclipse.jdt.ls/pull/970">Eclipse JDT Github issue</a>.</p>
</div>
<div class="paragraph">
<p>When you now run the Gradle-task <code>eclipseJdt</code> you can do a Refresh of your Gradle project in Eclipse afterwards and you should see that the Java Compiler settings in Eclipse also have been properly set.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/blog/2020/images/eclipse-compiler-preview-features.jpg" alt="Eclipse Compiler Settings">
</div>
</div>
<div class="paragraph">
<p>The ultimate goal is that we don&#8217;t have to run this gradle-task manually. To achieve this, we can leverage another quiet new Buildship feature that triggers a gradle task whenever a project is imported into Eclipse or the project is refreshed. You can read about it <a href="https://blog.gradle.org/buildship-sync-task-exec">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">eclipse {
    synchronizationTasks eclipseJdt
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the last missing piece. Once you import the project into Eclipse, this task will automatically trigger and configure the Eclipse compiler. No manual steps or instructions you have to give to your team mates how to get the project imported properly.</p>
</div>
<div class="paragraph">
<p>I was expecting this task to also be triggered when you run "Refresh Gradle Project" for an already imported project, but this did not work for me yet. Instead, I had to delete the project from Eclipse and import it again. I still have to find out why.</p>
</div></p>
  	
		<a href="blog/2019/improved-integration-testing.html"><h1>Improving on Integration-Testing (with Arquillian)</h1></a>
		<p class="postingdate"><em>04 September 2019</em></p>

		<p><div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://arquillian.org/">Arquillian</a> is a testing-framework for Jakarta EE applications (formerly Java EE).</p>
</div>
<div class="paragraph">
<p>System-tests are run as a remote-client invoking a boundary-component of the tested application; e.g. an exposed JAX-RS/REST-endpoint.</p>
</div>
<div class="paragraph">
<p>Integration-tests are run within the container; allowing to test internal components of the application; e.g. you can inject an EJB or CDI-bean into your test and invoke a method.</p>
</div>
<div class="paragraph">
<p>Both types of tests have advantages and disadvantages where I find that the disadvantages of Integration-tests often outweight the benefits (in my projects).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can find a good introduction on different testing-techniques and their advantages/disadvantages in <a href="https://blog.sebastian-daschner.com/entries/thoughts-on-efficient-testing">this article series by Sebastian Daschner</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let me explain: The Jakarta EE applications that I am involved with are usually large, business-focused applications. This means, that I am rarely interested in testing the framework or the container. I am interested in testing how the application behaves in the correct way from a business-perspective. This can often be done quiet nice by calling external REST endpoints. My development-cycle involves a deployed/running application that allows me to hot-swap small code-changes (e.g. via Java&#8217;s remote-debugging API) and then invoke the system-test again to see if I get the expected result. Rinse and repeat.</p>
</div>
<div class="paragraph">
<p>Integration-tests on the other-hand don&#8217;t allow me the quick feedback cycle I get from system-tests. As the tests themselfs run in the server/application (and thus are deployed as part of the main WAR/EAR), I have to deploy a whole WAR/EAR to the app-server, run the tests and shut down the container again. If i make a change to the application-code or test, I have to repeat this rather long cycle where I do a full deployment.</p>
</div>
<div class="paragraph">
<p>The cycle is especially long when the application is not very modular/loosely coupled. Arquillian theoretically allwows me to build small test-deployments with Shrinkwrap but depending on the application the test-archive often has same magnitude as the whole application. So, deployment and thus testing is slow.</p>
</div>
<div class="paragraph">
<p>What I somtimes would like to have is the quick feedback-loop I get with system-tests but beeing able to test internals of the application that are not exposed via a Rest-endpoint.</p>
</div>
<div class="paragraph">
<p>How can we get integration-tests that behave more like system-tests? How can we get system-tests that allow us to call internal components of the application?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_warpunit">WarpUnit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Meet <a href="https://github.com/dcm4che/WarpUnit">WarpUnit</a>. I have been reading about it some time ago and found the idea quiet nice. It is a small testing-solution which allows you to run a system-test but be able to have snippets of code (lambda expressions) that are invoked within the container on server-side. Actually, the approach even allows injection of server-components similar to Arquillian&#8217;s integration-tests. Have a look at this very neat concept.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class GreeterGrayBoxTest {

    @Inject
    Greeter greeter;

    @Test
    public void testGreeter() {

        System.out.println("This is printed in the JUnit test output");

        WarpGate gate = WarpUnit.builder()
                .primaryClass(GreeterGrayBoxTest.class)
                .createGate();

        String greetingForBob = gate.warp(() -&gt; {
            System.out.println("This is printed in the server log");
            return greeter.greet("Bob");
        });

        Assert.assertEquals("Greetings, Bob !",greetingForBob);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>What happens here is that the <code>gate.warp()</code>-call will take the bytecode of our GreeterGrayBoxTest class, upload it to the server, load it via a custom class-loader and invoke the lambda within the server.
Even though the repo did not see a commit for a long time, the solution works when you use it with a recent Wildfly or Liberty. (Actually, the maintainers invited me to contribute and I made a small pull-request to fix the build; a jboss/redhat maven repo URL had changed.)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Just found out about <a href="https://github.com/arquillian/arquillian-extension-warp">Arquillian Warp</a> which seems to follow a similar approach.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_taking_it_to_the_next_level">Taking it to the next Level</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What I would like to have as a final solution is something that can transparently run as an Arquillian integration-test but can also be invoked like a WarpUnit-style test from outside the application-server.</p>
</div>
<div class="paragraph">
<p>You can find my proof-of-concept solution <a href="https://github.com/38leinaD/WarpUnit/blob/feature/integration-test-poc/warpunit-examples/greeter/greeter-test/src/test/java/org/dcm4che/warpunit/examples/integration/ArquillianStyleIntegrationTest.java">on GitHub</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RunWith(Warp.class)
public class ArquillianStyleIntegrationTest {

    @Inject
    Greeter greeter;

    @Test
    public void testGreeter() {
        System.out.println("This is printed in the server log");

        String result =  greeter.greet("Bob");

        assertThat(result, is("Greetings, Bob !"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the whole <code>testGreeter</code> method is run within the application-server instead of just running some code-snippets in the server. This is a great approach while doing development because I can make quick-changes in my test-code and rerun the test. When I am done, the approach allows me to just swtich the annotation from <code>@RunWith(Warp.class)</code> to <code>@RunWith(Arquillian.class)</code> and I am able to run it as a regular arquillian integration-tests.
Obviously, it would be nice to have a deeper arquillian integration that does not require me to change the annotation for this. Instead, it should be transparently handled by an arquillian extension. But this is for the future; after seeing if this approach works in real-world projects.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2019/history-based-routing.html"><h1>Javascript Router-friendly packaging as WAR-archive</h1></a>
		<p class="postingdate"><em>26 August 2019</em></p>

		<p><div class="paragraph">
<p>Routers in modern Javascript framworks usually support path&#8217;s similar to a Restful API. I.e. when the main page is <code>localhost:8080</code> and shows the landing page; then <code>localhost:8080/products/1</code> might show the page with the details for Product #1.
For a single-page application an in-app link to <code>localhost:8080/products/1</code> should not trigger a reload of the whole application but should be handled within the app. This is the main job of the router.</p>
</div>
<div class="paragraph">
<p>A lot of Javascript frameworks support this routing based on the browser&#8217;s history API.
<a href="https://vaadin.com/router">Vaadin Router</a> is just one example. Similar routers exist in Angular and friends.</p>
</div>
<div class="paragraph">
<p>For this to work, the web-server needs to serve the <code>localhost:8080/index.html</code> for any of these sub-resources/pages. This is because the Router in the Javascript code will deconstruct the URL and show the right page-fragments.</p>
</div>
<div class="paragraph">
<p>How can this be achived in a JavaEE environment where your front-end Javascript application is packaged inside a WAR-file?
Simple. Just use this <code>web.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee
    http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
    version="3.1"&gt;
    &lt;welcome-file-list&gt;
        &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;
    &lt;/welcome-file-list&gt;
    &lt;error-page&gt;
        &lt;error-code&gt;404&lt;/error-code&gt;
    &lt;location&gt;/index.html&lt;/location&gt;
    &lt;/error-page&gt;
&lt;/web-app&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A programatic solution is to use a servlet-filter that always routes to the <code>index.html</code>. <a href="https://github.com/kabir/blog-quarkus-ui-development/blob/master/src/main/java/org/kabir/quarkus/ui/AngularRouteFilter.java">Here</a> is from the post on <a href="https://quarkus.io/blog/quarkus-and-web-ui-development-mode/">Quarkus and Web UI Development</a>.</p>
</div></p>
  	
		<a href="blog/2019/openshift-starter.html"><h1>JavaEE App Deployment on Openshift/Minishift</h1></a>
		<p class="postingdate"><em>23 June 2019</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I have been watching <a href="https://www.redhat.com/en/events/webinar/cloud-native-java-application-development-video-series">this free course by RedHat</a> to get started on OpenShift.
This post contains my personal notes on the most important commands and concepts for later reference.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started_with_minishift">Getting started with MiniShift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I already wanted to do the course a few month back on my laptop running CentOS linux; but for some reason I ran into problems installing MiniShift.
After reinstalling my laptop with Debian, I gave it another go.
There have been a few small problems that cost me some time along the way and I will describe them as well</p>
</div>
<div class="paragraph">
<p>After installing Minishift (which is a local OpenShift cluster running in a VM), the intial steps are simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>minishift start // starts the cluster
eval $(minishift oc-env) // to connect the oc commandline-tool from OpenShift to the local cluster
oc login -u developer // log into the OpenShift cluster via the oc commandline-tool; password can be anything non-empty</pre>
</div>
</div>
<div class="paragraph">
<p>Essentially OpenShift runs your applications in Kubernetes (MiniShift uses minikube) and Docker; so this is what <code>minishift start</code> will boot up in a VM. Read more about it <a href="https://docs.okd.io/latest/minishift/using/basic-usage.html">here</a>.</p>
</div>
<div class="paragraph">
<p>You can open the OpenShift web-console with <code>minishift console</code> and log in with user <code>developer</code> and any non-empty password. We can use it later to inspect the deployed applications and see the logs of the running containers; even connecting to a shell within the container can be done via the web console.</p>
</div>
<div class="paragraph">
<p>This is also a good place to introduce the concept of projects in OpenShift. Actually, there is also the concept of projects in Minishift, but with <code>minishift start</code> a default project named <code>minishift</code> is created and I usually get along with this single project quiet good.
For the OpenShift project this is different. You should use a single project for deploying all your modules/microservices that make up your application. So, if you are working on different customer-projects, it would be natural to also define different projects in OpenShift for it.</p>
</div>
<div class="paragraph">
<p>Here, I will be working with a project named <code>junk</code>. It is created and activated via</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc new-project junk</pre>
</div>
</div>
<div class="paragraph">
<p>This is important later on, because Docker images we build need to be tagged with the project-name for OpenShift beeing able to use them.</p>
</div>
<div class="paragraph">
<p>Also, note that once you stop and start MiniShift, the default OpenShift project might be active (check with <code>oc projects</code>) and you will have to run <code>oc project junk</code> to activate <code>junk</code>; otherwise it might happen that <code>oc</code> commands interacte with the wrong project.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_and_deploy_from_source_via_s2i_and_templates">Building and deploy from source via S2I and templates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The most prominent approach for deploying your application on OpenShift is via Source-2-Image.
What this means is that effectively your application is built from sources (Maven, Gradle, &#8230;&#8203;) within a Docker container. The resulting artifact (e.g. WAR-file) is then put in another Docker container (e.g. Wildfly) to start the application.</p>
</div>
<div class="paragraph">
<p>Additionally, there is the concept of templates. These templates and their parameters are documented in a good way so that you basically only have the point the template to a Git Repo URL containing a Maven build. The template will do the job of building and deploying the artifact.</p>
</div>
<div class="paragraph">
<p>Minishift does not come with templates for JBoss/Wildfly preinstalled. But you can easily add a JBoss EAP 7 template by running</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc replace --force -f https://raw.githubusercontent.com/jboss-openshift/application-templates/master/eap/eap71-basic-s2i.json</pre>
</div>
</div>
<div class="paragraph">
<p>You can inspect the template parameters with</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc describe template eap71-basic-s2i</pre>
</div>
</div>
<div class="paragraph">
<p>Lets launch a simple Maven-based JavaEE project via the JBoss EAP 7 template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc new-app --template=eap71-basic-s2i -p SOURCE_REPOSITORY_URL=https://github.com/AdamBien/microservices-on-openshift.git -p CONTEXT_DIR=micro -p SOURCE_REPOSITORY_REF=master --name=micro</pre>
</div>
</div>
<div class="paragraph">
<p>This approach works quiet nicely, but as you would normally build your application on a Jenkins or similar build-server, the approach seems not so useful for serious projects.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_via_image_streams">Deploy via Image Streams</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From now on we assume the JavaEE WAR/EAR was built via Gradle/Maven on Jenkins and we only want to use OpenShift to deploy it.
For this we can use the concept of Image Streams. Essentially, it is just another abstraction on top of Docker.
As tags like <code>latest</code> (or even specific versions) can be overwritten in a Docker registry, Image Streams give Docker images a handle that can be used today or tomorrow even when the version was overwritten.
To be concrete: You deploy your application on a docker image <code>appserver:latest</code>, the Image Stream in OpenShift will make sure to always take the same Docker image for deployment even when containers are built after <code>latest</code> already points to a new image. The handle will only be updated when you proactively decide so. This allows reproduceable build/deployments and removes the level of suprise when a new deployment is pushed to production on a Friday afternoon.</p>
</div>
<div class="paragraph">
<p>To demonstrate the steps, I will be using the demo repo from the course but please note that it could be any other Maven/Gradle-based project that produces a JavaEE WAR/EAR-file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/AdamBien/microservices-on-openshift.git
cd microservices-on-openshift/micro
mvn package</pre>
</div>
</div>
<div class="paragraph">
<p>This should have produced a <code>micro.war</code> under the <code>microservices-on-openshift/micro/target</code> folder.</p>
</div>
<div class="paragraph">
<p>Lets first check what Image Streams OpenShift knows about (you can also reference images from DockerHub or your local docker registry but more on that later):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc get is -n openshift</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s define an application using the <code>wildfly</code> image-stream.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc new-app wildfly:latest~/tmp --name=micro</pre>
</div>
</div>
<div class="paragraph">
<p>The trick used by Adam here is to give <code>/tmp</code> or some other empty folder to the command because we don&#8217;t want OpenShift to build our application. Normally, you would give the path to a Git Repo or a folder containing a <code>pom.xml</code>. In this case, OpenShift would do the build from source again.</p>
</div>
<div class="paragraph">
<p>Instead, we use the <code>oc start-build</code> command and give the already built artifact:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc start-build micro --from-file=target/micro.war</pre>
</div>
</div>
<div class="paragraph">
<p>To expose the application to the outside world via a load-balancer, run</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc expose svc micro</pre>
</div>
</div>
<div class="paragraph">
<p>In the web-console you should be able to go to your project and under it to <code>Applications/Routes</code>. Here you will find a link to access you applications HTTP port.
The URL to access the Rest endpoint should look similar to this: <a href="http://micro-junk.192.168.42.3.nip.io/micro/resources/ping" class="bare">http://micro-junk.192.168.42.3.nip.io/micro/resources/ping</a>.</p>
</div>
<div class="sect2">
<h3 id="_dns_issues">DNS issues</h3>
<div class="paragraph">
<p>A problem that bugged me for some time was the concept of the <code>nip.io</code> domain and that DNS servers should resolve it to the IP given as subdomain.
It would not have been a problem if my system was set up to use e.g. the Google DNS servers. Instead, on my Debian/local network, there is some local DNS server and it was not able to resolve the <code>nip.io</code> domain.</p>
</div>
<div class="paragraph">
<p>To make it work, I had to set up the Google DNS servers on my system. Namely, <a href="8.8.8.8" class="bare">8.8.8.8</a> and <a href="8.8.4.4" class="bare">8.8.4.4</a>. After this, I was able to call the Rest endpoint.</p>
</div>
<div class="sect3">
<h4 id="_local_dns">Local DNS</h4>
<div class="paragraph">
<p>For some time I also played around with a local DNS server coming as an experimental feature, but I moved away from it again because it was not really necessary.
Anyway, below are the steps if you want to try it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>export MINISHIFT_ENABLE_EXPERIMENTAL=y
minishift start
minishift dns start
patch /etc/resolv.conf</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_resources">Deleting resources</h3>
<div class="paragraph">
<p>As you are playing around in OpenShift, it is often useful to start from scratch again. Actually, we should do it to demonstrate a different approach to deploy our application.
All resources in OpenShift are labeled with the application-name (<code>oc get all -l app=micro</code>). So, in our case, we can delete our application and all its resources by running</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc delete all -l app=micro</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_image_stream_from_own_docker_image">Image Stream from own Docker image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I assume you have run the <code>oc delete</code> command because we now want to deploy our micro application again, but in a different way: deployed in a Docker container that we have built ourselfs.
I.e. we want to use our own Docker images within OpenShift&#8217;s concept of Image Streams.</p>
</div>
<div class="paragraph">
<p>First, we need to connect our Docker client to the Docker runtime in MiniShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>eval $(minishift docker-env)</pre>
</div>
</div>
<div class="paragraph">
<p>Try <code>docker ps</code> now and you should see all the Docker containers running in your OpenShift environment.</p>
</div>
<div class="paragraph">
<p>We can now do a <code>docker build</code> as usual; we just have to make sure to tag it correctly.
As OpenShift exposes a Docker registry, we need to tag the image for this registry (we can get it from <code>minishift openshift registry</code>); and additionally, there is the convention that the image-name need to include the name of the OpenShift project and the application-name. So, the full build-command looks liḱe this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker build -t $(minishift openshift registry)/junk/micro .
docker login -u developer -p $(oc whoami -t) $(minishift openshift registry)
docker push $(minishift openshift registry)/junk/micro
oc new-app --image-stream=micro
oc expose svc micro
oc status</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_important_concepts">Important concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below are some more important concepts for deploying applications to the cloud and the respective commands.</p>
</div>
<div class="sect2">
<h3 id="_scale">Scale</h3>
<div class="paragraph">
<p>You can scale the number of replicas/containers with below command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc scale --replicas=2 dc ping
oc get all</pre>
</div>
</div>
<div class="paragraph">
<p>As OpenShift exposes your service via a load-balancer, this is completely transparent and you might be routed to any of the started containers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration">Configuration</h3>
<div class="paragraph">
<p>In Java you can access environment variables via <code>System.getenv</code>.
This is a standard mechanism to configure you application in cloud-native applications.
Below is the command to set such an environment variable for your service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc set env dc/ping --list
oc set env dc/ping message='Hello World'</pre>
</div>
</div>
<div class="paragraph">
<p>What will happen, is that OpenShift restarts all containers and places the new config in the environment.</p>
</div>
<div class="paragraph">
<p>You application will now get <code>Hello World</code> when invoking <code>System.getenv("message")</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_health_check">Health check</h3>
<div class="paragraph">
<p>Every application should define some external health-check endpoint.
This allows external tools or e.g. OpenShift to monitor the state of the application.
For this, Kubernetes defines two different health-checks.
Readyness probes to test if the application is ready/started; and liveness probes to test if the application is still alive and responding.
Below are the commands to set each. You Rest-service simply needs to respond with HTTP responce-code 200 is everything is fine; 500 in case to indicate the opposite.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc set probe dc/ping --liveness --get-url=http://:8080/ping/resources/health
oc set probe dc/ping --readiness --get-url=http://:8080/ping/resources/health</pre>
</div>
</div>
</div>
</div>
</div></p>
  	
		<a href="blog/2019/useful-wildfly-undertow-config.html"><h1>Useful Wildfly Undertow Config</h1></a>
		<p class="postingdate"><em>21 May 2019</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Below you find two useful Wildfly configurations.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_server_side_ssl">Configure server-side SSL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Copy your Java Keystore to $JBOSS_HOME/standalone/configuration/server.jks and modify your standalone-full.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;tls&gt;
    &lt;key-stores&gt;
        &lt;key-store name="LocalhostKeyStore"&gt;
            &lt;credential-reference clear-text="secret"/&gt;
            &lt;implementation type="JKS"/&gt;
            &lt;file path="server.jks" relative-to="jboss.server.config.dir"/&gt;
        &lt;/key-store&gt;
    &lt;/key-stores&gt;
    &lt;key-managers&gt;
        &lt;key-manager name="LocalhostKeyManager" key-store="LocalhostKeyStore" alias-filter="servercert"&gt;
            &lt;credential-reference clear-text="secret"/&gt;
        &lt;/key-manager&gt;
    &lt;/key-managers&gt;
    &lt;server-ssl-contexts&gt;
        &lt;server-ssl-context name="LocalhostSslContext" key-manager="LocalhostKeyManager"/&gt;
    &lt;/server-ssl-contexts&gt;
&lt;/tls&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:undertow:4.0"&gt;
    &lt;buffer-cache name="default"/&gt;
    &lt;server name="default-server"&gt;
        &lt;.../&gt;
        &lt;https-listener name="https" socket-binding="https" ssl-context="LocalhostSslContext" enable-http2="true"/&gt;
        &lt;.../&gt;
    &lt;/server&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_undertow_as_a_reverse_proxy">Use undertow as a reverse proxy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When accessing the Wildfly on <a href="http://localhost:8080/my-app" class="bare">http://localhost:8080/my-app</a>, forward to 192.168.1.2 at port 8888.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:undertow:4.0"&gt;
    &lt;server name="default-server"&gt;
        &lt;host name="default-host" alias="localhost"&gt;
             &lt;.../&gt;
            &lt;location name="/my-app" handler="my-app-proxy"/&gt;
        &lt;/host&gt;
    &lt;/server&gt;
    &lt;.../&gt;
    &lt;handlers&gt;
        &lt;.../&gt;
        &lt;reverse-proxy name="my-app-proxy"&gt;
            &lt;host name="localhost" outbound-socket-binding="my-app-binding" scheme="http" path="/my-app" instance-id="my-app-route"/&gt;
        &lt;/reverse-proxy&gt;
    &lt;/handlers&gt;
    &lt;.../&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;socket-binding-group name="standard-sockets" default-interface="public" port-offset="${jboss.socket.binding.port-offset:0}"&gt;
    &lt;.../&gt;
    &lt;outbound-socket-binding name="my-app-binding"&gt;
        &lt;remote-destination host="192.168.1.2" port="8888" /&gt;
    &lt;/outbound-socket-binding&gt;
    &lt;.../&gt;</code></pre>
</div>
</div>
</div>
</div></p>
  	
		<a href="blog/2019/emojis-for-java-commandline.html"><h1>How to print Emoji characters in your Java command-line application</h1></a>
		<p class="postingdate"><em>31 March 2019</em></p>

		<p><div class="paragraph">
<p>In general, you only have colors and font-weight to work with when you are in a regular terminal application. Using emoji chracters allows to use different visual markers than what we are noramlly used to.</p>
</div>
<div class="paragraph">
<p>See below for how it works in Java:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to <a href="https://unicode.org/emoji/charts/full-emoji-list.html">this index</a> and find emoji to use. E.g. "Grinning Face" has UTF-16 code <code>U+1F600</code>.</p>
</li>
<li>
<p>Go to <a href="http://www.fileformat.info/info/unicode/char/search.htm">fileformat.info</a> and query for <code>U+1F600</code>.</p>
</li>
<li>
<p>Click on the returned result and find the row "C/C++/Java source code"; which should show <code>"\uD83D\uDE00"</code>.</p>
</li>
<li>
<p>Put <code>System.out.println("\uD83D\uDE00")</code> into your Java application.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you run this application in a terminal and the font supports it, you should see the grinning face &#x1f600;.</p>
</div></p>
  	
		<a href="blog/2019/es6-bare-imports.html"><h1>How to handle ES6 bare module imports for local Development</h1></a>
		<p class="postingdate"><em>26 March 2019</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This post has been updated to also include <a href="https://www.pikapkg.com/blog/pika-web-a-future-without-webpack/">Pika</a>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Yet another interesting tool is <a href="https://jspm.org/about/introduction">jspm</a>. Thanks to @hallettj for mentioning it to me.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When prototyping a Javascript-based web-application, I prefer a lightweight approach in which I just have VSCode, the latest Chrome version and <a href="https://www.browsersync.io/">browser-sync</a>. No transpiler, bundler, etc. The browser is refreshed each time I save a file and I get immediate feedback on any CSS, HTML or JavaScript changes I have made.</p>
</div>
<div class="paragraph">
<p>Unfortunately, just using browser-sync does not work as soon as you want to import ES6 modules from third-party. Like, for example, <a href="https://lit-element.polymer-project.org/guide">lit-element</a>.</p>
</div>
<div class="paragraph">
<p>I will show in what cases ES6 imports are not working natively in the browser for external dependencies and show different mechanism to work around it for your development environment.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_problem">Problem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An ES6 import will cause problems as soon as you have bare imports. A bare import is one that you usually see when working with bundlers like Webpack: it is not a relative path to your <code>node_modules</code> but&#8230;&#8203; bare.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">import { html, LitElement } from 'lit-element/lit-element.js';</code></pre>
</div>
</div>
<div class="paragraph">
<p>And when bundling the application with e.g. Webpack, this would be working fine. But if directly run in the browser, you would see:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://i.imgur.com/2EJ5gzy.png" alt="2EJ5gzy">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>Uncaught TypeError: Failed to resolve module specifier "lit-element/lit-element.js". Relative references must start with either "/", "./", or "../".</pre>
</div>
</div>
<div class="paragraph">
<p>NodeJS supports bare imports and its resolution but browsers do not support it as of now.</p>
</div>
<div class="paragraph">
<p>Now I can try to be smart and change it to a relative import</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">import { html, LitElement } from './lit-element/lit-element.js';</code></pre>
</div>
</div>
<div class="paragraph">
<p>and make browser-sync serve files from the <code>node_modules</code> directory as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>browser-sync src node_modules -f src --cors --no-notify</pre>
</div>
</div>
<div class="paragraph">
<p>I will get a different but similar error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Uncaught TypeError: Failed to resolve module specifier "lit-html". Relative references must start with either "/", "./", or "../".</pre>
</div>
</div>
<div class="paragraph">
<p>Even though I was no able to import <code>lit-element</code>, it is now choking on <code>lit-html</code> which is a bare import in the <code>lit-element</code> sources itself.
So, it seems we are stuck as any external library that contains ES6 imports will fail if the imports are not first rewritten like Webpack will do.</p>
</div>
<div class="paragraph">
<p>Got here and search for <a href="https://jakearchibald.com/2017/es-modules-in-browsers/">"Bare" import specifiers aren&#8217;t currently supported</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solutions">Solutions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here are the solutions I have found when my main requirement is to keep a good developer experience like I have with browser-sync alone (lean and simple).</p>
</div>
<div class="sect2">
<h3 id="_unpkg_com">Unpkg.com</h3>
<div class="paragraph">
<p>Unpkg acts like a CDN and offers popular NPM packages via http. The nice thing is that bare imports are rewritten.
So, changing the import to this will work fine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">import { html, LitElement } from 'https://unpkg.com/@polymer/lit-element@latest/lit-element.js?module';</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>?module</code> does the magic of rewriting bare imports.</p>
</div>
<div class="paragraph">
<p>I can now continue working with browser-sync like before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>browser-sync src -f src --cors --no-notify</pre>
</div>
</div>
<div class="paragraph">
<p>The downside of this approach is that the application is not local/self-contained; I have to fetch something from the internet; which can be bad if your internet speed is slow. Actually, it will be cached; but it will hit the internet anyway for cache-validation.
Also, this will not work if you are trying to work offline.</p>
</div>
</div>
<div class="sect2">
<h3 id="_webpack">Webpack</h3>
<div class="paragraph">
<p>As mentioned before, a bundler sloves the import problem for us by inlining or rewriting the imports.
But I am no fan of this approach as this bundling step can slow down the turn-around time from saving the file to the browser actually reloading.
Anyway, the steps are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>`npm install --save-dev webpack webpack-cli copy-webpack-plugin webpack-dev-server `</p>
</li>
<li>
<p>Create <code>webpack.config.js</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">const path = require('path');
const CopyPlugin = require('copy-webpack-plugin');

module.exports = {
    entry: './src/app.js',
    mode: 'development',
    output: {
        path: path.resolve(__dirname, 'dist'),
        filename: 'app.js'
    },
    devServer: {
        contentBase: './dist'
    },
    plugins: [
        new CopyPlugin([
            { from: 'src/index.html', to: './' },
            { from: 'src/style.css', to: './' },
        ]),
    ],
};</code></pre>
</div>
</div>
</li>
<li>
<p>Add a script to the <code>package.json</code>: <code>"dev": "webpack-dev-server --open"</code></p>
</li>
<li>
<p>The import can now look like this:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">import { html, LitElement } from 'lit-element/lit-element.js';</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Run the dev-server with live-reload (similar to browser-sync) with <code>npm run dev</code>.</p>
</div>
<div class="paragraph">
<p>After trying it for a small application and really only doing the bare minimum with Webpack, I have to say it is a viable option.
But it requires to download some dependencies from NPM and create a <code>webpack.config.js</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_open_web_components_owc">Open Web Components (OWC)</h3>
<div class="paragraph">
<p><a href="https://open-wc.org/developing/owc-dev-server.html">Open Web Components</a> offer a simple dev-server that does nothing more than rewrite the bar module imports to relative imports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>npm install --save-dev owc-dev-server</pre>
</div>
</div>
<div class="paragraph">
<p>After trying it out, I was disappointed to find that the dev-server does not offer live-reloading.</p>
</div>
<div class="paragraph">
<p>The best solution I found was to combine it with browser-sync.
Here are the scripts I added to my <code>package.json</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>"dev": "owc-dev-server | npm run watch",
"watch": "browser-sync start -f src/ --proxy localhost:8080 --startPath src",</pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>watch</code> is just a helper-script used by <code>dev</code>; so you have to use <code>npm run dev</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_polymer_cli">Polymer-cli</h3>
<div class="paragraph">
<p>The last tool I tried was Polymer-CLI.
In the end, the approach is a mix between the previous two. It requires an additional <code>polymer.json</code> config-file and it also does not function without browser-sync.</p>
</div>
<div class="paragraph">
<p>The steps are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>npm install --save-dev polymer-cli</code></p>
</li>
<li>
<p>Create <code>polymer.json</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">{
    "entrypoint": "src/index.html",
    "shell": "src/app.js",
    "npm": true
}</code></pre>
</div>
</div>
</li>
<li>
<p>Set up scripts:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">"watch": "browser-sync start -f src/ --proxy localhost:8000 --startPath src",
"dev": "polymer serve --open-path src/index.html | npm run watch"</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>See here for the <a href="https://github.com/Polymer/tools/issues/2134">issue</a> to natively support live-reload.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pika">Pika</h3>
<div class="paragraph">
<p>One more nice tool was mentioned to me in the reactions to this post. So, I felt inclined to try it and after all also include it here.</p>
</div>
<div class="paragraph">
<p>What <code>@pika/web</code> does, is described nicely in <a href="https://www.pikapkg.com/blog/pika-web-a-future-without-webpack/">this article</a>. It actually is a great addition to my post because it adds to the same discussion that you should not be required to use bundlers just to get all the webcomponents / ES6 goodness working.</p>
</div>
<div class="paragraph">
<p>Pika moves the bundling step from where you have to run the bundler for your application, to just running a bundler/tool once for each installed dependency in your <code>package.json</code>.
I.e. what it does is take your dependencies from <code>node_modules</code> and repackages/bundles them under the folder <code>web_modules</code>. The repackaged dependency no longer contains bare imports and can easily be include. Just run</p>
</div>
<div class="listingblock">
<div class="content">
<pre>npm install &amp;&amp; npx @pika/web</pre>
</div>
</div>
<div class="paragraph">
<p>Now, you could import like below and continue using browser-sync.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>import { html, LitElement } from './web_modules/lit-element.js';</pre>
</div>
</div>
<div class="paragraph">
<p>Note that I don&#8217;t like having to put <code>web_modules</code> in the path. So what I ended up doing was importing like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre>import { html, LitElement } from './lit-element.js';</pre>
</div>
</div>
<div class="paragraph">
<p>and just let browser-sync serve from <code>src</code> and <code>web_modules</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>browser-sync src web_modules -f src --cors --no-notify</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After trying out all these options, I have to say that non is as lightweight and simple as using plain browser-sync.</p>
</div>
<div class="paragraph">
<p>I can work with the Webpack and the OCW approaches. Webpack is a standard tool to learn anyway. And OCW has a lightweight dev-serverthat just rewrites the imports on the fly; no bundling step. But sadly, it does not come with live-reload out of the box and requries to combine it with browser-sync. Polymer-CLI is just to heavyweight for what I need from it (also requiring a config-file) and unpkg.com is no option as I want to be able to work offline.</p>
</div>
<div class="paragraph">
<p>Pika was only added after I intially wrote this post. But I will keep trying it in the next way. From the first impression, I have to say that I really like that I can just continue using plain browser-sync.</p>
</div>
<div class="paragraph">
<p>As the dependency on other libraries via ES6 imports will only get more important, I am eagerly awaiting a solution. Maybe <a href="https://github.com/WICG/import-maps">import-maps</a> will the way to go.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2019/jsf-myfaces-viewstate.html"><h1>Debugging a JSF/MyFaces error on Websphere</h1></a>
		<p class="postingdate"><em>11 March 2019</em></p>

		<p><div class="paragraph">
<p>This is a summary of the steps necessary to debug one kind of nasty bug in JSF.</p>
</div>
<div class="paragraph">
<p>Today I was debugging a JSF issue on Websphere where the backing-bean was not called for an Ajax form submit.
Actually, the command-button action was called but the model values for the form inputs where not set.
On JBoss all was fine and also under Webphere there was no error written to any log or such.
The partial response just returned the old model values.</p>
</div>
<div class="paragraph">
<p>A colleague recommended to play around with partial-state-saving and so I did.
I first captured the viewId to only disable partial-state-saving for my page.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">System.out.println("ViewID is " + FacesContext.getCurrentInstance().getViewRoot().getViewId());</code></pre>
</div>
</div>
<div class="paragraph">
<p>And set it like this in the <code>web.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;context-param&gt;
    &lt;param-name&gt;javax.faces.FULL_STATE_SAVING_VIEW_IDS&lt;/param-name&gt;
    &lt;param-value&gt;/myviewid.xhtml&lt;/param-value&gt;
&lt;/context-param&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This setting at at least made a NPE appear in the partial-response. But without a full stacktrace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;partial-response&gt;&lt;error&gt;&lt;error-name&gt;java.lang.NullPointerException&lt;error-name&gt;...&lt;/error&gt;&lt;/partial-response&gt;&lt;error</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step was to install <a href="http://showcase.omnifaces.org/exceptionhandlers/FullAjaxExceptionHandler">OmniFaces' FullAjaxExceptionHandler</a>.</p>
</div>
<div class="listingblock">
<div class="title">web.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml"> &lt;error-page&gt;
    &lt;error-code&gt;500&lt;/error-code&gt;
    &lt;location&gt;/WEB-INF/errorpages/500.xhtml&lt;/location&gt;
 &lt;/error-page&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">faces-config.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;factory&gt;
    &lt;exception-handler-factory&gt;org.omnifaces.exceptionhandler.FullAjaxExceptionHandlerFactory&lt;/exception-handler-factory&gt;
&lt;/factory&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">500.xhtml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions"
    xmlns:of="http://omnifaces.org/functions"&gt;
    &lt;!--    xmlns:p="http://primefaces.org/ui" --&gt;

&lt;h:head&gt;
	&lt;title&gt;error&lt;/title&gt;
&lt;/h:head&gt;
&lt;h:body&gt;
	&lt;ul&gt;
    &lt;li&gt;Date/time: #{of:formatDate(now, 'yyyy-MM-dd HH:mm:ss')}&lt;/li&gt;
    &lt;li&gt;User agent: #{header['user-agent']}&lt;/li&gt;
    &lt;li&gt;User IP: #{request.remoteAddr}&lt;/li&gt;
    &lt;li&gt;Request URI: #{requestScope['javax.servlet.error.request_uri']}&lt;/li&gt;
    &lt;li&gt;Ajax request: #{facesContext.partialViewContext.ajaxRequest ? 'Yes' : 'No'}&lt;/li&gt;
    &lt;li&gt;Status code: #{requestScope['javax.servlet.error.status_code']}&lt;/li&gt;
    &lt;li&gt;Exception type: #{requestScope['javax.servlet.error.exception_type']}&lt;/li&gt;
    &lt;li&gt;Exception message: #{requestScope['javax.servlet.error.message']}&lt;/li&gt;
    &lt;li&gt;Exception UUID: #{requestScope['org.omnifaces.exception_uuid']}&lt;/li&gt;
    &lt;li&gt;Stack trace:
        &lt;pre&gt;#{of:printStackTrace(requestScope['javax.servlet.error.exception'])}&lt;/pre&gt;
    &lt;/li&gt;
&lt;/ul&gt;
&lt;/h:body&gt;

&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the full stacktrace of the NPE became visible. It was a null-value item in a <code>p:selectCheckboxMenu</code> (of PrimeFaces) that just made MyFaces not work properly under Websphere.</p>
</div></p>
  	
		<a href="blog/2019/sublime-lsp.html"><h1>Sublime Text 3 for Java</h1></a>
		<p class="postingdate"><em>03 March 2019</em></p>

		<p><div class="paragraph">
<p>Lately, I have been suprised by the great support for Java in VSCode.
It is based on the Language Server Protocol standard. This means, an editor only has to implement the interface to this standard. It can then provide support for intellisense, errors and more for any kind of languages if a language-server for this language comes available. There is no need for baking language-support into each editor. It is provided by the language-server backend. E.g. <a href="https://github.com/eclipse/eclipse.jdt.ls">Eclipse JDT</a> provides a language-server for Java.</p>
</div>
<div class="paragraph">
<p>The integration of Java in VSCode is great and simple to use. Just follow the steps <a href="https://code.visualstudio.com/docs/languages/java">here</a>.</p>
</div>
<div class="paragraph">
<p>Just for my understanding, I was interested if I can get it working for Sublime Text 3.
It requires some manual steps and not many people will choose this combination; but it is possible.</p>
</div>
<div class="paragraph">
<p>First you have to get the Java Language Server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/eclipse/eclipse.jdt.ls
cd eclipse.jdt.ls
./mvnw package</pre>
</div>
</div>
<div class="paragraph">
<p>The built Jar can be found at <code>eclipse.jdt.ls/org.eclipse.jdt.ls.product/target/repository/plugins/org.eclipse.equinox.launcher_1.5.300.v20190213-1655.jar</code>.</p>
</div>
<div class="paragraph">
<p>Next, install the <a href="https://packagecontrol.io/packages/LSP">LSP package</a> for Sublime Text.</p>
</div>
<div class="paragraph">
<p>Go to <code>Preferences: LSP Settings</code> and add below config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="json">{
	"clients":
	{
		"jdtls":
		{
			"enabled": true,
            "command": ["java", "-jar", "/home/daniel/junk/eclipse.jdt.ls/org.eclipse.jdt.ls.product/target/repository/plugins/org.eclipse.equinox.launcher_1.5.300.v20190213-1655.jar", "-configuration", "/home/daniel/junk/eclipse.jdt.ls/org.eclipse.jdt.ls.product/target/repository/config_linux"],
            "scopes": ["source.java"],
            "syntaxes": ["Packages/Java/Java.sublime-syntax"],
            "languageId": "java"
		}
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that I have put in absolute paths and you will have to replace it with yours. You not only need to set the Jar-file but also the path to a config-folder based on your platform.</p>
</div>
<div class="paragraph">
<p>After this, you are ready to run <code>LSP: Enable Language Server Globally</code> and open a Maven- or Gradle-based project in Sublime. You should see syntax highlighting and intellisense for your .java-files.</p>
</div>
<div class="paragraph">
<p>Note though that the usability is nothing like Eclipse or Netbeans. Not even close to VSCode. It shows that this is not a editor people use for Java development.
Anyway, it was a nice experiment to better understand the integration between a language-client and a language-server.</p>
</div></p>
  	
		<a href="blog/2019/gradle-arquillian-webdriver.html"><h1>Arquillian UI Testing from Gradle</h1></a>
		<p class="postingdate"><em>01 March 2019</em></p>

		<p><div class="paragraph">
<p>This is an updated version of <a href="http://dplatz.de/blog/2018/gradle-arquillian-webdriver.html">last year&#8217;s post</a>.
The main change is that Gradle now has native BOM-support.</p>
</div>
<div class="paragraph">
<p>Lets for this post assume we want to test some Web UI that is already running somehow. I.e. we don&#8217;t want to start up the container with the web-app from arquillian.
So, make sure you have the following in your <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">apply plugin: 'java'

sourceCompatibility = 1.8
targetCompatibility = 1.8

repositories {
    jcenter()
}

dependencies {
    testCompile 'junit:junit:4.12'

    implementation platform('org.jboss.arquillian:arquillian-bom:1.4.1.Final')
    testCompile "org.jboss.arquillian.junit:arquillian-junit-container"
    testCompile "org.jboss.arquillian.graphene:graphene-webdriver:2.3.2"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RunAsClient
@RunWith(Arquillian.class)
public class HackerNewsIT {

    @Drone
    WebDriver browser;

    @Test
    public void name() {
        browser.get("https://news.ycombinator.com/");
        String title = browser.getTitle();
        Assert.assertThat(title, CoreMatchers.is("Hacker News"));
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run with it with <code>gradle test</code>.</p>
</div>
<div class="paragraph">
<p>By default, HTMLUnit will be used as the browser. To use Chrome, you can set it in the <code>arquillian.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml"> &lt;arquillian xmlns="http://jboss.com/arquillian" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://jboss.org/schema/arquillian http://jboss.org/schema/arquillian/arquillian_1_0.xsd"&gt;

    &lt;extension qualifier="webdriver"&gt;
        &lt;property name="browser"&gt;chrome&lt;/property&gt;
        &lt;!--property name="chromeDriverBinary"&gt;/home/daniel/dev/tools/chromedriver&lt;/property--&gt;
    &lt;/extension&gt;

&lt;/arquillian&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You don&#8217;t need to download the chromedriver manually anymore; but you can: <a href="https://sites.google.com/a/chromium.org/chromedriver/WebDriver" class="bare">https://sites.google.com/a/chromium.org/chromedriver/WebDriver</a>.</p>
</div></p>
  	
		<a href="blog/2019/watch-and-do-script.html"><h1>"Watch and Run" shell script</h1></a>
		<p class="postingdate"><em>17 February 2019</em></p>

		<p><div class="paragraph">
<p>I am using Python a lot lately for machine learning.
To experiment a lot and quickly, I am using a simple shell-script that automatically runs my Python script whenever I change it.
This is not only useful for Python but for any task that should be triggered based on a changed file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="bash">war() {
    war_do() {
        clear;
        the_time=$(date +%H:%M:%S)
        start=$(date +%s.%N)
        # Run the command that was provided as argument
        eval $@;
        rc=$?
        end=$(date +%s.%N)
        diff=$(echo "${end} - ${start}" | bc)
        if [ $rc -eq 0 ]; then
            echo ""
            echo -e "\e[2m[${the_time}]\e[0m \e[1;32m** Successful **\e[0m \e[2m(time: ${diff} seconds)\e[0m"
        else
            echo ""
            echo -e "\e[2m[${the_time}]\e[0m \e[1;31m** Failed **\e[0m"
        fi
        sleep 1;
    }
    war_do $@
    while inotifywait -qq .; do
        war_do $@
    done
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You have to make sure that <code>inotifywait</code> is available on your system.
Assume you source the script in your .bashrc, you can now run below command to contiously run your Python script on each saved change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>war python app.py</pre>
</div>
</div>
<div class="paragraph">
<p>Or your NodeJS script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>war node app.js</pre>
</div>
</div></p>
  	
		<a href="blog/2018/gradle-arquillian-chameleon-contribution.html"><h1>Arquillian Chameleon with new @GradleBuild-annotation</h1></a>
		<p class="postingdate"><em>23 December 2018</em></p>

		<p><div class="paragraph">
<p>In <a href="/blog/2018/gradle-arquillian-chameleon-improved.html">this post</a> and <a href="/blog/2018/gradle-arquillian-chameleon-improved-again.html">this post</a> I have described how Chameleon can considerably simplify the usage of Arquillian.
What still was missing is the option for Arquillian to build the artifact/WAR with Gradle itself and use it for the test/deployment.
Some time ago I gave it a shot to implement the <code>@GradleBuild</code>-annotation similar to the existing <code>@MavenBuild</code>-annotation.
It took some time until my commit made it into an official release-candidate; but here are the steps how you can make use of it.</p>
</div>
<div class="paragraph">
<p>Here, I am only listing the updated dependencies for Chameleon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">dependencies {
    testCompile 'org.arquillian.container:arquillian-chameleon-junit-container-starter:1.0.0.CR4'
    testCompile 'org.arquillian.container:arquillian-chameleon-gradle-build-deployment:1.0.0.CR4'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can make use of <code>@GradleBuild</code>. It will trigger the Gradle-build via the Tooling-API and use the artifact under <code>build/libs</code> as deployment for the test.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RunWith(ArquillianChameleon.class)
@GradleBuild
@ChameleonTarget(value = "wildfly:11.0.0.Final:managed")
public class HelloServiceIT {

    @Inject
    private HelloService service;

    @Test
    public void shouldGreetTheWorld() throws Exception {
        Assert.assertEquals("hello", service.hello());
    }
}</code></pre>
</div>
</div></p>
  	
		<a href="blog/2018/java-hot-code-swapping.html"><h1>Java Code Hot Swapping</h1></a>
		<p class="postingdate"><em>21 December 2018</em></p>

		<p><div class="paragraph">
<p>I am constantly suprised that developers who are working with Java for years are not aware of the hot-swapping-code feature of the JVM.
In a nutshell, when you run a Java application from within e.g. Eclipse in debug-mode (or connect to a "Remote Java Application") you are able to change the content of your methods during runtime of the application.
You are not able to add/remove/change fields or method signatures, but you can change the content of methods.
To me, this is a big deal and allows much fast development because enterprise applications can grow big over the years and have deployment-times of minutes instead of seconds.
Not having to redeploy for each minor change is a huge time-saver.</p>
</div>
<div class="paragraph">
<p>Unfortunately, depending on your workflow hot-code-swapping will not always work. And you might get errors like "Hot Code Replace Failed - delete method not implemented" even when you just change the content of your methods. How can this be?</p>
</div>
<div class="paragraph">
<p>The problem usually is related to the usage of two different Java compilers in your workflow.
Say, you are building and deploying your WAR-archive with Maven or Gradle from the commandline and then deploy it to your application-server (e.g. Wildfly).
Now, you connect to the application from within Eclipsse via "Remote Debugging" and change your code.
Most likely, on the commandline you are using an Oracle or OpenJDK for compilation whereas Eclipse is using it&#8217;s own <a href="http://blog.deepakazad.com/2010/05/ecj-eclipse-java-compiler.html">Eclipse Compiler for Java</a> which can generate slightly different bytecode.
In reality, problems often happen when your classes use lamdba expressions or anonymous inner classes. The name of the lambda methods or references to the inner classes can be different between the two compilers and during hot-swapping it will look to the debugger as fields or methods have been removed/added.</p>
</div>
<div class="paragraph">
<p>The solution is two make sure you use the same compiler for the initial compliation and the debugger session. When working with Eclipse and Gradle, this means either</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Build and deploy your application from within Eclipse via the <a href="https://tools.jboss.org/documentation/howto/servers_deploytolocalserver.html">Server Adapters</a>; this way all is compiled via ECJ.</p>
</li>
<li>
<p>Or use <a href="https://plugins.gradle.org/plugin/de.set.ecj">gradle-eclipse-compiler-plugin</a> to use ECJ also for builds from the commandline.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The described approach makes sure that only ECJ is used. I have not found a way yet to do it the other way round; i.e. use javac from within Eclipse.</p>
</div></p>
  	
		<a href="blog/2018/heroku.html"><h1>Deploying Java EE 8 Applications to Heroku</h1></a>
		<p class="postingdate"><em>01 November 2018</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I am currently developing a simple web-app that is most-likely only used by myself and maybe some friends.
It is using Java EE 8 and also has a HTML/JavaScript UI that gives me the possibility to tinker with some modern browser-APIs like WebComponents, Shadow-DOM, etc.</p>
</div>
<div class="paragraph">
<p>As I like to leverage such hobby-projects to also try and learn new stuff, I was looking for a simple (and cheap) way to host this application in the cloud.
Obviously, AWS, Azure, Google Cloud would be options if my focus would be on learning something new with these cloud platforms.
But this time I wanted to focus on the actual application and thus use something slightly more developer-friendly.
In this post I will show how to deploy a Java EE 8 application on <a href="https://dashboard.heroku.com/">Heroku</a> using TomEE and OpenLiberty.</p>
</div>
<div class="paragraph">
<p>As there are not many references on the internet that describe how to deploy Java EE applications on Heroku (specifically not an application-server-based deployment), I think this write-up might also be helpful to others.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_procfile_and_fat_jar_solutions">Procfile and Fat Jar Solutions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From past experience I know that Heroku makes it simple to deploy to the cloud. It integrates nicely with Git and deploying can be as simple as typing <code>git push heroku master</code>. Literally.
Basically, you define a <code>Procfile</code> that tells heroku how to build and deploy the application. If I would want to use a fat-jar solution like PayaraMicro, Thorntail or just repackaging as a fat-jar, this would work easily. Heroku will detect popular build-systems like Maven and Gradle, build the application and the <code>Procfile</code> just needs to contain the command-line to run the Jar. See <a href="https://devcenter.heroku.com/articles/deploying-java">here</a> for the steps.</p>
</div>
<div class="paragraph">
<p>This is not an option for me as I want to do the main development on a regular application-server; deploying to production with a different model then what is used in development does not sound like a great idea. Why do the main development on a regular application-server? Because the build is much fast than when it needs to download and package a 50 MB Jar-file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_docker_container_registry">Docker Container Registry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As Docker playes nicely with Java EE application-servers, the next logical step is to ask if you can somehow host a Docker container on Heroku.
And you can. They have a Docker conatainer registry where you can easily push images. Read the <a href="https://devcenter.heroku.com/articles/container-registry-and-runtime">steps</a> here.
The "downside" for me is that it does not have such a nice workflow as you are accustomed to from Heroku. Instead of doing <code>git push heroku master</code>, you now have to build locally or on some other build-server and then you basically do a <code>docker push</code>. This can easily lead to situations where you just start fiddling around and at one point and end with a deployed container that does not respresent a specific commit. I am not saying that this has to be a big problem for a hobby-project but why not aim for a better solution?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_docker_based_build_and_deploy_via_heroku_yml">Docker-based Build and Deploy via heroku.yml</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://devcenter.heroku.com/articles/docker-builds-heroku-yml">service</a> I finally opted for is still in public beta but promises to combine the easy workflow of <code>git push heroku master</code> with Docker.
The idea is to use Docker for building and deploying your application. A <code>heroku.yml</code> is used to define what images to build and what containers run.
The <code>heroku.yml</code> can look as simple as this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yml">build:
  docker:
    web: Dockerfile</code></pre>
</div>
</div>
<div class="paragraph">
<p>INFO: Note that you can find the whole project on <a href="https://github.com/38leinaD/heroku-javaee-starter">my GitHub repository</a>.</p>
</div>
<div class="paragraph">
<p>This just means that during the build-stage an image named <code>web</code> will be built based on the <code>Dockerfile</code> in the root of the project. What command will be used to run it? By default, whatever is defined via <code>EXEC</code> in the <code>Dockerfile</code>.</p>
</div>
<div class="paragraph">
<p>How to set up the <code>Dockerfile</code>? As it is needed to build our application (via Gradle or Maven) <strong>and</strong> also deploy it, <a href="https://docs.docker.com/develop/develop-images/multistage-build/">multi-stage builds</a> are the answer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FROM openjdk:8-jdk-alpine as build
COPY . /usr/src/app
WORKDIR /usr/src/app
RUN ./gradlew build

FROM tomee:8-jre-8.0.0-M1-plume
COPY src/main/tomee/run_tomee.sh /usr/local/
COPY src/main/tomee/config/server.xml /usr/local/tomee/conf/
COPY --from=0 /usr/src/app/build/libs/heroku-javaee-starter.war /usr/local/tomee/webapps/
CMD /usr/local/run_tomee.sh</pre>
</div>
</div>
<div class="paragraph">
<p>In the first stage we use a plain OpenJDK-image to build our WAR-file with Gradle.
The second stage is based on an official TomEE base-image and additionally contains the WAR-file built in the first stage.
Note that we also package a dedicated shell-script to start TomEE; and the <code>server.xml</code> is mainly included to read the HTTP-port from an environment-variable.</p>
</div>
<div class="paragraph">
<p>Heroku works in the following way: When the container is started, an environment-variable named <code>PORT</code> is defined. It is the responsibility of the application to use this port.
For TomEE, I was only able to do this by taking the environment-variable in the Shell and then setting it as a Java system-property which is read in the <code>server.xml</code>. In contrast to this, OpenLiberty directly allows to access environment-variables in its configuration-file (which is coincidentally also called <code>server.xml</code>).</p>
</div>
<div class="paragraph">
<p>I will assume that you have a general understanding how to build a Java EE WAR-file with Gradle or Maven; there is nothing special here.</p>
</div>
<div class="sect2">
<h3 id="_deploy_to_tomee_on_heroku">Deploy to TomEE on Heroku</h3>
<div class="paragraph">
<p>Now lets see how we can get this deployed to Heroku.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create an account for Heroku, download/install the <a href="https://devcenter.heroku.com/articles/heroku-cli">Heroku CLI</a> and run <code>heroku login</code>.</p>
</li>
<li>
<p>Get the <a href="https://github.com/38leinaD/heroku-javaee-starter">Heroku Java EE Starter Project</a> from my GitHub Repo.</p>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/38leinaD/heroku-javaee-starter.git
cd heroku-javaee-starter</pre>
</div>
</div>
</li>
<li>
<p>Create an application at Heroku and set the Stack so we can work with Docker and the <code>heroku.yml</code>.</p>
<div class="listingblock">
<div class="content">
<pre>heroku create
heroku stack:set container</pre>
</div>
</div>
</li>
<li>
<p>And now the only step that you will need to repeat later during development; and it is the reason why it is so nice to work with Heroku in the first place:</p>
<div class="listingblock">
<div class="content">
<pre>git push heroku master</pre>
</div>
</div>
<div class="paragraph">
<p>This will push your code to Heroku and trigger the build and deployment of the application.</p>
</div>
</li>
<li>
<p>You might remember from earlier that we gave the container the name <code>web</code> in the <code>heroku.yml</code>. By convention the container with this name is automatically scaled to one instance. If you would name the container differently (let`s assume <code>myapp</code>), you need to run <code>heroku ps:scale myapp=1</code> manually. Anyway, you can check with <code>heroku ps</code> what processes/containers are running for your application.</p>
</li>
<li>
<p>If you want to see the actual stdout/log of the container starting up, you can use <code>heroku logs --tail</code>.</p>
</li>
<li>
<p>Once the application-server is started, you can run <code>heroku open</code> and it will open the URL under which your application is deployed on Heroku in your default browser.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_to_openliberty_on_heroku">Deploy to OpenLiberty on Heroku</h3>
<div class="paragraph">
<p>What changes are needed to deploy to a different application-server? E.g. OpenLiberty?
For one, a different <code>Dockerfile</code> that packages the WAR into an OpenLiberty container.
The reference which <code>Dockerfile</code> is used can be found in the <code>heroku.yml</code>.
You can simply change it to <code>Dockerfile.liberty</code> if you want to try it out.
As already stated before, the setting of the HTTP-port from an environment-varible can easily be done from OpenLiberty&#8217;s <code>server.xml</code>.</p>
</div>
<div class="paragraph">
<p>To try it out, simply change the <code>heroku.yml</code> and run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git add heroku.yml
git commit -m "Deploy to OpenLiberty this time."
git push heroku master</pre>
</div>
</div>
<div class="paragraph">
<p>You can monitor the startup of OpenLiberty with <code>heroku logs --tail</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I hope it was possible for me to convience you that using Heroku for deploying Java EE application is an easy option for at least hobby-projects.
It only takes seconds to deploy an application and share it with family, friends or testers. :-)</p>
</div>
<div class="paragraph">
<p>The nice thing about integrating so nicely with Docker and Git, is that you don&#8217;t have a lot of proprietary content in your project. Except for the <code>heroku.yml</code> there is nothing. If your application grows, you can easily move to AWS or another cloud-provider.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2018/graal-native-app.html"><h1>Building native Java Applications with GraalVM</h1></a>
		<p class="postingdate"><em>20 October 2018</em></p>

		<p><div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://www.graalvm.org/">GraalVM</a> is an experimental JVM featuring a new Just-in-time (JIT) compiler that might some day replace HotSpot. One noteable feature is the ability to also use this JIT to build native applications that do not require a JVM to be installed on the system. It is just a native application like an <code>.exe</code> under Windows.</p>
</div>
<div class="paragraph">
<p>There are other solutions that allow you to bundle your Java application as a "kind of" native app (e.g. including the JRE in some bundled form), but the native application built by GraalVM has a better performance in in regards to startup-time. Where normal Java applications are slow on startup because the JIT needs to warm up and optimize the code, the native application built by GraalVM is multiple factors of a magnitude faster. In real numbers: On my system, the below application started via <code>java -jar</code> took 200 milliseconds where the native application took 1 millisecond only.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hello_native">Hello Native</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here are the steps to build and run a simple commandline-app via GraalVM.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You need to have the native devlopment-tools of your OS installed. For me on CentOS, this is:
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>glibc-devel</p>
</li>
<li>
<p>zlib-devel</p>
</li>
<li>
<p>gcc</p>
</li>
<li>
<p>glibc-static</p>
</li>
<li>
<p>zlib-static</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For Debian Stretch, it is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>zlib1g-dev</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now the steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get <a href="http://www.graalvm.org/">GraalVM</a>. I use <a href="https://sdkman.io/">SDKMan</a> to download and manage my Java versions. Simply run:</p>
<div class="listingblock">
<div class="content">
<pre>sdk install java 1.0.0-rc7-graal</pre>
</div>
</div>
<div class="paragraph">
<p>SDKMan will ask if it should set graal as the default Java-version. I would not do so; rather, set it manually in the current shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>export JAVA_HOME=/home/daniel/.sdkman/candidates/java/1.0.0-rc7-graal
export PATH="$JAVA_HOME/bin:$PATH"</pre>
</div>
</div>
</li>
<li>
<p>Create a simple Java-project; e.g. via Gradle:</p>
<div class="listingblock">
<div class="content">
<pre>mkdir graal-native &amp;&amp; cd graal-native
gradle init --type java-application</pre>
</div>
</div>
</li>
<li>
<p>Build the jar via Gradle:</p>
<div class="listingblock">
<div class="content">
<pre>gradle build</pre>
</div>
</div>
</li>
<li>
<p>Build the native image/application with <code>native-image</code> utility from GraalVM.</p>
<div class="listingblock">
<div class="content">
<pre>native-image \
    -cp build/libs/graal-native.jar \
    -H:+ReportUnsupportedElementsAtRuntime \
    --static --no-server App</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the gradle-build built the standard Jar to <code>build/libs/graal-native.jar</code>. Also, the fully qualified class-name of the class with the main-method is <code>App</code>.</p>
</div>
</li>
<li>
<p>A native executable with the same classname (only lower-case) should have been built. Run it with <code>./app</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reflective_access">Reflective access</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Building a native image from your Java-application will limit the ability to use reflection. Read this for the <a href="https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md">limitations</a> of GraalVM and where a special JSON-file with metadata is required.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create a small example in the App class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

public class App {
	public String getGreeting() {
		return "Hello world.";
	}

	public static void main(String[] args) {
		App app = new App();
		try {
			Method greetMethod = App.class.getMethod("getGreeting", new Class[] {});
			System.out.println(greetMethod.invoke(app, new Object[] {}));
		} catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException
				| InvocationTargetException e) {
			System.err.println("Something went wrong...");
			e.printStackTrace();
		}

	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Building the JAR and creating a native-image should work like before. Running the app, should also work due to the <em>Automatic detection</em> feature.
It works, because the compiler can intercept the reflection-calls and replace them with the native calls because <code>getGreeting</code> is a constant String.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see if it will still work when we provide the method-name as a commandline-argument to the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

public class App {
	public String getGreeting() {
		return "Hello world.";
	}

	public static void main(String[] args) {
		String methodName = args[0];
		System.out.println("Method accessed reflectively: " + methodName);

		App app = new App();
		try {
			Method greetMethod = App.class.getMethod(methodName, new Class[] {});
			System.out.println(greetMethod.invoke(app, new Object[] {}));
		} catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException
				| InvocationTargetException e) {
			System.err.println("Something went wrong...");
			e.printStackTrace();
		}

	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We build the native image like before. But running the app will fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; ./app getGreeting
Method accessed reflectively: getGreeting
Something went wrong...
java.lang.NoSuchMethodException: App.getGreeting()
	at java.lang.Throwable.&lt;init&gt;(Throwable.java:265)
	at java.lang.Exception.&lt;init&gt;(Exception.java:66)
	at java.lang.ReflectiveOperationException.&lt;init&gt;(ReflectiveOperationException.java:56)
	at java.lang.NoSuchMethodException.&lt;init&gt;(NoSuchMethodException.java:51)
	at java.lang.Class.getMethod(Class.java:1786)
	at App.main(App.java:15)
	at com.oracle.svm.core.JavaMainWrapper.run(JavaMainWrapper.java:163)</pre>
</div>
</div>
<div class="paragraph">
<p>Lets create a file called <code>reflectionconfig.json</code> with the necessary meta-information for the <code>App</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="json">[
  {
    "name" : "App",
    "methods" : [
      { "name" : "getGreeting", "parameterTypes" : [] }
    ]
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Build the native application with the meta-data file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>native-image \
    -cp build/libs/graal-native.jar \
    -H:ReflectionConfigurationFiles=reflectionconfig.json \
    -H:+ReportUnsupportedElementsAtRuntime \
    --static --no-server App</pre>
</div>
</div>
<div class="paragraph">
<p>Run the application again, and you should see it works now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; ./app getGreeting
Method accessed reflectively: getGreeting
Hello world.</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GraalVM is certainly a nice piece of research. Actually, more than that; according to <a href="https://chrisseaton.com/truffleruby/tenthings/">Top 10 Things To Do With GraalVM</a>, it is used in production by Twitter.
I will be trying out the native integration with JavaScript/NodeJS in a future post.
As this post is mainly for my own records, I might have skimmed over some important details. You might want to read <a href="https://medium.com/graalvm/instant-netty-startup-using-graalvm-native-image-generation-ed6f14ff7692">this excellent article to run netty on GraalVM</a> for a more thorough write-up.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2018/gradle-apt.html"><h1>Using Java Annotation Processors from Gradle and Eclipse</h1></a>
		<p class="postingdate"><em>14 October 2018</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This post describes how to use/reference a Java Annotation Processor from your Gradle-based Java project. The main challenge is the usage from within Eclipse which requires some additional steps.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume we want to use Google&#8217;s <a href="https://github.com/google/auto/tree/master/service">auto-service</a> annotation-processor which generates <code>META-INF/services/</code> files based on annotation service-providers with <code>@AutoService</code> annoations.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_setup">Basic Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Adjust your <code>build.gradle</code> to reference the <a href="https://github.com/tbroyer/gradle-apt-plugin">Gradle APT plugin</a> and add a dependency.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">plugins {
    id "net.ltgt.apt-eclipse" version "0.18"
}

dependencies {
	annotationProcessor ('com.google.auto.value:auto-value:1.5')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The plugin <code>net.ltgt.apt-eclipse</code> will also pull in <code>net.ltgt.apt</code> (which is independent of any IDE) and the standard <code>eclipse</code> plugin.</p>
</div>
<div class="paragraph">
<p>The annotation-processor is now properly called during compilation if you run <code>gradle build</code>. The only problem left is how to run it from within Eclipse.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_eclipse_integration">Eclipse Integration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you carefully check the <a href="https://github.com/tbroyer/gradle-apt-plugin/blob/master/README.md#eclipse">README.md</a>, you will see that when using the Buildship plugin in Eclipse (which should be the default because Eclipse ships with it) you have to perform some manual steps:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>When using Buildship, you&#8217;ll have to manually run the eclipseJdtApt and eclipseFactorypath tasks to generate the Eclipse configuration files, then either run the eclipseJdt task or manually enable annotation processing: in the project properties → Java Compiler → Annotation Processing, check Enable Annotation Processing. Note that while all those tasks are depended on by the eclipse task, that one is incompatible with Buildship, so you have to explicitly run the two or three aforementioned tasks and not run the eclipse task.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>What you have to do, is run the following command on your project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>gradle eclipseJdtApt eclipseFactorypath eclipseJdt</pre>
</div>
</div>
<div class="paragraph">
<p>From within Eclipse, you now have to run right-click the project and select <code>Gradle / Refresh Gradle Project</code>. Afterwards, <code>Project / Clean</code>.
With this clean build, the annotation-processor should be running.</p>
</div>
<div class="paragraph">
<p>In case it does not work, you can double-check if the project was configured properly by right-clicking the project and going to <code>Properties / Java Compiler / Annotation Processing / Factory Path</code>; the <code>auto-value</code> JAR-file should be referenced here.</p>
</div>
<div class="paragraph">
<p>At this point, your annotation-processor should work fine; also from within Eclipse. But in case your annotation-processor is generating Java classes, you will not see them in Eclipse because they are generated to <code>build/generated/sources/apt/main</code>.</p>
</div>
<div class="paragraph">
<p>I have found two ways to deal with it.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Either, generate them to <code>src/main/generated</code> in case you have some need to also check them in source-control.</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">compileJava {
	options.annotationProcessorGeneratedSourcesDirectory = file("${projectDir}/src/main/generated")
}</code></pre>
</div>
</div>
</li>
<li>
<p>Or, make the build-subfolder a source-folder in Eclipse:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">eclipse {
    classpath {
        file.beforeMerged { cp -&gt;
            cp.entries.add( new org.gradle.plugins.ide.eclipse.model.SourceFolder('build/generated/source/apt/main', null) )
        }
    }
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the future, I want to be able to quickly write an annotation-processor when needed. I have put a Gradle project containing a minimal annotation-processor including unit-test in <a href="https://github.com/38leinaD/jee-samples/tree/master/apt-example">my Github repo</a>.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2018/single-source-scripts-jep330.html"><h1>JEP 330: Launch Single-File Source-Code Programs</h1></a>
		<p class="postingdate"><em>24 September 2018</em></p>

		<p><div class="paragraph">
<p>Java 11 includes <a href="http://openjdk.java.net/jeps/330">JEP 330</a> which allows to use Java source-files like  shell-scripts.</p>
</div>
<div class="paragraph">
<p>Create a file named <code>util</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">#!java --source 11

public class Util {
	public static void main (String[] args) {
		System.out.println("Hello " + args[0] + "!");
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure it is executable by running <code>chmod u+x util</code>.</p>
</div>
<div class="paragraph">
<p>Running the script, will compile it on the fly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; ./util Daniel
Hello Daniel!</pre>
</div>
</div>
<div class="paragraph">
<p>As of now, editors like Visual Studio code don&#8217;t recognize the file as Java files automatically. This means, code-completion and syntax hightlighting do not work without manual steps. Let&#8217;s hope this gets fixed soon after the release of Java 11.</p>
</div></p>
  	
		<a href="blog/2018/openjfx.html"><h1>OpenJFX 11</h1></a>
		<p class="postingdate"><em>23 September 2018</em></p>

		<p><div class="paragraph">
<p>As of Java 11, JavaFX is no longer packaged with the runtime but is a seperate module.
Go to the <a href="https://openjfx.io/">OpenJFX website</a> for "Getting Started" docs.
In this post, I will provide a minimal setup for building and testing a OpenFX 11 application.
The purpose is not to describe the steps in detail, but to have some Gradle- and code-samples at hand for myself.</p>
</div>
<div class="paragraph">
<p>Of course, you will need Java 11. As of this writing, Java 11 is not released so you will need to get an early-access version.</p>
</div>
<div class="paragraph">
<p>The Application-class looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package sample;

import java.io.IOException;

import javafx.application.Application;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.TextField;
import javafx.stage.Stage;

public class HelloFX extends Application {

	public static class Controller {

		@FXML
		TextField inputField;

		@FXML
		Label label;

		@FXML
		Button applyButton;

		public void applyButtonClicked() {
			label.setText(inputField.getText());
		}
	}

	@Override
	public void start(Stage stage) throws IOException {
		Parent root = FXMLLoader.load(getClass().getResource("/sample.fxml"));
		Scene scene = new Scene(root, 640, 480);
		stage.setScene(scene);
		stage.show();
	}

	public static void main(String[] args) {
		launch();
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The controller is embeeded to simplify the example. It is used from within the <code>sample.fxml</code> under <code>src/main/resources</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;?import javafx.scene.control.Button?&gt;
&lt;?import javafx.scene.control.Label?&gt;
&lt;?import javafx.scene.control.TextField?&gt;
&lt;?import javafx.scene.layout.ColumnConstraints?&gt;
&lt;?import javafx.scene.layout.GridPane?&gt;
&lt;?import javafx.scene.layout.RowConstraints?&gt;

&lt;GridPane alignment="center" hgap="10" vgap="10" xmlns="http://javafx.com/javafx/10.0.1" xmlns:fx="http://javafx.com/fxml/1" fx:controller="sample.HelloFX$Controller"&gt;
   &lt;children&gt;
            &lt;TextField id="input" fx:id="inputField" layoutX="15.0" layoutY="25.0" /&gt;
            &lt;Label id="output" fx:id="label" layoutX="15.0" layoutY="84.0" text="TEXT GOES HERE" GridPane.rowIndex="1" /&gt;
            &lt;Button id="action" fx:id="applyButton" layoutX="124.0" layoutY="160.0" mnemonicParsing="false" onAction="#applyButtonClicked" text="Apply" GridPane.rowIndex="2" /&gt;
   &lt;/children&gt;
   &lt;columnConstraints&gt;
      &lt;ColumnConstraints /&gt;
   &lt;/columnConstraints&gt;
   &lt;rowConstraints&gt;
      &lt;RowConstraints /&gt;
      &lt;RowConstraints minHeight="10.0" prefHeight="30.0" /&gt;
      &lt;RowConstraints minHeight="10.0" prefHeight="30.0" /&gt;
   &lt;/rowConstraints&gt;
&lt;/GridPane&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, we want to write tested code. So, we can write a UI-test using <a href="https://github.com/TestFX/TestFX">TestFX</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package sample;

import java.io.IOException;

import org.junit.jupiter.api.Test;
import org.testfx.api.FxAssert;
import org.testfx.framework.junit5.ApplicationTest;
import org.testfx.matcher.control.LabeledMatchers;

import javafx.stage.Stage;

public class HelloFXTest extends ApplicationTest {

	@Override
	public void start(Stage stage) throws IOException {
		new HelloFX().start(stage);
	}

	@Test
	public void should_drag_file_into_trashcan() {
		// given:
		clickOn("#input");
		write("123");

		// when:
		clickOn("#action");

		// then:
		FxAssert.verifyThat("#output", LabeledMatchers.hasText("123"));
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, the <code>build.gradle</code> that ties it all together.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">apply plugin: 'application'

def currentOS = org.gradle.internal.os.OperatingSystem.current()
def platform
if (currentOS.isWindows()) {
    platform = 'win'
} else if (currentOS.isLinux()) {
    platform = 'linux'
} else if (currentOS.isMacOsX()) {
    platform = 'mac'
}

repositories {
    mavenCentral()
}

dependencies {
    // we need to depend on the platform-specific libraries of openjfx
    compile "org.openjfx:javafx-base:11:${platform}"
    compile "org.openjfx:javafx-graphics:11:${platform}"
    compile "org.openjfx:javafx-controls:11:${platform}"
    compile "org.openjfx:javafx-fxml:11:${platform}"

    // junit 5
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.3.1'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.3.1'

    // testfx with junit5 binding
    testImplementation 'org.testfx:testfx-core:4.0.14-alpha'
    testImplementation 'org.testfx:testfx-junit5:4.0.14-alpha'
}

// add javafx modules to module-path during compile and runtime
compileJava {
    doFirst {
        options.compilerArgs = [
                '--module-path', classpath.asPath,
                '--add-modules', 'javafx.controls,javafx.fxml'
        ]
    }
}

run {
    doFirst {
        jvmArgs = [
                '--module-path', classpath.asPath,
                '--add-modules', 'javafx.controls,javafx.fxml'
        ]
    }
}

test {
    // use junit5 engine in gradle
    useJUnitPlatform()
    // log all tests
    testLogging {
        events 'PASSED', 'FAILED', 'SKIPPED'
    }
    // log output of tests; enable when needed
    //test.testLogging.showStandardStreams = true
}

mainClassName='sample.HelloFX'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some comments are give as part of the code. So, no further explaination is give here.</p>
</div>
<div class="paragraph">
<p>Execute <code>gradle test</code> to run the tests. Execute <code>gradle run</code> to just run the application.</p>
</div></p>
  	
		<a href="blog/2018/kumuluzee.html"><h1>KumuluzEE for Standalone Java EE Microservices</h1></a>
		<p class="postingdate"><em>09 September 2018</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I have to admit that I have never been too excited about frameworks like KumuluzEE, Thorntail (previously Wildfly Swarm), Payara Micro, etc.. Regular application-servers that offer a seperation between platform and application-logic feel more natural; even more so now with Docker as it can reduce the image-size significantly.</p>
</div>
<div class="paragraph">
<p>But in certain situation I can see that it is useful to have a standalone Java application which can be started with <code>java -jar</code> instead of requiring an application-server. Due to this reason, I felt the need to give these frameworks/platforms a try.</p>
</div>
<div class="paragraph">
<p>In this post, I would like to start with <a href="https://ee.kumuluz.com/">KumuluzEE</a> which advertises the easy migration of Java EE applications to cloud-native microservices on it&#8217;s website. The advantage, like with Thorntail, to me is that I can code against the regular Java EE APIs and thus do not have to learn a new framework.</p>
</div>
<div class="paragraph">
<p>Below, I will describe the main things that need to be done to a Maven-based Java EE project to migrate it to KumuluzEE.
You can find the final version of the project in my <a href="https://github.com/38leinaD/jee-samples/tree/master/kumuluzee">Git repo</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_steps">Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As the generated artifact is an Uber-Jar and no WAR-file, change the packaging-type to 'jar'.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;packaging&gt;jar&lt;/packaging&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the dependencies to KumuluzEE and remove the dependency to the Java EE APIs (they will be transitively included). This is already what I don&#8217;t like at all: I will have to fiddle with and include each Java EE spec individually; no way to just depend on all parts of the spec.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-core&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-servlet-jetty&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-jsp-jetty&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-el-uel&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-jax-rs-jersey&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-cdi-weld&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-jsf-mojarra&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-jpa-eclipselink&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-bean-validation-hibernate-validator&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-json-p-jsonp&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-jta-narayana&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
        &lt;artifactId&gt;kumuluzee-microProfile-1.2&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.kumuluz.ee&lt;/groupId&gt;
            &lt;artifactId&gt;kumuluzee-bom&lt;/artifactId&gt;
            &lt;version&gt;3.0.0-SNAPSHOT&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the application is packaged as a JAR-file and not as WAR, there is a different structure required in the build already. Instead of having a <code>src/main/webapp</code>, you have to place it under <code>src/main/resources/webapp</code>. Also, files like <code>beans.xml</code> and <code>persistence.xml</code> have to be placed under <code>src/main/resources/META-INF</code> instead of <code>src/main/resources/webapp/WEB-INF</code>. Below you find the basic structure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>.
└── src
    └── main
        ├── java
        └── resources
            ├── META-INF
            │   └─ beans.xml
            └── webapp
                ├── index.xhtml
                └── WEB-INF
                    ├── faces-config.xml
                    └── web.xml</pre>
</div>
</div>
<div class="paragraph">
<p>I also had to remove the usage of EJB&#8217;s as they are not available in KumuluzEE; which is understandable as it is a big specification and is step-by-step replaced by CDI-based mechanisms like <code>@Transactional</code>.</p>
</div>
<div class="paragraph">
<p>It took me quiet some fiddeling to get the app running; one of my main issues was that I had Jersey as transitive dependency for KumuluzEE and also as a test-dependency (as a test-client to invoke the JAX-RS endpoint). The version difference influenced the versions in my Uber-Jar. In the end, I see this as a problem in Maven, but nevertheless, this would not have happend when just coding against the JavaEE API and deploying on an app-server.</p>
</div>
<div class="paragraph">
<p>Before all the Maven fiddeling, I also tried to create a KumuluzEE-compatible Uber-Jar with Gradle but gave up. I created an <a href="https://github.com/kumuluz/kumuluzee-samples/issues/14">issue</a> and move on to Maven instead.</p>
</div>
<div class="paragraph">
<p>Once I had all my issues resolved, the application itself was running smoothly. Having gone through the motions once, I feel like it could be a viable alternative for developing small microservice or standalone-apps that can be sold/packaged as products but should not require the installation of an app-server.</p>
</div>
<div class="paragraph">
<p>I also appreciate the availability of extensions like service discovery with Consul, access-management with KeyCloak, streaming with Kafka and full support for Microprofile 1.2. For sure, I will consider it the next time I feel the need for developing a small/standalone Java application.
Small is relative though; creating the Uber-Jar and using CDI, JAX-RS, JSF and JPA add roughly 26 MB to the application.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2018/self-contained-jee-app.html"><h1>Building Self-Contained and Configurable Java EE Applications</h1></a>
		<p class="postingdate"><em>25 June 2018</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this post I would like to outline how to build a self-contained Java EE application (WAR), including JPA via a custom JDBC-driver, but with zero application-server configuration/customizing.
The goal is to drop the Java EE application into a vanilla application-server. Zero configuration outside the WAR-archive.
I will be using the latest Java EE 8-compliant application-servers but that does not mean you cannot use a Java EE 7-compliant server.</p>
</div>
<div class="paragraph">
<p>To achieve our goal, I will be leveraging a feature of Java EE 7 that I always found interesting but did not use very often due to it&#8217;s limitations: <code>@DatasourceDefinition</code>.
It is a way of declaring a datasource and connection-pool within your application via annotation; instead of having to configure it outside the application via non-portable configuration-scripts for the application-server of your choice.
E.g. on JBoss you would usually configure your datasource in the <code>standalone*.xml</code>; either directly or via a JBoss .cli-script.
Below you find an example how to define a datasource via annotation in a portable way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@DataSourceDefinition(
        name = "java:app/jdbc/primary",
        className = "org.postgresql.xa.PGXADataSource",
        user = "postgres",
        password = "postgres",
        serverName = "localhost",
        portNumber = 5432,
        databaseName = "postgres")</code></pre>
</div>
</div>
<div class="paragraph">
<p>To me, this was seldom useful because you hard-code your database-credentials. There has been a <a href="https://github.com/javaee/javaee-spec/blob/master/download/password-aliasing-ee7-proposal.pdf">proposal for Java EE 7</a> to support password-aliasing, but it never made it into the spec.
In the past, I only used it for small applications and proof-of-concepts.</p>
</div>
<div class="paragraph">
<p>Until now! A twitter-discussion lead me to realize that at least Wildfly and Payara come with vendor-specific features to do variable-replaments in the annotation-values.
But lets start from the beginning.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_datasource_definition_and_jpa">Datasource-definition and JPA</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below you find a useful pattern to define and produce a datasource within your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Singleton
@DataSourceDefinition(
        name = "java:app/jdbc/primary",
        className = "org.postgresql.xa.PGXADataSource",
        user = "postgres",
        password = "postgres",
        serverName = "postgres",
        portNumber = 5432,
        databaseName = "postgres",
        minPoolSize = 10,
        maxPoolSize = 50)
public class DatasourceProducer {

	@Resource(lookup="java:app/jdbc/primary")
	DataSource ds;

	@Produces
	public DataSource getDatasource() {
		return ds;
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@DatasourceDefinition</code> annotation is sufficient here to bind the datasource for PostgreSQL under the global JNDI-name <code>java:app/jdbc/primary</code>.</p>
</div>
<div class="paragraph">
<p>The usage of <code>@Resource</code> and <code>@Produces</code> is just additional code that exposes the datasource and makes it injectable in other managed beans via <code>@Inject Datasource ds</code>.
But for JPA, this is not needed. What we need is a <code>persistence.xml</code> that uses the same JNDI-name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence
    version="2.1"
    xmlns="http://xmlns.jcp.org/xml/ns/persistence"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd"&gt;
    &lt;persistence-unit name="DefaultPU" transaction-type="JTA"&gt;
        &lt;jta-data-source&gt;java:app/jdbc/primary&lt;/jta-data-source&gt;
        &lt;exclude-unlisted-classes&gt;false&lt;/exclude-unlisted-classes&gt;
        &lt;properties&gt;
            &lt;property name="javax.persistence.schema-generation.database.action" value="drop-and-create" /&gt;
            &lt;property name="javax.persistence.schema-generation.scripts.action" value="drop-and-create" /&gt;
            &lt;property name="javax.persistence.schema-generation.scripts.create-target" value="schemaCreate.ddl" /&gt;
            &lt;property name="javax.persistence.schema-generation.scripts.drop-target" value="schemaDrop.ddl" /&gt;

            &lt;property name="eclipselink.logging.level.sql" value="FINE" /&gt;
            &lt;property name="eclipselink.logging.level" value="FINE" /&gt;

            &lt;property name="hibernate.show_sql" value="true" /&gt;
            &lt;property name="hibernate.format_sql" value="true" /&gt;
        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>From here on, it is plain JPA: Define some entity and inject the EntityManager via <code>@PersistenceContext EntityManager em;</code> to interact with JPA.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_packaging_of_the_jdbc_driver">Packaging of the JDBC-driver</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You might have noticed that the <code>@DataSourceDefinition</code> references the JDBC-driver-class <code>org.postgresql.xa.PGXADataSource</code>.
Obviously, it has to be available for the application so it can connect to the database.
This can be achieved by placing the JDBC-driver in the application-server. E.g. under Wildfly, you register the JDBC-driver as a module.
But what we want is a self-contained application where the JDBC-driver is coming within the application&#8217;s web-archive (WAR).
This is very simple to achieve by adding a runtime-dependency to to the JDBC-driver. You favorite build-tool should support it.
In Gradle, it is done like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">dependencies {
    providedCompile 'javax:javaee-api:8.0'
    runtime 'org.postgresql:postgresql:9.4.1212'
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dynamic_configuration">Dynamic Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What we have now is a self-contained Java EE application-archive (WAR) but the connection to the database and the credentials are hard-coded in the annotation-properties.
To make this really useful, we have to be able to overwrite this values for each stage and deployment. I.e. the database-credentials to the QA-environment&#8217;s database will be different than for production.
Unfortunately, there is no portable/standard way. But if you are willing to commit to a specific application-server, it is possible.
A Twitter-discussion lead me to the documentation for Payara and Wildfly both supporting this feature in some way.</p>
</div>
<div class="sect2">
<h3 id="_payara">Payara</h3>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="en"><p lang="en" dir="ltr">For Payara here is the Documentation: <a href="https://t.co/jQMOMVLy3N">https://t.co/jQMOMVLy3N</a><br><br>I think I saw something in Wildfly docs, but I’m not sure</p>&mdash; Felipe Moraes (@fe_amoraes) <a href="https://twitter.com/fe_amoraes/status/1006611447500046336?ref_src=twsrc%5Etfw">June 12, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<div class="paragraph">
<p>So, for Payara we find the documentation <a href="https://docs.payara.fish/documentation/payara-server/server-configuration/var-substitution/usage-of-variables.html">here</a>.
Note that we will have to modify the annotation-values like this to read from environment variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@DataSourceDefinition(
        name = "java:app/jdbc/primary",
        className = "org.postgresql.xa.PGXADataSource",
        user = "${ENV=DB_USER}",
        password = "${ENV=DB_PASSWORD}",
        serverName = "${ENV=DB_SERVERNAME}",
        portNumber = 5432,
        databaseName = "${ENV=DB_DATABASENAME}",
        minPoolSize = 10,
        maxPoolSize = 50)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can find this as a working Gradle-project plus Docker-Compose environment on <a href="https://github.com/38leinaD/jee-samples/tree/master/datasource-definition">Github</a>.
The steps are very simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/38leinaD/jee-samples.git
cd jee-samples/datasource-definition/cars
./gradlew build
docker-compose -f docker-compose.payara.yml up</pre>
</div>
</div>
<div class="paragraph">
<p>When the server is started, you can send below request to create a new row in a database-table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>curl -i -X POST -d '{"model": "tesla"}' -H "Content-Type: application/json" http://localhost:8080/cars/resources/cars</pre>
</div>
</div>
<div class="paragraph">
<p>If you are wondering where the values like <code>${ENV=DB_USER}</code> are set, check the <a href="https://github.com/38leinaD/jee-samples/blob/master/datasource-definition/cars/docker-compose.payara.yml">docker-compose.payara.yml</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_widlfly">Widlfly</h3>
<div class="paragraph">
<p>So, how about Wildfly?</p>
</div>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="en"><p lang="en" dir="ltr">For WildFly, see annotation-property-replacement here: <a href="https://t.co/UCGVlNVJkj">https://t.co/UCGVlNVJkj</a></p>&mdash; OmniFaces (@OmniFaces) <a href="https://twitter.com/OmniFaces/status/1006631897034829824?ref_src=twsrc%5Etfw">June 12, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<div class="paragraph">
<p>For Wildfly, you can find it under "Annotation Property Replacement" in the <a href="https://docs.jboss.org/author/display/WFLY/Subsystem+configuration">admin-guide</a>.</p>
</div>
<div class="paragraph">
<p>First, we have to enable the variable-replacement feature in the <code>standalone*.xml</code>; which is not the case by default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:ee:4.0"&gt;
    &lt;annotation-property-replacement&gt;true&lt;/annotation-property-replacement&gt;
    &lt;!-- ... --&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, technically, we still hava to modify the application-server in the <code>standalone*.xml</code> in this case.</p>
</div>
<div class="paragraph">
<p>But then, you can use annotation-properties in the format <code>${&lt;environment-variable&gt;:&lt;default-value&gt;}</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@DataSourceDefinition(
    name = "java:app/jdbc/primary",
    className = "org.postgresql.xa.PGXADataSource",
    user = "${DB_USER:postgres}",
    password = "${DB_PASSWORD:postgres}",
    serverName = "${DB_SERVERNAME:postgres}",
    portNumber = 5432,
    databaseName = "${DB_DATABASENAME:postgres}",
    minPoolSize = 10,
    maxPoolSize = 50)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you try this, you might notice the following exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Caused by: org.postgresql.util.PSQLException: FATAL: role "${DB_USER:postgres}" does not exist
	at org.postgresql.core.v3.QueryExecutorImpl.receiveErrorResponse(QueryExecutorImpl.java:2455)
	at org.postgresql.core.v3.QueryExecutorImpl.readStartupMessages(QueryExecutorImpl.java:2586)
	at org.postgresql.core.v3.QueryExecutorImpl.&lt;init&gt;(QueryExecutorImpl.java:113)
	at org.postgresql.core.v3.ConnectionFactoryImpl.openConnectionImpl(ConnectionFactoryImpl.java:222)
	at org.postgresql.core.ConnectionFactory.openConnection(ConnectionFactory.java:52)
	at org.postgresql.jdbc.PgConnection.&lt;init&gt;(PgConnection.java:216)
	at org.postgresql.Driver.makeConnection(Driver.java:404)
	at org.postgresql.Driver.connect(Driver.java:272)
	at java.sql.DriverManager.getConnection(DriverManager.java:664)
	at java.sql.DriverManager.getConnection(DriverManager.java:247)
	at org.postgresql.ds.common.BaseDataSource.getConnection(BaseDataSource.java:86)
	at org.postgresql.xa.PGXADataSource.getXAConnection(PGXADataSource.java:48)
	at org.jboss.jca.adapters.jdbc.xa.XAManagedConnectionFactory.getXAManagedConnection(XAManagedConnectionFactory.java:515)
	... 133 more</pre>
</div>
</div>
<div class="paragraph">
<p>It seems there is a <a href="https://issues.jboss.org/browse/WFLY-10581">bug</a> in the latest Wildfly that does not allow to use variables for the user/password properties.
For now, we will continue with user and password beeing hardcoded and only the serverName and databaseName as dyanmic values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@DataSourceDefinition(
    name = "java:app/jdbc/primary",
    className = "org.postgresql.xa.PGXADataSource",
    user = "postgres",
    password = "postgres",
    serverName = "${DB_SERVERNAME:postgres}",
    portNumber = 5432,
    databaseName = "${DB_DATABASENAME:postgres}",
    minPoolSize = 10,
    maxPoolSize = 50)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This works without any issues if the defaults match your environment. Explicitly overwriting these values can be achived via Java&#8217;s system-properties. E.g <code>-DDB_SERVERNAME=postgres1</code> on the commandline.
See <a href="https://github.com/38leinaD/jee-samples/blob/master/datasource-definition/cars/docker-compose.wildfly.yml">docker-compose.wildfly.yml</a> for a complete example.
Before you can run this Wildfly-setup in the demo-application, you need to comment in the right annotation in <a href="https://github.com/38leinaD/jee-samples/blob/master/datasource-definition/cars/src/main/java/de/dplatz/cars/business/entity/DatasourceProducer.java">DatasourceProducer.java</a>. The default setup is for Payara.</p>
</div>
</div>
<div class="sect2">
<h3 id="_liberty">Liberty</h3>
<div class="paragraph">
<p>Liberty does not have support for variables yet, but there is interest and an <a href="https://github.com/OpenLiberty/open-liberty/issues/3963">issue</a> has been filed:</p>
</div>
<blockquote class="twitter-tweet" data-conversation="none" data-cards="hidden" data-lang="en"><p lang="en" dir="ltr">No, interesting idea so I raised an issue: <a href="https://t.co/hAvZnU8opO">https://t.co/hAvZnU8opO</a></p>&mdash; Alasdair (@nottycode) <a href="https://twitter.com/nottycode/status/1006940822183596033?ref_src=twsrc%5Etfw">June 13, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you make a choice for either Payara or Wildfly, you are able to build a truely self-contained Java EE application.
We have seen how to achive this for a WAR-archive leveraging JPA or plain JDBC. The JDBC-driver is contained within the WAR-archive and configuration for the datasources can be inject from the outside via environment variables or Java system-properties.</p>
</div>
<div class="paragraph">
<p>Payara and Wildfly offer slightly different mechanisms and syntax.
Payara shines because it does not require any additional application-server config.
But we cannot specify defaults in the annotation-values and always need to provide environment-variables from the outside.</p>
</div>
<div class="paragraph">
<p>Wildfly allows to set default-values on the annotation-properties. This makes it possible to deploy e.g. in a development-environment without the need to set any environment-variables.
A minor disadvantage is that the default configuration does not have the annotation-property-replacement enabled. So, the only vendor-specific config that is required is the enabling of this feature.
Also, currently this mechanism is riddled by a bug. Overwriting the user/password is not working at the time of writing.</p>
</div>
<div class="paragraph">
<p>With this, both application-servers offer a useful feature for cloud-native applications. Unfortunately, you have to decide for a specific application-server to leverage it.
But standardization-efforts are already on their way. The above discussion on Twitter has already been brought over to the <a href="https://dev.eclipse.org/mhonarc/lists/jakarta.ee-community/msg00482.html">Jakarta EE mailing-list</a>.
Feel free to join the discussion if you think this is a useful feature that should be standardized.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_post_mortem">Post Mortem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some time after writing this article, I notices that the OmniFaces library comes with a nice workaround via a wrapper datasource that reads all the wrapped datasource&#8217;s configuration from a config-file.</p>
</div>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="en"><p lang="en" dir="ltr">data-source in web.xml or @DataSourceDefinition on a class, then use property replacements for some of the attributes (${name} syntax), or without property replacement but with wrapper datasource:<a href="https://t.co/bMWedsyI0r">https://t.co/bMWedsyI0r</a></p>&mdash; OmniFaces (@OmniFaces) <a href="https://twitter.com/OmniFaces/status/1022473299819986944?ref_src=twsrc%5Etfw">July 26, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<div class="paragraph">
<p>Arjan Tijms, who is one of the creators of the library, has described the implementation in detail on <a href="http://jdevelopment.nl/switching-data-sources-datasourcedefinition/">his blog</a>.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2018/gradle-checkstyle-2.html"><h1>Checkstyle Configuration from External JAR</h1></a>
		<p class="postingdate"><em>23 June 2018</em></p>

		<p><div class="paragraph">
<p>In <a href="/blog/2018/gradle-checkstyle.html">a previous post</a> I have described the minimal configuration to get checkstyle working with Gradle.
What i did not like, is that I have to place the <code>checkstyle.xml</code> in my project.
Assuming I stick with the standard checkstyle.xml from Google or Sun (or I have a corporate one), I do no want to place it in each and every repo.</p>
</div>
<div class="paragraph">
<p>What I found now is that Gradle supports referencing resources from within published artifacts.
In the below configuration, the <code>google_checks.xml</code> is referenced from the published artifact <code>com.puppycrawl.tools:checkstyle:8.10.1</code> directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">apply plugin: 'checkstyle'

configurations {
    checkstyleConfig
}
def versions = [
    checkstyle: '8.10.1',
]
dependencies {
    checkstyleConfig ("com.puppycrawl.tools:checkstyle:${versions.checkstyle}") {
        transitive = false
    }
}
checkstyle {
    showViolations = true
    ignoreFailures = false
    toolVersion = "${versions.checkstyle}"
    config = resources.text.fromArchiveEntry(configurations.checkstyleConfig, 'google_checks.xml')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example is derived from the <a href="https://docs.gradle.org/2.2/release-notes.html?_ga=2.142488496.32325457.1529731928-846849620.1527763678#sharing-configuration-files-across-builds">offical gradle docs</a>.</p>
</div></p>
  	
		<a href="blog/2018/gradle-arquillian-chameleon-improved-again.html"><h1>Even simpler Arquillian Chameleon usage with Gradle</h1></a>
		<p class="postingdate"><em>11 June 2018</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In <a href="/blog/2018/gradle-arquillian-chameleon-improved.html">a previous post</a> I have described how easy it has become to use Arquillian via the Chameleon extension.
The only "complex" part that&#8217;s left is the <code>@Deployment</code>-annotated method specificing the deployment via Shrinkwrap.</p>
</div>
<div class="paragraph">
<p>What exists for this is the <code>@MavenBuild</code>-annotation. It allows to trigger a maven-build and use the generated artifact.
Usually, this would be the regularly built EAR or WAR-file as the deployment; which is fine in a lot of situations.
Unfortunately, there is no <code>@GradleBuild</code>-annotation today. But there is the <code>@File</code>-annotation to just reference any EAR or WAR on the filesystem;
assuming it was previously built by the Gradle-build, we can just reference the artifact.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RunWith(ArquillianChameleon.class)
@File("build/libs/hello.war")
@ChameleonTarget(value = "wildfly:11.0.0.Final:managed")
public class HelloServiceIT {

    @Inject
    private HelloService service;

    @Test
    public void shouldGreetTheWorld() throws Exception {
        Assert.assertEquals("hello", service.hello());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that there is no <code>@Deployment</code>-annotated method.
The <code>build/libs/hello.war</code> is built with the normal Gradle <code>build</code> task. If we set up our <code>integrationTest</code>-task like this, we can require the <code>build</code>-task as a dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">test {
    // Do not run integration-tests having suffix 'IT'
    include '**/*Test.class'
}

dependencies {
    testCompile 'org.arquillian.container:arquillian-chameleon-junit-container-starter:1.0.0.CR2'
    testCompile 'org.arquillian.container:arquillian-chameleon-file-deployment:1.0.0.CR2'
}

task integrationTest(type: Test) {
    group 'verification'
    description 'Run integration-tests'
    dependsOn 'build'
    include '**/*IT.class'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run it with <code>gradle integrationTest</code>.</p>
</div>
<div class="paragraph">
<p>If you are wondering what other containers are supported and can be provided via the <code>@ChameleonTarget</code>-annotation, see <a href="https://github.com/arquillian/arquillian-container-chameleon#supported-containers">here</a> for the list.
The actual config of supported containers is located in a file called <a href="https://github.com/arquillian/arquillian-container-chameleon/blob/master/arquillian-chameleon-container-model/src/main/resources/chameleon/default/containers.yaml">containers.yaml</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The only disadvantage right now is that it will only work as expected when running a full <code>gradle integrationTest</code>.
If you are e.g. in Eclipse and trigger a single test, it will simply use the already existing artifact instead of creating/building it again.
This is what <code>@MavenBuild</code> is doing; and I hope we will get the equivalent <code>@GradleBuild</code> as well soon.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2018/wlp-eclipselink-cache-coordination.html"><h1>Websphere Liberty, EclipseLink and Caching in the Cluster</h1></a>
		<p class="postingdate"><em>04 June 2018</em></p>

		<p><div class="sect1">
<h2 id="_cache_coordination">Cache Coordination</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using JPA, sooner or later the question of caching will arise to improve performance.
Especially for data that is frequently read but only written/updated infrequently, it makes sense to enable the second-level cache via <code>shared-cache-mode</code>-element in the <code>persistence.xml</code>.
See the <a href="https://docs.oracle.com/javaee/7/tutorial/persistence-cache001.htm#GKJIO">Java EE 7 tutorial</a> for details.</p>
</div>
<div class="paragraph">
<p>By default, EclipseLink has the second-level cache enabled as you can read <a href="https://wiki.eclipse.org/EclipseLink/FAQ/How_to_disable_the_shared_cache%3F">here</a>.
Consider what will happen in a clustered environment: What happens if <strong>server one</strong> has the entity cached and <strong>server two</strong> will update the entity?
<strong>server one</strong> will have a stale cache-entry and by default noone will tell the server that its cache is out-of-date.
How to deal with it? Define a hard-coded expiration? Or not use the second-level-cache at all?</p>
</div>
<div class="paragraph">
<p>A better solution is to get the second-level caches sychronized in the cluster. EclipseLink&#8217;s vendor-specific feature for this is called cache-coordination.
You can read more about it <a href="https://wiki.eclipse.org/EclipseLink/Examples/JPA/CacheCoordination">here</a>, but in a nutshell you can use either JMS, RMI or JGroups to distribute cache-invalidations/updates within the cluster.
This post focuses on getting EclipseLink&#8217;s cache-coordination working under Websphere Liberty via JGroups.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_configuration">Application Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From the application&#8217;s perspective, you only have to enable this feature in the <code>persistence.xml</code> via</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;property name="eclipselink.cache.coordination.protocol" value="jgroups" /&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_liberty_server_configuration_with_global_library">Liberty Server Configuration with Global Library</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Deploying this application on Webspher Liberty, will lead to the following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Exception Description: ClassNotFound: [org.eclipse.persistence.sessions.coordination.jgroups.JGroupsTransportManager] specified in [eclipselink.cache.coordination.protocol] property.</pre>
</div>
</div>
<div class="paragraph">
<p>Thanks to the great help on the openliberty.io mailing-list, I was able to solve the problem. You can read the full discussion <a href="https://groups.io/g/openliberty/topic/eclipselink_cache_coherence/20719688?p=,,,20,0,0,0::recentpostdate%2Fsticky,,,20,2,0,20719688">here</a>.</p>
</div>
<div class="paragraph">
<p>The short summary is that the cache-coordination feature of EclipseLink using JGroups is an extension and Liberty does not ship this extension by default.
RMI and JMS are supported out-of-the-box but both have disadvantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RMI is a legacy technology that I have not worked with in years.</p>
</li>
<li>
<p>JMS in general is a great technology for asychroneous communication but it requires a message-broker like IBM MQ or ActiveMQ. This does not sound like a good fit for a caching-mechanism.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This leaves us with JGroups. The prefered solution to get JGroups working is to replace the JPA-implementation with our own. For us, this will simply be EclipseLink but including the extension.
In Liberty this is possible via the <code>jpaContainer</code> feature in the <code>server.xml</code>. The <a href="https://www.ibm.com/support/knowledgecenter/en/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_dep_jpa.html">offical documentation</a> describes how to use our own JPA-implementation.
As there are still a few small mistakes you can make on the way, let me describe the configuration that works here in detail:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Assuming you are working with the <code>javaee-7.0</code>-feature in the <code>server.xml</code> (or in specific <code>jpa-2.1</code>), you will have to get EclipseLink 2.6 as this implements JPA 2.1. For <code>javaee-8.0</code> (or in specific <code>jpa-2.2</code>) it would be EclipseLink 2.7.</p>
<div class="paragraph">
<p>I assume <code>javaee-7.0</code> here; that&#8217;s why I downloaded <a href="http://www.eclipse.org/downloads/download.php?file=/rt/eclipselink/releases/2.6.5/eclipselink-plugins-2.6.5.v20170607-b3d05bd.zip">EclipseLink 2.6.5 OSGi Bundles Zip</a>.</p>
</div>
</li>
<li>
<p>Create a folder <code>lib/global</code> within your Liberty server-config-folder. E.g. <code>defaultServer/lib/global</code> and copy the following from the zip (same as referenced <a href="https://www.ibm.com/support/knowledgecenter/en/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_dep_jpa.html">here</a> plus the extension):</p>
<div class="ulist">
<ul>
<li>
<p><code>org.eclipse.persistence.asm.jar</code></p>
</li>
<li>
<p><code>org.eclipse.persistence.core.jar</code></p>
</li>
<li>
<p><code>org.eclipse.persistence.jpa.jar</code></p>
</li>
<li>
<p><code>org.eclipse.persistence.antlr.jar</code></p>
</li>
<li>
<p><code>org.eclipse.persistence.jpa.jpql.jar</code></p>
</li>
<li>
<p><code>org.eclipse.persistence.jpa.modelgen.jar</code></p>
</li>
<li>
<p><code>org.eclipse.persistence.extension.jar</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>If you would use it like this, you will find a ClassNotFoundException later for the actual JGroups implementation-classes. You will need to get it seperately from <a href="https://sourceforge.net/projects/javagroups/files/JGroups/3.2.8.Final/">here</a>.</p>
<div class="paragraph">
<p>If we look on the <code>2.6.5</code>-tag in <a href="https://github.com/eclipse/eclipselink.runtime/blob/2.6.5/foundation/org.eclipse.persistence.extension/pom.xml">EclipseLink&#8217;s Git Repo</a>, we see that we should use <code>org.jgroups:jgroups:3.2.8.Final</code>.</p>
</div>
<div class="paragraph">
<p>Download it and copy the <code>jgroups-3.2.8.Final.jar</code> to the <code>lib/global</code> folder as well.</p>
</div>
</li>
<li>
<p>The last step is to set up your <code>server.xml</code> like this:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;server description="new server"&gt;

    &lt;!-- Enable features --&gt;
    &lt;featureManager&gt;
		&lt;feature&gt;servlet-3.1&lt;/feature&gt;
		&lt;feature&gt;beanValidation-1.1&lt;/feature&gt;
		&lt;feature&gt;ssl-1.0&lt;/feature&gt;
		&lt;feature&gt;jndi-1.0&lt;/feature&gt;
		&lt;feature&gt;jca-1.7&lt;/feature&gt;
		&lt;feature&gt;jms-2.0&lt;/feature&gt;
		&lt;feature&gt;ejbPersistentTimer-3.2&lt;/feature&gt;
		&lt;feature&gt;appSecurity-2.0&lt;/feature&gt;
		&lt;feature&gt;j2eeManagement-1.1&lt;/feature&gt;
		&lt;feature&gt;jdbc-4.1&lt;/feature&gt;
		&lt;feature&gt;wasJmsServer-1.0&lt;/feature&gt;
		&lt;feature&gt;jaxrs-2.0&lt;/feature&gt;
		&lt;feature&gt;javaMail-1.5&lt;/feature&gt;
		&lt;feature&gt;cdi-1.2&lt;/feature&gt;
		&lt;feature&gt;jcaInboundSecurity-1.0&lt;/feature&gt;
		&lt;feature&gt;jsp-2.3&lt;/feature&gt;
		&lt;feature&gt;ejbLite-3.2&lt;/feature&gt;
		&lt;feature&gt;managedBeans-1.0&lt;/feature&gt;
		&lt;feature&gt;jsf-2.2&lt;/feature&gt;
		&lt;feature&gt;ejbHome-3.2&lt;/feature&gt;
		&lt;feature&gt;jaxws-2.2&lt;/feature&gt;
		&lt;feature&gt;jsonp-1.0&lt;/feature&gt;
		&lt;feature&gt;el-3.0&lt;/feature&gt;
		&lt;feature&gt;jaxrsClient-2.0&lt;/feature&gt;
		&lt;feature&gt;concurrent-1.0&lt;/feature&gt;
		&lt;feature&gt;appClientSupport-1.0&lt;/feature&gt;
		&lt;feature&gt;ejbRemote-3.2&lt;/feature&gt;
		&lt;feature&gt;jaxb-2.2&lt;/feature&gt;
		&lt;feature&gt;mdb-3.2&lt;/feature&gt;
		&lt;feature&gt;jacc-1.5&lt;/feature&gt;
		&lt;feature&gt;batch-1.0&lt;/feature&gt;
		&lt;feature&gt;ejb-3.2&lt;/feature&gt;
		&lt;feature&gt;json-1.0&lt;/feature&gt;
		&lt;feature&gt;jaspic-1.1&lt;/feature&gt;
		&lt;feature&gt;distributedMap-1.0&lt;/feature&gt;
		&lt;feature&gt;websocket-1.1&lt;/feature&gt;
		&lt;feature&gt;wasJmsSecurity-1.0&lt;/feature&gt;
		&lt;feature&gt;wasJmsClient-2.0&lt;/feature&gt;

		&lt;feature&gt;jpaContainer-2.1&lt;/feature&gt;
    &lt;/featureManager&gt;


    &lt;basicRegistry id="basic" realm="BasicRealm"&gt;
    &lt;/basicRegistry&gt;

    &lt;httpEndpoint id="defaultHttpEndpoint"
                  httpPort="9080"
                  httpsPort="9443" /&gt;

	&lt;applicationManager autoExpand="true"/&gt;

	&lt;jpa defaultPersistenceProvider="org.eclipse.persistence.jpa.PersistenceProvider"/&gt;

&lt;/server&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Some comments on the <code>server.xml</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Note that we have to list all of the features that are included in the <code>javaee-7.0</code> feature minus the <code>jpa-2.1</code> feature explicitly now because we don`t want the default JPA-provider.</p>
</li>
<li>
<p>Instead of <code>jpa-2.1</code> I added <code>jpaContainer-2.1</code> to bring our own JPA-provider.</p>
</li>
<li>
<p>The <code>defaultPersistenceProvider</code> will set the JPA-provider to use ours and is required by the <code>jpaContainer</code> feature.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_liberty_configuration_without_global_library">Liberty Configuration without Global Library</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Be aware that there are different ways how to include our EclipseLink library. Above, I chose the way that requires the least configuration in the <code>server.xml</code> and also works for dropin-applications. The way I did it was via a <a href="https://www.ibm.com/support/knowledgecenter/SSD28V_9.0.0/com.ibm.websphere.wlp.core.doc/ae/cwlp_sharedlibrary.html">global library</a>.
The <a href="https://www.ibm.com/support/knowledgecenter/en/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_dep_jpa.html">offical documentation</a> defines it as an explicit library in the <code>server.xml</code> and reference it for each invidual application like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;bell libraryRef="eclipselink"/&gt;
&lt;library id="eclipselink"&gt;
	&lt;file name="${server.config.dir}/jpa/org.eclipse.persistence.asm.jar"/&gt;
	&lt;file name="${server.config.dir}/jpa/org.eclipse.persistence.core.jar"/&gt;
	&lt;file name="${server.config.dir}/jpa/org.eclipse.persistence.jpa.jar"/&gt;
	&lt;file name="${server.config.dir}/jpa/org.eclipse.persistence.antlr.jar"/&gt;
	&lt;file name="${server.config.dir}/jpa/org.eclipse.persistence.jpa.jpql.jar"/&gt;
	&lt;file name="${server.config.dir}/jpa/org.eclipse.persistence.jpa.modelgen.jar"/&gt;

	&lt;file name="${server.config.dir}/jpa/org.eclipse.persistence.extension.jar"/&gt;
	&lt;file name="${server.config.dir}/jpa/jgroups.jar"/&gt;
&lt;/library&gt;

&lt;application location="myapp.war"&gt;
    &lt;classloader commonLibraryRef="eclipselink"/&gt;
&lt;/application&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also note, that the JARs are this time in the <code>defaultServer/jpa</code>-folder,  not under <code>defaultServer/lib/global</code> and I removed all the version-suffixes from the file-names.
Additionally, make sure to add <code>&lt;feature&gt;bells-1.0&lt;/feature&gt;</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_try_it">Try it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As this post is already getting to long, I will not got into detail here how to use this from your Java EE application. This will be for another post.
But you can already get a working Java EE project to get your hands dirty from <a href="https://github.com/38leinaD/jee-samples/tree/master/eclipselink-cache">my GitHub repository</a>.
Start the Docker Compose environment and use the contained <code>test.sh</code> to invoke some cURL requests against the application on two different cluster-nodes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With the either of the aboved approaches I was able to enable EclipseLink&#8217;s cache-coordination feature on Websphere Liberty for Java EE 7.</p>
</div>
<div class="paragraph">
<p>I did not try it, but I would assume that it will work similar for Java EE 8 on the latest OpenLiberty builds.</p>
</div>
<div class="paragraph">
<p>For sure it is nice that plugging in your own JPA-provider is so easy in Liberty; but I don&#8217;t like that I have to do this to get a feature of EclipseLink working under Liberty which I would expect to work out of the box.
EclipseLink&#8217;s cache-coordination feature is a quiet useful extension and it leaves me uncomfortable that I have configured my own snowflake Liberty instead of relying on the standard package.
On the other hand, it works; and if I make sure to use the exact same version of EclipseLink as packaged with Liberty out of the box, I would hope the differences are minimal.</p>
</div>
<div class="paragraph">
<p>The approach I chose/prefer in the end is <a href="#_liberty_server_configuration_with_global_library">Liberty Server Configuration with Global Library</a> instead of using the approach that is also in the offical documentation (<a href="#_liberty_configuration_without_global_library">Liberty Configuration without Global Library</a>).
The reason is that for <a href="#_liberty_configuration_without_global_library">Liberty Configuration without Global Library</a> I have to reference the library in the <code>server.xml</code> indvidually for each application.
This will not work for applications I would like throw into the <code>dropins</code>.</p>
</div>
</div>
</div></p>
  	
		<a href="blog/2018/kubernetes-on-google.html"><h1>Deploying a Java EE 7 Application with Kubernetes to the Google Cloud</h1></a>
		<p class="postingdate"><em>30 May 2018</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this post I am describing how to deploy a dockerized Java EE 7 application to the Google Cloud Platform (GCP) with Kubernetes.</p>
</div>
<div class="paragraph">
<p>My previous experience is only with AWS; in specific with EC2 and ECS.
So, this is not only my first exposure to the Google Cloud but also my first steps with Kubernetes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_application">The Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The application I would like to deploy is a simple Java EE 7 application exposing a basic HTTP/Rest endpoint.
The sources are located on <a href="https://github.com/38leinaD/kubernetes-playground">GitHub</a> and the Docker image can be found on <a href="https://hub.docker.com/r/38leinad/hello/">Docker Hub</a>.
If you have Docker installed, you can easily run it locally via</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker run --rm --name hello -p 80:8080 38leinad/hello</pre>
</div>
</div>
<div class="paragraph">
<p>Now, in your browser or via cURL, go to <a href="http://localhost/hello/resources/health" class="bare">http://localhost/hello/resources/health</a>. You should get <code>UP</code> as the response. A simple health-check endpoint. See <a href="https://github.com/38leinaD/kubernetes-playground/blob/master/hello/src/main/java/de/dplatz/hello/business/boundary/HealthCheckResource.java">here</a> for the sources.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s deploy it on the Google Cloud now.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_and_setup">Installation and Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Obviously, you will have to register on <a href="https://cloud.google.com/" class="bare">https://cloud.google.com/</a> for a free trial-account first.
It is valid for one year and also comes with a credit of $300. I am not sure yet what/when resources will cost credit. After four days of tinkering, $1 is gone.</p>
</div>
<div class="paragraph">
<p>Once you have singed up, you can do all of the configuration and management of your apps from the Google Cloud web-console. They even have an integrated terminal running in the browser.
So, strictly it is not required to install any tooling on your local system if you are happy with this.</p>
</div>
<div class="paragraph">
<p>The only thing we will do from the web-console is the creation of a Kubernetes Cluster (You can also do this via <code>gcloud</code> from the commandline).
For this you go to "Kubernetes Engine / Kubernetes clusters" and "Create Cluster".
You can leave all the defaults, just make sure to remember the name of the cluster and the zone it is deployed to.
We will need this later to correctly set up the <code>kubectl</code> commandline locally.
Note that it will also ask you to set up a project before creating the cluster. This allows grouping of resources in GCP based on different projects which is quiet useful.</p>
</div>
<div class="paragraph">
<p>Setting up the cluster is heavy lifting and thus can take some minutes. In the meantime, we can already install the tools.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install SDK / CLI (Centos): <a href="https://cloud.google.com/sdk/docs/quickstart-redhat-centos" class="bare">https://cloud.google.com/sdk/docs/quickstart-redhat-centos</a>.</p>
<div class="paragraph">
<p>I had to make sure to be logged <strong>out</strong> of my Google-account before running <code>gcloud init</code>.
Without doing this, I received a 500 http-response.</p>
</div>
<div class="paragraph">
<p>Also, when running <code>gcloud init</code> it will ask your for a default zone. Choose the one you used when setting up the cluster. Mine is <code>europe-west1-b</code>.</p>
</div>
</li>
<li>
<p>Install the <code>kubectl</code> command:</p>
<div class="listingblock">
<div class="content">
<pre>gcloud components install kubectl</pre>
</div>
</div>
<div class="paragraph">
<p>Note that you can also install <code>kubectl</code> independently. E.g. I already had it installed from <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">here</a> while using minikube.</p>
</div>
</li>
<li>
<p>Now, you will need the name of the cluster you have created via the web-console. Configure the <code>gcloud</code> CLI-tool for your cluster:</p>
<div class="listingblock">
<div class="content">
<pre>gcloud container clusters get-credentials &lt;cluster-name&gt; --zone &lt;zone-name&gt; --project &lt;project-name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>You can easily get the full command with correct parameters when opening the cluster in the web-console and clicking the "Connect" button for the web-based CLI.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Run <code>kubectl get pods</code> just to see if the command works. You should see <code>No resources found.</code>.
At this point, we have configured our CLI/<code>kubectl</code> to interact with our kubernetes cluster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_namespaces">Namespaces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next thing we will do is optional but makes life easier once you have multiple applications deployed on your cluster.
You can create a namespace/context per application your are deploying to GCP.
This allows you to always only see the resources of the namespace you are currently working with. It also allows you to delete the namespace and it will do a cascading delete of all the resources.
So, this is very nice for experimentation and not leaving a big mess of resources.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl create namespace hello-namespace
kubectl get namespaces</pre>
</div>
</div>
<div class="paragraph">
<p>We create a namespace for our application and check if it actually was created.</p>
</div>
<div class="paragraph">
<p>You can now attach this namespace to a context. A context is not a resource on GCP but is a configuration in your local <code>&lt;user-home&gt;/.kube/config</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl config set-context hello-context --namespace=hello-namespace \
  --cluster=&lt;cluster-name&gt; \
  --user=&lt;user-name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>What is <code>&lt;cluster-name&gt;</code> and <code>&lt;user-name&gt;</code> that you have to put in? Easiest, is to get it from running</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl config view</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s activate this context. All operations will be done within the assigned namespace from now on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl config use-context hello-context</pre>
</div>
</div>
<div class="paragraph">
<p>You can also double-check the activated context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl config current-context</pre>
</div>
</div>
<div class="paragraph">
<p>Run the <code>kubectl config view</code> command again or even check in <code>&lt;user-home&gt;/.kube/config</code>. As said before, the current-context can be found here and is just a local setting.</p>
</div>
<div class="paragraph">
<p>You can read more on namespaces <a href="https://kubernetes.io/docs/tasks/administer-cluster/namespaces-walkthrough/">here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_the_application">Deploying the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Deploying the application in Kubernetes requires three primitives to be created:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deployment/Pods: These are the actually docker-containers that are running. A pod actually could consist of multiple containers. Think of e.g. side-car containers in a microservice architecture.</p>
</li>
<li>
<p>Service: The containers/Pods are hidden behind a service. Think of the Service as e.g. a load-balancer: You never interact with the individual containers directly; the load-balancer is the single service you as a client call.</p>
</li>
<li>
<p>Ingress: Our final goal is to access our application from the Internet. By default, this is not possible. You will have to set up an Ingress for Incoming Traffic. Basically, you will get an internet-facing IP-address that you can call.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All these steps are quiet nicely explained when you read the offical doc on <a href="https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/">Setting up HTTP Load Balancing with Ingress</a>.
What you will find there, is that Deployment, Service and Ingress are set up via indivdual calls to <code>kubectl</code>. You could put all these calls into a shell-script to easily replay them, but there is something else in the Kubernets world.
What we will be doing here instead, is define these resources in a YAML file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">apiVersion: apps/v1beta2
kind: Deployment
metadata:
  name: hello-deployment
spec:
  selector:
    matchLabels:
      app: hello
  replicas: 1
  template:
    metadata:
      labels:
        app: hello
    spec:
      containers:
      - name: hello
        image: 38leinad/hello:latest
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: hello-service
spec:
  type: NodePort
  selector:
    app: hello
  ports:
    - port: 8080
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: hello-ingress
spec:
  backend:
    serviceName: hello-service
    servicePort: 8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now simply call <code>kubectl apply -f hello.yml</code>.</p>
</div>
<div class="paragraph">
<p>Get the public IP by running</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl get ingress hello-ingress</pre>
</div>
</div>
<div class="paragraph">
<p>You can now try to open <a href="http://&lt;ip&gt;/hello/resources/health">http://&lt;ip&gt;/hello/resources/health</a> in your browser or with cURL. You should get an "UP" response.
Note that this can actually take some minutes before it will work.</p>
</div>
<div class="paragraph">
<p>Once it worked, you can check the application-server log as well like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl get pods
kubectl logs -f &lt;pod-name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the first command is to get the name of the Pod. The second command will give you the log-output of the container; you might know this from plain Docker already.</p>
</div>
<div class="paragraph">
<p>We succesfully deployed a dockerized application to the Google Cloud via Kubernetes.</p>
</div>
<div class="paragraph">
<p>A final not on why namespaces are useful: What you can do now to start over again is invoke</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl delete namespace hello-namespace</pre>
</div>
</div>
<div class="paragraph">
<p>and <strong>all</strong> the resources in the cluster are gone.</p>
</div>
<div class="paragraph">
<p>Lastly, a cheat-sheet for some of the important <code>kubectl</code> commands can be found <a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/">here</a>.
Here, you will also find how to get auto-completion in your shell which is super-useful. As I am using zsh, I created an alias for it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>alias kubeinit="source &lt;(kubectl completion zsh)"</pre>
</div>
</div>
</div>
</div></p>
  	
		<a href="blog/2018/wlp-eclipselink-logging.html"><h1>Websphere Liberty EclipseLink Logging</h1></a>
		<p class="postingdate"><em>14 May 2018</em></p>

		<p><div class="paragraph">
<p>Websphere Liberty uses EclipseLink as the default JPA-implementation. How to log the SQL-commands from EclipseLink in the Websphere Liberty stdout/console?</p>
</div>
<div class="paragraph">
<p>First step is enabling the logging in the <code>persistence.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;properties&gt;
    &lt;property name="eclipselink.logging.level.sql" value="FINE" /&gt;
    &lt;property name="eclipselink.logging.level" value="FINE" /&gt;
    &lt;property name="eclipselink.logging.level.cache" value="FINE" /&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is not sufficient to get any output on stdout.</p>
</div>
<div class="paragraph">
<p>Additionally, the following snippet needs to be added to the <code>server.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;logging traceSpecification="*=info:eclipselink.sql=all" traceFileName="stdout" traceFormat="BASIC"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set <code>traceFileName="trace.log"</code> to get the statements printed to the <code>trace.log</code> instead.</p>
</div></p>
  	
		<a href="blog/2018/gradle-docker-compose-integration-testing.html"><h1>Gradle and Docker Compose for System Testing</h1></a>
		<p class="postingdate"><em>06 May 2018</em></p>

		<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Recently, I read <a href="http://bmuschko.com/blog/gradle-docker-compose/">this</a> article on a nice Gradle-plugin that allows to use Docker Compose from Gradle.
I wanted to try it out myself with a simple JavaEE app deployed on Open Liberty. In specific, the setup is as follows: The JavaEE application (exposing a Rest endpoint) is deployed on OpenLiberty running within Docker. The system-tests are invocing the Rest endpoint from outside the Docker environment via HTTP.</p>
</div>
<div class="paragraph">
<p>I had two requirements that I wanted to verify in specific:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Usually, when the containers are started from docker-perspecive, it does not mean that also the deployed application is fully up and running. Either you have to write some custom code that monitors the application-log for some marker; or, we can leverage the Docker health-check. Does the Docker Compose Gradle-plugin provide any integration for this so we only run the system-tests once the application is up?</p>
</li>
<li>
<p>System-test will be running on the Jenkins server. Ideally, a lot of tests are running in parallel. For this, it is necessary to use dynamic ports. Otherwise, there could be conflicts for the exposed HTTP ports of the different system-tests. Each system-test somehow needs to be aware of its dynamic ports. Does the Gradle-plugin help us with this?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Indeed, the Gradle-plugin helps us with these two requirements.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rest_service_under_test">Rest Service under Test</h3>
<div class="paragraph">
<p>The Rest endpoint under test looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Stateless
@Path("ping")
public class PingResource {

	static AtomicInteger counter = new AtomicInteger();

	@GET
	public Response ping() {
		if (counter.incrementAndGet() &gt; 10) {
			System.out.println("++ UP");
			return Response.ok("UP@" + System.currentTimeMillis()).build();
		}
		else {
			System.out.println("++ DOWN");
			return Response.serverError().build();
		}

	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I added some simple logic here to only return HTTP status code 200 after some number of request. This is to verify the health-check mechanism works as expected.</p>
</div>
</div>
<div class="sect2">
<h3 id="_system_test">System Test</h3>
<div class="paragraph">
<p>The system-tests is a simple JUnit test using the JAX-RS client to invoke the ping endpoint.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class PingST {

    @Test
    public void testMe() {
        Response response = ClientBuilder.newClient()
            .target("http://localhost:"+ System.getenv("PING_TCP_9080") +"/ping")
            .path("resources/ping")
            .request()
            .get();

        assertThat(response.getStatus(), CoreMatchers.is(200));
        assertThat(response.readEntity(String.class), CoreMatchers.startsWith("UP"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can already see here, that we read the port from an environment variable.
Also, the test should only succeed when we get the response UP.</p>
</div>
</div>
<div class="sect2">
<h3 id="_docker_compose">Docker Compose</h3>
<div class="paragraph">
<p>The <code>docker-compose.yml</code> looks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yml">version: '3.4'
services:
  ping:
    image: openliberty/open-liberty:javaee7
    ports:
     - "9080"
    volumes:
     - "./build/libs/:/config/dropins/"
    healthcheck:
      test: wget --quiet --tries=1 --spider http://localhost:9080/ping/resources/ping || exit 1
      interval: 5s
      timeout: 10s
      retries: 3
      start_period: 30s</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are using the health-check feature here. If you run <code>docker ps</code> the column <code>STATUS</code> will tell you the health of the container based on executing this command.
The ping service should only show up as healthy after ~ 30 + 10 * 5 seconds. This is because it will only start the health-checks after 30 seconds. And then the first 10 requests will return response-code 500. After this, it will flip to status-code 200 and return UP.</p>
</div>
<div class="paragraph">
<p>If the Gradle-plugin makes sure to only run the tests once the health of the container is Ok, the <code>PingST</code> should pass successfully.</p>
</div>
</div>
<div class="sect2">
<h3 id="_gradle_build">Gradle Build</h3>
<div class="paragraph">
<p>The latest part is the <code>build.gradle</code> that brings it all together:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">plugins {
    id 'com.avast.gradle.docker-compose' version '0.7.1'<b class="conum">(1)</b>
}

apply plugin: 'war'
apply plugin: 'maven'
apply plugin: 'eclipse-wtp'

group = 'de.dplatz'
version = '1.0-SNAPSHOT'

sourceCompatibility = 1.8
targetCompatibility = 1.8

repositories {
    jcenter()
}

dependencies {
    providedCompile 'javax:javaee-api:7.0'

    testCompile 'org.glassfish.jersey.core:jersey-client:2.25.1'
    testCompile 'junit:junit:4.12'
}

war {
	archiveName 'ping.war'
}

dockerCompose {<b class="conum">(2)</b>
    useComposeFiles = ['docker-compose.yml']
    isRequiredBy(project.tasks.systemTest)
}

task systemTest( type: Test ) {<b class="conum">(3)</b>
    include '**/*ST*'
    doFirst {
        dockerCompose.exposeAsEnvironment(systemTest)
    }
}

test {
    exclude '**/*ST*'<b class="conum">(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Docker Compose gradle-plugin</p>
</li>
<li>
<p>A seperate task to run system-tests</p>
</li>
<li>
<p>The task to start the Docker environment based on the <code>docker-compose.yml</code></p>
</li>
<li>
<p>Don&#8217;t run system-tests as part of the regular unit-test task</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The tasks <code>composeUp</code> and <code>composeDown</code> can be used to manually start/stop the environment, but the system-test task (<code>systemTest</code>) has a dependency on the Docker environment via <code>isRequiredBy(project.tasks.itest)</code>.</p>
</div>
<div class="paragraph">
<p>We also use <code>dockerCompose.exposeAsEnvironment(itest)</code> to expose the dynamic ports as environment variables to <code>PingST</code>. In the <code>PingST</code> class you can see that <code>PING_TCP_9080</code> is the environment variable name that contains the exposed port on the host for the container-port 9080.</p>
</div>
<div class="paragraph">
<p>Please note that the way I chose to seperate unit-tests and system-tests here in the <code>build.gradle</code> is very pragmatic but might not be ideal for bigger projects. Both tests share the same classpath. You might want to have a seperate Gradle-project for the system-tests altogether.</p>
</div>
</div>
<div class="sect2">
<h3 id="_wrapping_it_up">Wrapping it up</h3>
<div class="paragraph">
<p>We can now run <code>gradle systemTest</code> to run our system-tests.
It will first start the Docker environment and monitor the health of the containers.
Only when the contain is healthy (i.e. the application is fully up and running), will gradle continue and execute <code>PingST</code>.</p>
</div>
<div class="paragraph">
<p>Also, ports are dynamically assigned and the <code>PingST</code> reads them from the environment. With this approach, we can safely run the tests on Jenkins where other tests might already be using ports like 9080.</p>
</div>
<div class="paragraph">
<p>The <code>com.avast.gradle.docker-compose</code> plugin allows us to easily integrate system-tests for JavaEE applications (using Docker) into our Gradle build.
Doing it this way, allows every developer that has Docker installed, to run these tests locally as well and not only on Jenkins.</p>
</div>
</div></p>
  	
		<a href="blog/2018/microprofile-metrics.html"><h1>MicroProfile Metrics</h1></a>
		<p class="postingdate"><em>11 April 2018</em></p>

		<p><div class="paragraph">
<p>These are my personal notes on getting familiar with <a href="https://github.com/eclipse/microprofile-bom/releases/download/1.3/microprofile-spec-1.3.pdf">MicroProfile 1.3</a>. In specific Metrics 1.1.
As a basis, I have been using <a href="https://openliberty.io/guides/microprofile-metrics.html">the tutorial on OpenLiberty.io</a>.
Not suprising, I am using OpenLiberty (version 18.0.0.1). The <code>server.xml</code> which serves as the starting-point is described <a href="/blog/2018/wlp-jee8.html">here</a>.
I am just listing the used features here:</p>
</div>
<div class="listingblock">
<div class="title">server.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;featureManager&gt;
    &lt;feature&gt;javaee-7.0&lt;/feature&gt;
    &lt;feature&gt;localConnector-1.0&lt;/feature&gt;
    &lt;feature&gt;microProfile-1.3&lt;/feature&gt;
&lt;/featureManager&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some differences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>javaee-7.0</code> is used, as Java EE 8 seems not to be supported yet by the release builds.</p>
</li>
<li>
<p><code>microProfile-1.3</code> to enable all features as part of MicroProfile 1.3</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As a starting-point for the actual project I am using my <a href="https://github.com/38leinaD/project-starter/tree/master/war-jee7">Java EE WAR template</a>.</p>
</div>
<div class="paragraph">
<p>To get all MicroProfile 1.3 dependencies available in your gradle-build, you can add the following provided-dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>providedCompile 'org.eclipse.microprofile:microprofile:1.3'</pre>
</div>
</div>
<div class="paragraph">
<p>Now lets write a simple Rest-service to produce some metrics.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Stateless
@Path("magic")
public class MagicNumbersResource {

	static int magicNumber = 0;

	@POST
	@Consumes("text/plain")
	@Counted(name = "helloCount", absolute = true, monotonic = true, description = "Number of times the hello() method is requested")
	@Timed(name = "helloRequestTime", absolute = true, description = "Time needed to get the hello-message")
	public void setMagicNumber(Integer num) throws InterruptedException {
		TimeUnit.SECONDS.sleep(2);
		magicNumber = num;
	}

	@Gauge(unit = MetricUnits.NONE, name = "magicNumberGuage", absolute = true, description = "Magic number")
	public int getMagicNumber() {
		return magicNumber;
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I am using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>@Timed</code> metric that records the percentiles and averages for the duration of the method-invocation</p>
</li>
<li>
<p>A <code>@Counted</code> metric that counts the number of invocations</p>
</li>
<li>
<p>A <code>@Gauge</code> metric that just takes the return-value of the annotated method as the metric-value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now deploy and invoke <code>curl -X POST -H "Content-Type: text/plain" -d "42" <a href="http://localhost:9080/mptest/resources/magic" class="bare">http://localhost:9080/mptest/resources/magic</a></code>. (This assumes the application/WAR is named <code>mptest</code>).</p>
</div>
<div class="paragraph">
<p>Now open <a href="http://localhost:9080/metrics" class="bare">http://localhost:9080/metrics</a> in the browser. You should see the following prometheus-formatted metrics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code># TYPE application:hello_request_time_rate_per_second gauge
application:hello_request_time_rate_per_second 0.1672874737158507
# TYPE application:hello_request_time_one_min_rate_per_second gauge
application:hello_request_time_one_min_rate_per_second 0.2
# TYPE application:hello_request_time_five_min_rate_per_second gauge
application:hello_request_time_five_min_rate_per_second 0.2
# TYPE application:hello_request_time_fifteen_min_rate_per_second gauge
application:hello_request_time_fifteen_min_rate_per_second 0.2
# TYPE application:hello_request_time_mean_seconds gauge
application:hello_request_time_mean_seconds 2.005084111
# TYPE application:hello_request_time_max_seconds gauge
application:hello_request_time_max_seconds 2.005084111
# TYPE application:hello_request_time_min_seconds gauge
application:hello_request_time_min_seconds 2.005084111
# TYPE application:hello_request_time_stddev_seconds gauge
application:hello_request_time_stddev_seconds 0.0
# TYPE application:hello_request_time_seconds summary
# HELP application:hello_request_time_seconds Time needed to get the hello-message
application:hello_request_time_seconds_count 1
application:hello_request_time_seconds{quantile="0.5"} 2.005084111
application:hello_request_time_seconds{quantile="0.75"} 2.005084111
application:hello_request_time_seconds{quantile="0.95"} 2.005084111
application:hello_request_time_seconds{quantile="0.98"} 2.005084111
application:hello_request_time_seconds{quantile="0.99"} 2.005084111
application:hello_request_time_seconds{quantile="0.999"} 2.005084111 <b class="conum">(1)</b>
# TYPE application:magic_number_guage gauge
# HELP application:magic_number_guage Magic number
application:magic_number_guage 42 <b class="conum">(3)</b>
# TYPE application:hello_count counter
# HELP application:hello_count Number of times the hello() method is requested
application:hello_count 1 <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This is one of the percentiles from <code>@Timed</code>. Due to the sleep, it is close to two seconds.</p>
</li>
<li>
<p>This metrics is based on <code>@Counted</code>. We invoked the method once via curl.</p>
</li>
<li>
<p>This metric is based on the <code>@Gauge</code>. We did a post with curl to set the <code>magicNumber</code> to 42. So, this is what the gauge will get from <code>getMagicNumber()</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As a final note: I like the Java EE-approach of having a single dependency to develop against (<code>javax:javaee-api:7.0</code>).
I have used the same approach here for the Microprofile.
If you instead only want to enable the metrics-feature in Liberty and only want to program against the related API, you can instead have used the following feature in the <code>server.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;feature&gt;mpMetrics-1.1&lt;/feature&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>And the following dependency in your <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>providedCompile 'org.eclipse.microprofile.metrics:microprofile-metrics-api:1.1'</pre>
</div>
</div>
<div class="paragraph">
<p>I find this approach more cumbersome if multiple MicroProfile APIs are used; and the neglectable difference in startup-time of Liberty confirms that there is no disadvantage.</p>
</div>
<div class="paragraph">
<p>In a later post we will look at what can be done with the metrics.</p>
</div></p>
  	
		<a href="blog/2018/was-autodeploy.html"><h1>Websphere Traditional, Docker and Auto-Deployment</h1></a>
		<p class="postingdate"><em>10 April 2018</em></p>

		<p><div class="paragraph">
<p>The software I work with on my job is portable accross different application-servers; including Websphere Trational, Websphere Liberty and JBoss.
In the past, it took cosiderable time for me to test/make sure a feature works as expected on Websphere.
In part, because it was hard for me to keep all different websphere version installed on my machine and not mess them up over time.</p>
</div>
<div class="paragraph">
<p>Now, with the <a href="https://hub.docker.com/r/ibmcom/websphere-traditional/">docker images provided by IBM</a>, it has become very easy.
Just fire up a container and test it.</p>
</div>
<div class="paragraph">
<p>To make the testing/deployment very easy, I have enabled auto-deploy in <a href="https://github.com/38leinaD/docker-images/tree/master/websphere-9">my container-image</a>.</p>
</div>
<div class="paragraph">
<p>The image contains a jython script so you don&#8217;t have to apply this configuration manually.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="python">import java.lang.System as sys

cell = AdminConfig.getid('/Cell:DefaultCell01/')
md = AdminConfig.showAttribute(cell, "monitoredDirectoryDeployment")
AdminConfig.modify(md, [['enabled', "true"]])
AdminConfig.modify(md, [['pollingInterval', "1"]])

print AdminConfig.show(md)

AdminConfig.save()

print 'Done.'</code></pre>
</div>
</div>
<div class="paragraph">
<p>It allows me to work with VSCode and Gradle as I have described in <a href="/blog/2018/redeploy.html">this post</a>.</p>
</div>
<div class="paragraph">
<p>Start the docker container with below command to mount the auto-deploy folder as a volume:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker run --name was9 --rm -p 9060:9060 -p 9080:9080 -p 7777:7777 -v ~/junk/deploy:/opt/IBM/WebSphere/AppServer/profiles/AppSrv01/monitoredDeployableApps 38leinad/was-9</pre>
</div>
</div>
<div class="paragraph">
<p>You can now copy a WAR file to <code>~/junk/deploy/servers/server1/</code> on your local system and it will get deployed automatically within the container.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
After this post, I have extended the <code>was-9</code> container so can directly mount <code>/opt/IBM/WebSphere/AppServer/profiles/AppSrv01/monitoredDeployableApps/servers/server1/</code>.
It even supports deployment of a WAR/EAR that is already in this folder when the container is started. This is not the default behaviour of Websphere.
Basically, the container will do a touch on any WAR/EAR in this folder once the auto-deploy service is watching the folder.
</td>
</tr>
</table>
</div></p>
  	
		<a href="blog/2018/gradle-arquillian-chameleon-improved.html"><h1>Gradle and Arquillian Chameleon even simpler</h1></a>
		<p class="postingdate"><em>07 April 2018</em></p>

		<p><div class="paragraph">
<p>In a previous post I have already described how to use Arquillian Chameleon to simplify the Arquillian config.</p>
</div>
<div class="paragraph">
<p>With the latest improvements that are described <a href="http://www.lordofthejars.com/2018/03/arquillian-chameleon-simplifying-your.html">here</a> in more detail,
it is now possible to minimize the required configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Only a single dependency</p>
</li>
<li>
<p>No <code>arquillian.xml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As before, I assume  Gradle 4.6 with <code>enableFeaturePreview('IMPROVED_POM_SUPPORT')</code> in the <code>settings.gradle</code>.</p>
</div>
<div class="paragraph">
<p>With this, we only have to add a single dependency to use arquillian:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">dependencies {
    providedCompile 'javax:javaee-api:7.0'

    testCompile 'org.arquillian.container:arquillian-chameleon-junit-container-starter:1.0.0.CR2'

    testCompile 'junit:junit:4.12'
    testCompile 'org.mockito:mockito-core:2.10.0'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The used container only needs to be defined via the <code>@ChameleonTarget</code> annotation.
Also note the new <code>@RunWith(ArquillianChameleon.class)</code>. This not the regular <code>@RunWith(ArquillianChameleon.class)</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RunWith(ArquillianChameleon.class)
@ChameleonTarget("wildfly:11.0.0.Final:managed")
public class GreetingServiceTest {

    @Deployment
    public static WebArchive deployService() {
        return ShrinkWrap.create(WebArchive.class)
                .addClass(Service.class);
    }

    @Inject
    private Service service;

    @Test
    public void shouldGreetTheWorld() throws Exception {
        Assert.assertEquals("hello world", service.hello());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also support now for not having to write the <code>@Deployment</code> method. Up to now, only for maven-build and specifing a local file.</p>
</div></p>
  	
		<a href="blog/2018/wlp-derby.html"><h1>Open Liberty with DerbyDB</h1></a>
		<p class="postingdate"><em>13 March 2018</em></p>

		<p><div class="paragraph">
<p>In this post I describe how to use Open Liberty with the lightweight Apache Derby database.</p>
</div>
<div class="paragraph">
<p>Here are the steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download <a href="https://db.apache.org/derby/releases/release-10.14.1.0.cgi">Apache Derby</a>.</p>
</li>
<li>
<p>Configure the driver/datasource in the <code>server.xml</code></p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">    &lt;!-- https://www.ibm.com/support/knowledgecenter/de/SS7K4U_liberty/com.ibm.websphere.wlp.zseries.doc/ae/twlp_dep_configuring_ds.html --&gt;
    &lt;variable name="DERBY_JDBC_DRIVER_PATH" value="/home/daniel/dev/tools/db-derby-10.14.1.0-bin/lib"/&gt;
    &lt;library id="DerbyLib"&gt;
        &lt;fileset dir="${DERBY_JDBC_DRIVER_PATH}"/&gt;
    &lt;/library&gt;
    &lt;dataSource id="DefaultDerbyDatasource" jndiName="jdbc/defaultDatasource" statementCacheSize="10" transactional="true"&gt;
       &lt;jdbcDriver libraryRef="DerbyLib"/&gt;
       &lt;properties.derby.embedded connectionAttributes="upgrade=true" createDatabase="create" databaseName="/var/tmp/sample.embedded.db" shutdownDatabase="false"/&gt;
	   &lt;!--properties.derby.client databaseName="/var/tmp/sample.db" user="derbyuser" password="derbyuser" createDatabase="create" serverName="localhost" portNumber="1527" traceLevel="1"/--&gt;
    &lt;/dataSource&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the database is embeeded and file-based. This means, no database-server needs to be started manually.
On application-server startup an embeeded database is started and will write to the file under <code>databaseName</code>.
Use the <code>memory:</code> prefix, to just hold it in main-memory and not on the filesystem.</p>
</div>
<div class="paragraph">
<p>As an alternative, you can also start the Derby-network-server seperately and connect by using the <code>properties.derby.client</code> instead.</p>
</div>
</li>
<li>
<p>In case you want to use the datasource with JPA, provide a <code>persistence.xml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence version="2.1" xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence
             http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd"&gt;

	&lt;persistence-unit name="prod" transaction-type="JTA"&gt;
		&lt;jta-data-source&gt;jdbc/defaultDatasource&lt;/jta-data-source&gt;
		&lt;properties&gt;
			&lt;property name="hibernate.show_sql" value="true" /&gt;
			&lt;property name="eclipselink.logging.level" value="FINE" /&gt;
			&lt;property name="javax.persistence.schema-generation.database.action" value="drop-and-create" /&gt;
			&lt;property name="javax.persistence.schema-generation.scripts.action" value="drop-and-create" /&gt;
			&lt;property name="javax.persistence.schema-generation.scripts.create-target" value="bootstrapCreate.ddl" /&gt;
			&lt;property name="javax.persistence.schema-generation.scripts.drop-target" value="bootstrapDrop.ddl" /&gt;
		&lt;/properties&gt;
	&lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the default settings of Gradle&#8217;s war-plugin, you can place it under <code>src/main/resources/META-INF</code> and the build should package it under <code>WEB-INF/classes/META-INF</code>.</p>
</div>
</li>
<li>
<p>You should now be able to inject the entity-manager via</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@PersistenceContext
EntityManager em;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="https://blog.sebastian-daschner.com/entries/openliberty-with-postgres">This blog</a> has a similar guide on how to use PostgreSQL with Open Liberty.</p>
</div></p>
  	
		<a href="blog/2018/gradle-arquillian-wlp.html"><h1>Gradle and Arquillian for OpenLiberty</h1></a>
		<p class="postingdate"><em>12 March 2018</em></p>

		<p><div class="paragraph">
<p>In this post I describe how to use arquillian together with the container-adapter for Websphere-/Open-Liberty.</p>
</div>
<div class="paragraph">
<p>The dependencies are straight-forward as for any other container-adapter except the additional need for the <code>tools.jar</code> on the classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">dependencies {
    providedCompile 'javax:javaee-api:7.0'

    // this is the BOM
    testCompile 'org.jboss.arquillian:arquillian-bom:1.3.0.Final'
    testCompile 'org.jboss.arquillian.junit:arquillian-junit-container'

    testCompile files("${System.properties['java.home']}/../lib/tools.jar")
    testCompile 'org.jboss.arquillian.container:arquillian-wlp-managed-8.5:1.0.0.CR1'

    testCompile 'junit:junit:4.12'
    testCompile 'org.mockito:mockito-core:2.10.0'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A minimalistic <code>arquillian.xml</code> looks like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;arquillian xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://jboss.org/schema/arquillian"
    xsi:schemaLocation="http://jboss.org/schema/arquillian http://jboss.org/schema/arquillian/arquillian_1_0.xsd"&gt;

    &lt;engine&gt;
        &lt;property name="deploymentExportPath"&gt;build/deployments&lt;/property&gt;
    &lt;/engine&gt;

    &lt;container qualifier="wlp-dropins-deployment" default="true"&gt;
        &lt;configuration&gt;
            &lt;property name="wlpHome"&gt;${wlp.home}&lt;/property&gt;
            &lt;property name="deployType"&gt;dropins&lt;/property&gt;
            &lt;property name="serverName"&gt;server1&lt;/property&gt;
        &lt;/configuration&gt;
    &lt;/container&gt;

&lt;/arquillian&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As there is no good documentation, on the supported properties, I had to look into the <a href="https://github.com/arquillian/arquillian-container-was/blob/b37d9d11bc5c6e38bb0dfeabcc1659c7bd1b0b8f/liberty-managed/src/main/java/org/jboss/arquillian/container/was/wlp_managed_8_5/WLPManagedContainerConfiguration.java">sources</a> over on Github.</p>
</div>
<div class="paragraph">
<p>Also, you might not want to hard-code the <code>wlp.home</code> here. Instead you can define it in your <code>build.gradle</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>test {
    systemProperty "arquillian.launch", "wlp-dropins-deployment"
    systemProperty "wlp.home", project.properties['wlp.home']
}</pre>
</div>
</div>
<div class="paragraph">
<p>This will allow you to run <code>gradle -Pwlp.home=&lt;path-to-wlp&gt; test</code>.</p>
</div></p>
  	
		<a href="blog/2018/gradle-arquillian-wildfly.html"><h1>Gradle and Arquillian for Wildfly</h1></a>
		<p class="postingdate"><em>28 February 2018</em></p>

		<p><div class="paragraph">
<p>In this post I describe how to set up arquillian to test/deploy on Wildfly.
Note that there is a managed and a remote-adapter.
Managed will mean that arquillian manages the application-server and thus starts it.
Remote means that the application-server was already started somehow and arquillian will only connect and deploy the application within this remote server.
Below you will find the dependencies for both types of adpaters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">dependencies {
    providedCompile 'javax:javaee-api:7.0'

    // this is the BOM
    testCompile 'org.jboss.arquillian:arquillian-bom:1.3.0.Final'
    testCompile 'org.jboss.arquillian.junit:arquillian-junit-container'

    testCompile 'org.wildfly.arquillian:wildfly-arquillian-container-managed:2.1.0.Final'
    testCompile 'org.wildfly.arquillian:wildfly-arquillian-container-remote:2.1.0.Final'

    testCompile 'junit:junit:4.12'
    testCompile 'org.mockito:mockito-core:2.10.0'
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Note that the BOM-import will only work with Gradle 4.6+
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An <code>arquillian.xml</code> for both adapters looks like the following. The <code>arquillian-wildfly-managed</code> config is enabled here by default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;arquillian xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://jboss.org/schema/arquillian"
    xsi:schemaLocation="http://jboss.org/schema/arquillian http://jboss.org/schema/arquillian/arquillian_1_0.xsd"&gt;

    &lt;engine&gt;
        &lt;property name="deploymentExportPath"&gt;build/deployments&lt;/property&gt;
    &lt;/engine&gt;

    &lt;!-- Start JBoss manually via:
        ./standalone.sh -Djboss.socket.binding.port-offset=100 -server-config=standalone-full.xml
     --&gt;
    &lt;container qualifier="arquillian-wildfly-remote"&gt;
        &lt;configuration&gt;
            &lt;property name="managementPort"&gt;10090&lt;/property&gt;
        &lt;/configuration&gt;
    &lt;/container&gt;

    &lt;container qualifier="arquillian-wildfly-managed" default="true"&gt;
        &lt;configuration&gt;
            &lt;property name="jbossHome"&gt;/home/daniel/dev/app-servers/jboss-eap-7.0-test&lt;/property&gt;
            &lt;property name="serverConfig"&gt;${jboss.server.config.file.name:standalone-full.xml}&lt;/property&gt;
            &lt;property name="allowConnectingToRunningServer"&gt;true&lt;/property&gt;
        &lt;/configuration&gt;
    &lt;/container&gt;
&lt;/arquillian&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an additional tip: I always set <code>deploymentExportPath</code> to a folder withing gradle&#8217;s build-directory because sometimes it is helpful to have a look at the deployment generated by arquillian/shrinkwrap.</p>
</div>
<div class="paragraph">
<p>In case you don&#8217;t want to define a default adapater or overwrite it (e.g. via a gradle-property from the commandline), you can define the <code>arquillian.launch</code> system property within the test-configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>test {
    systemProperty "arquillian.launch", "arquillian-wildfly-managed"
}</pre>
</div>
</div></p>
  	
		<a href="blog/2018/gradle-arquillian-chameleon.html"><h1>Gradle and Arquillian Chameleon</h1></a>
		<p class="postingdate"><em>26 February 2018</em></p>

		<p><div class="paragraph">
<p>The lastest Gradle 4.6 release candiates come with <a href="https://docs.gradle.org/4.6-rc-2/release-notes.html?_ga=2.148670132.268890152.1519674243-774667617.1508666884#bom-import">BOM-import support</a>.</p>
</div>
<div class="paragraph">
<p>It can be enabled in the <code>settings.gradle</code> by defining <code>enableFeaturePreview('IMPROVED_POM_SUPPORT')</code>.</p>
</div>
<div class="paragraph">
<p>With this, the Arquillian BOM can be easily imported and the dependecies to use Arquillian with the Chameleon Adapter look like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">dependencies {
    providedCompile 'javax:javaee-api:7.0'

    // this is the BOM
    testCompile 'org.jboss.arquillian:arquillian-bom:1.3.0.Final'
    testCompile 'org.jboss.arquillian.junit:arquillian-junit-container'
    testCompile 'org.arquillian.container:arquillian-container-chameleon:1.0.0.Beta3'

    testCompile 'junit:junit:4.12'
    testCompile 'org.mockito:mockito-core:2.10.0'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Chameleon allows to easily manage the container adapters by simple configuration in the <code>arquillian.xml</code>.
As of today, Wildfly and Glassfish are supported but not Websphere liberty.</p>
</div>
<div class="paragraph">
<p>To define Wildfly 11, the following <code>arquillian.xml</code> (place under <code>src/test/resources</code>) is sufficient:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;arquillian xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://jboss.org/schema/arquillian"
    xsi:schemaLocation="http://jboss.org/schema/arquillian http://jboss.org/schema/arquillian/arquillian_1_0.xsd"&gt;

    &lt;container qualifier="wildfly" default="true"&gt;
        &lt;configuration&gt;
            &lt;property name="chameleonTarget"&gt;wildfly:11.0.0.Final:managed&lt;/property&gt;
        &lt;/configuration&gt;
    &lt;/container&gt;
&lt;/arquillian&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this little bit of Gradle and Arquillian magic, you should be able to run a test like below. The Wildfly 11 container will be downloaded on the fly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RunWith(Arquillian.class)
public class GreetingServiceTest {

    @Deployment
    public static WebArchive deployService() {
        return ShrinkWrap.create(WebArchive.class)
                .addClass(Service.class);
    }

    @Inject
    private Service service;

    @Test
    public void shouldGreetTheWorld() throws Exception {
        Assert.assertEquals("hello world", service.hello());
    }
}</code></pre>
</div>
</div></p>
  	
		<a href="blog/2018/redeploy.html"><h1>Gradle: Automatic and IDE-independent redeployments on OpenLiberty</h1></a>
		<p class="postingdate"><em>25 February 2018</em></p>

		<p><div class="paragraph">
<p>The last weeks I have started to experiment how well VSCode can be used for Java EE development.
I have to say that it is quiet exciting to watch what the guys at Microsoft and Red Hat are doing with the <a href="https://code.visualstudio.com/docs/languages/java">Java integration</a>.
The gist of it: It cannot replace a real Java IDE yet for a majority of heavy development, but i can see the potential due to its lightweightness in projects that also involve a JavaScript frontend.
The experience of developing Java and JavaScript in this editor is quiet nice compared to a beast like Eclipse.</p>
</div>
<div class="paragraph">
<p>One of my first goals for quick development: Reproduce the automatical redeploy you get from IDEs like Eclipse (via JBoss Tools). I.e. changing a Java-class automatically triggers a redeploy of the application.
As long as you make sure the WAR-file is small, this deploy task takes less then a second and allows for quick iterations.</p>
</div>
<div class="paragraph">
<p>Here the steps how to make this work in VS Code; actually, they are independent of VSCode and just leverage Gradle&#8217;s continous-build feature.</p>
</div>
<div class="paragraph">
<p>Place this task in your build.gradle. It deploys your application to the dropins-folder of OpenLiberty if you have set up the environment variable <code>wlpProfileHome</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">task deployToWlp(type: Copy, dependsOn: 'war') {
    dependsOn 'build'
    from war.archivePath
    into "${System.env.wlpProfileHome}/dropins"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, make sure to enable automatic redeploys in your <code>server.xml</code> whenever the contents of the dropins-folder change.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;!-- hot-deploy for dropins --&gt;
&lt;applicationMonitor updateTrigger="polled" pollingRate="500ms" dropins="dropins" dropinsEnabled="true"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Every time you run <code>gradlew deployToWlp</code>, this should trigger a redeploy of the latest code.</p>
</div>
<div class="paragraph">
<p>Now comes the next step: Run <code>gradlew deployToWlp -t</code> for <a href="https://docs.gradle.org/current/userguide/continuous_build.html">continuous builds</a>.
Every code-change should trigger a redeploy. This is indepdent of any IDE and thus works nicely together with VS Code in case you want this level of interactivity.
If not, it is very easy to just map a shortcut to the gradle-command in VSCode to trigger it manually.</p>
</div></p>
  	
		<a href="blog/2018/gradle-arquillian-webdriver.html"><h1>Arquillian UI Testing from Gradle</h1></a>
		<p class="postingdate"><em>24 February 2018</em></p>

		<p><div class="paragraph">
<p>Lets for this post assume we want to test some Web UI that is already running somehow. I.e. we don&#8217;t want to start up the container with the web-app from arquillian.</p>
</div>
<div class="paragraph">
<p>Arquillian heavily relies on BOMs to get the right dependencies.
Gradle out of the box is not able to handle BOMs; but we can use the nebula-plugin. Import-scoped POMs are not supported at all.</p>
</div>
<div class="paragraph">
<p>So, make sure you have the following in your <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">plugins {
    id 'nebula.dependency-recommender' version '4.1.2'
}

apply plugin: 'java'

sourceCompatibility = 1.8
targetCompatibility = 1.8

repositories {
    jcenter()
}

dependencyRecommendations {
    mavenBom module: 'org.jboss.arquillian:arquillian-bom:1.2.0.Final'
}

dependencies {
    testCompile 'junit:junit:4.12'

    testCompile "org.jboss.arquillian.junit:arquillian-junit-container"
    testCompile "org.jboss.arquillian.graphene:graphene-webdriver:2.0.3.Final"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RunAsClient
@RunWith(Arquillian.class)
public class HackerNewsIT {

    @Drone
    WebDriver browser;

    @Test
    public void name() {
        browser.get("https://news.ycombinator.com/");
        String title = browser.getTitle();
        Assert.assertThat(title, CoreMatchers.is("Hacker News"));
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run with it with <code>gradle test</code>.</p>
</div>
<div class="paragraph">
<p>By default, HTMLUnit will be used as the browser. To use Chrome, download the <a href="https://sites.google.com/a/chromium.org/chromedriver/WebDriver" class="bare">https://sites.google.com/a/chromium.org/chromedriver/WebDriver</a>.</p>
</div>
<div class="paragraph">
<p>If you dont want to put it on your PATH, tie it to the WebDriver like this in your <code>arquillian.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml"> &lt;arquillian xmlns="http://jboss.com/arquillian" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://jboss.org/schema/arquillian http://jboss.org/schema/arquillian/arquillian_1_0.xsd"&gt;

    &lt;extension qualifier="webdriver"&gt;
        &lt;property name="browser"&gt;chrome&lt;/property&gt;
        &lt;property name="chromeDriverBinary"&gt;/home/daniel/dev/tools/chromedriver&lt;/property&gt;
    &lt;/extension&gt;

&lt;/arquillian&gt;</code></pre>
</div>
</div></p>
  	
		<a href="blog/2018/gradle-checkstyle.html"><h1>Checkstyle with Gradle</h1></a>
		<p class="postingdate"><em>30 January 2018</em></p>

		<p><div class="paragraph">
<p>Get a checkstyle.xml and; e.g. from <a href="https://raw.githubusercontent.com/checkstyle/checkstyle/master/src/main/resources/sun_checks.xml">SUN</a> and place in your gradle-project under <code>config/checkstyle/checkstyle.xml</code>.</p>
</div>
<div class="paragraph">
<p>Now add the following to your <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">apply plugin: 'checkstyle'

checkstyle {
    showViolations = true
    ignoreFailures = false
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run with it with <code>gradle check</code>.</p>
</div>
<div class="paragraph">
<p>If there are violations, a HTML-report will be written to <code>build/reports/checkstyle</code>.</p>
</div></p>
  	
		<a href="blog/2018/wlp-jee8.html"><h1>OpenLiberty Java EE 8 Config</h1></a>
		<p class="postingdate"><em>22 January 2018</em></p>

		<p><div class="paragraph">
<p>I am working of the latest Development Builds of Open Liberty supporting Java EE 8. You can download them <a href="https://openliberty.io/downloads/">here</a> under "Development builds".</p>
</div>
<div class="paragraph">
<p>When you create a new server in Websphere/Open Liberty via <code>${WLP_HOME}/bin/server create server1</code>, the generated <code>server.xml</code> is not configured properly for SSL, Java EE, etc.
Here is a minimal <code>server.xml</code> that works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;server description="new server"&gt;

    &lt;!-- Enable features --&gt;
    &lt;featureManager&gt;
        &lt;feature&gt;javaee-8.0&lt;/feature&gt;
        &lt;feature&gt;localConnector-1.0&lt;/feature&gt;
    &lt;/featureManager&gt;

    &lt;!-- To access this server from a remote client add a host attribute to the following element, e.g. host="*" --&gt;
    &lt;httpEndpoint httpPort="9080" httpsPort="9443" id="defaultHttpEndpoint"/&gt;

    &lt;keyStore id="defaultKeyStore" password="yourpassword"/&gt;

    &lt;!-- Automatically expand WAR files and EAR files --&gt;
    &lt;applicationManager autoExpand="true"/&gt;

    &lt;quickStartSecurity userName="admin" userPassword="admin12!"/&gt;

    &lt;!-- hot-deploy for dropins --&gt;
    &lt;applicationMonitor updateTrigger="polled" pollingRate="500ms"
                    dropins="dropins" dropinsEnabled="true"/&gt;
&lt;/server&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Together with this <code>build.gradle</code> file you can start developing Java EE 8 applications:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">apply plugin: 'war'
apply plugin: 'maven'

group = 'de.dplatz'
version = '1.0-SNAPSHOT'

sourceCompatibility = 1.8
targetCompatibility = 1.8

repositories {
    jcenter()
}

dependencies {
    providedCompile 'javax:javaee-api:8.0'
    testCompile 'junit:junit:4.12'
}

war {
    archiveName 'webapp.war'
}

task deployToWlp(type: Copy, dependsOn: 'war') {
    dependsOn 'build'
    from war.archivePath
    into "${System.env.wlpProfileHome}/dropins"
}</code></pre>
</div>
</div></p>
  	
		<a href="blog/2018/wlp-debug.html"><h1>OpenLiberty Debug Config</h1></a>
		<p class="postingdate"><em>21 January 2018</em></p>

		<p><div class="paragraph">
<p>You can run a Websphere/Open Liberty via <code>${WLP_HOME}/bin/server debug server1</code> in debug-mode.
But this makes the server wait for a debugger to attach. How to attach later?</p>
</div>
<div class="paragraph">
<p>Create a file <code>${WLP_HOME}/usr/servers/server1/jvm.options</code> and add the debug-configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=7777</pre>
</div>
</div>
<div class="paragraph">
<p>Now you can use <code>${WLP_HOME}/bin/server run server1</code>.</p>
</div></p>
  	
		<a href="blog/2018/gradle-wlp-deploy.html"><h1>Gradle deploy-task</h1></a>
		<p class="postingdate"><em>20 January 2018</em></p>

		<p><div class="paragraph">
<p>Deploy to e.g. Websphere liberty by adding this task to your <code>build.gradle</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">task deployToWlp(type: Copy, dependsOn: 'war') {
    dependsOn 'build'
    from war.archivePath
    into "${System.env.wlpProfileHome}/dropins"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming you have the environment-variable set, you can now run <code>gradlew deployToWlp</code>.</p>
</div></p>
  	
		<a href="blog/2017/rest-security-basic.html"><h1>Implementing JAX-RS-security via Basic-auth</h1></a>
		<p class="postingdate"><em>31 October 2017</em></p>

		<p><div class="paragraph">
<p>Basic-auth is the simplest and weakest protection you can add to your resources in a Java EE application. This post shows how to leverage it for JAX-RS-resources that are accessed by a plain HTML5/JavaScript app.</p>
</div>
<div class="paragraph">
<p>Additionally, I had the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The JAX-RS-resource is requested from a prue JavaScript-based webapp via the fetch-API; I want to leverage the authentication-dialog from the browser within the webapp (no custom dialog as the webapp should stay as simple as possible and use as much as possible the standard offered by the browser).</p>
</li>
<li>
<p>But I don&#8217;t want the whole WAR (i.e. JavaScript app) to be protected. Just the request to the JAX-RS-endpoint should be protected via Basic-auth</p>
</li>
<li>
<p>At the server-side I want to be able to connect to my own/custom identity-store; i.e. I want to programatically check the username/password myself. In other words: I don&#8217;t want the application-server&#8217;s internal identity-stores/authentication.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Protecting the JAX-RS-endpoint at server-side is as simple as implementing a request-filter. I could have used a low-level servlet-filter, but instead decided to use the JAX-RS-specific equivalent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">import javax.ws.rs.container.ContainerRequestContext;
import javax.ws.rs.container.ContainerRequestFilter;
import javax.ws.rs.core.Response;
import javax.ws.rs.ext.Provider;

@Provider
public class SecurityFilter implements ContainerRequestFilter {

	@Override
	public void filter(ContainerRequestContext requestContext) throws IOException {
		String authHeader = requestContext.getHeaderString("Authorization");
		if (authHeader == null || !authHeader.startsWith("Basic")) {
			requestContext.abortWith(Response.status(401).header("WWW-Authenticate", "Basic").build());
			return;
		}

		String[] tokens = (new String(Base64.getDecoder().decode(authHeader.split(" ")[1]), "UTF-8")).split(":");
		final String username = tokens[0];
		final String password = tokens[1];

		if (username.equals("daniel") &amp;&amp; password.equals("123")) {
			// all good
		}
		else {
			requestContext.abortWith(Response.status(401).build());
			return;
		}
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>Authorization</code> header is not present, we request the authentication-dialog from the browser by sending the header <code>WWW-Authenticate=Basic</code>.
If i directly open up the JAX-RS-resource in the browser, I get the uthentication-dialog from the browser and can access the resource (if I provide the correct username and password).</p>
</div>
<div class="paragraph">
<p>Now the question is if this also works when the JAX-RS-resource if fetched via the JavaScript fetch-API. I tried this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">function handleResponse(response) {
	if (response.status == "401") {
		alert("not authorized!")
	} else {
		response.json().then(function(data) {
			console.log(data)
		});
	}
}

fetch("http://localhost:8080/service/resources/health").then(handleResponse);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It did not work; I was getting 401 from the server because the browser was not sending the "Authorization" header; but the browser also did not show the authentication-dialog.</p>
</div>
<div class="paragraph">
<p>A peak into the <a href="https://fetch.spec.whatwg.org/#http-network-fetch">spec</a> hinted that it should work:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If request’s use-URL-credentials flag is unset or authentication-fetch flag is set, then run these subsubsteps:
&#8230;&#8203;</p>
</li>
<li>
<p>Let username and password be the result of prompting the end user for a username and password, respectively, in request’s window.</p>
</li>
</ol>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>So, i added the <code>credentials</code> to the fetch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">fetch("http://localhost:8080/service/resources/health", {credentials: 'same-origin'}).then(handleResponse);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It worked. The browser shows the authentication-dialog after the first 401. In subsequent request to the JAX-RS-resouce, the "Authorization" header is always sent along. No need to reenter every time (Chrome discards it as soon as the browser window is closed).</p>
</div>
<div class="paragraph">
<p>The only disadvantage I found so far is from a development-perspective.
I usually run the JAX-RS-endpoint seperately from my Javascript app; i.e. the JAX-RS-endpoint is hosted as a WAR in the application-server but the JavaScript-app is hosted via LiveReload or browser-sync.
In this case, the JAX-RS-service and the webapp do not have the same origin (different port) and I have to use the CORS-header <code>Access-Control-Allow-Origin=*</code> to allow communication between the two.
But with this header set, the Authorization-token collected by the JavaScript-app will not be shared with the JAX-RS-endpoint.</p>
</div></p>
  	
		<a href="blog/2017/github-fork.html"><h1>Github - Switch to fork</h1></a>
		<p class="postingdate"><em>05 October 2017</em></p>

		<p><div class="paragraph">
<p>Say you just have cloned a massive github repository (like <a href="https://github.com/apache/incubator-netbeans">Netbeans</a>) where cloning already takes minutes and now decide to contribute.
You will fork the repo and than clone the fork and spend another X minutes waiting?</p>
</div>
<div class="paragraph">
<p>This sometimes seems like to much of an effort. And thankfully, there are steps how you can transform the already cloned repo to use your fork.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Fork the repo</p>
</li>
<li>
<p>Rename origin to upstream (your fork will be origin)</p>
<div class="literalblock">
<div class="content">
<pre>git remote rename origin upstream</pre>
</div>
</div>
</li>
<li>
<p>Set origin as your fork</p>
<div class="literalblock">
<div class="content">
<pre>git remote add origin git@github...my-fork</pre>
</div>
</div>
</li>
<li>
<p>Fetch origin</p>
<div class="literalblock">
<div class="content">
<pre>git fetch origin</pre>
</div>
</div>
</li>
<li>
<p>Make master track new origin/master</p>
<div class="literalblock">
<div class="content">
<pre>git checkout -B master --track origin/master</pre>
</div>
</div>
</li>
</ol>
</div></p>
  	
		<a href="blog/2017/was-jvisualvm-jmx.html"><h1>Websphere and JVisualVM</h1></a>
		<p class="postingdate"><em>25 September 2017</em></p>

		<p><div class="paragraph">
<p>How to inspect a Websphere server via JVisualVM?</p>
</div>
<div class="paragraph">
<p>Go to "Application servers &gt; SERVER-NAME &gt; Java and Process management &gt; Process Defintion &gt; Java Virtual Machine &gt; Generic JVM arguments" and add the following JMV settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>-Djavax.management.builder.initial= \
-Dcom.sun.management.jmxremote \
-Dcom.sun.management.jmxremote.authenticate=false \
-Dcom.sun.management.jmxremote.ssl=false \
-Dcom.sun.management.jmxremote.local.only=false \
-Dcom.sun.management.jmxremote.port=1099 \
-Djava.rmi.server.hostname=10.226.2.64</code></pre>
</div>
</div>
<div class="paragraph">
<p>Providing an external ip or hostname was important for it to work.</p>
</div>
<div class="paragraph">
<p>Select "Add JMX Connection" in JVisualVM and enter: 10.226.2.64:1099.</p>
</div></p>
  	
		<a href="blog/2017/was-jconsole-jmx.html"><h1>Websphere Administration via JMX, JConsole and JVisualVM</h1></a>
		<p class="postingdate"><em>25 September 2017</em></p>

		<p><div class="paragraph">
<p>How to connect to the Websphere-specific MBean server to configure the environment and monitor the applications?</p>
</div>
<div class="paragraph">
<p>Start JConsole with the following script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#!/bin/bash

# Change me!
export HOST=swpsws16
# This is ORB_LISTENER_ADDRESS
export IIOP_PORT=9811

export WAS_HOME=/home/daniel/IBM/WebSphere/AppServer

export PROVIDER=-Djava.naming.provider.url=corbaname:iiop:$HOST:$IIOP_PORT

export CLASSPATH=
export CLASSPATH=$CLASSPATH:$WAS_HOME/java/lib/tools.jar
export CLASSPATH=$CLASSPATH:$WAS_HOME/runtimes/com.ibm.ws.admin.client_8.5.0.jar
export CLASSPATH=$CLASSPATH:$WAS_HOME/runtimes/com.ibm.ws.ejb.thinclient_8.5.0.jar
export CLASSPATH=$CLASSPATH:$WAS_HOME/runtimes/com.ibm.ws.orb_8.5.0.jar
export CLASSPATH=$CLASSPATH:$WAS_HOME/java/lib/jconsole.jar

export URL=service:jmx:iiop://$HOST:$IIOP_PORT/jndi/JMXConnector

$WAS_HOME/java/bin/java -classpath $CLASSPATH $PROVIDER sun.tools.jconsole.JConsole $URL</pre>
</div>
</div>
<div class="paragraph">
<p>Even nicer: Install <a href="https://github.com/veithen/visualwas">VisualWAS</a> plugin for JVisualVM.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use "Add JMX Connection"</p>
</li>
<li>
<p>Use Connection-Type "Websphere"</p>
</li>
<li>
<p>For port, use SOAP_CONNECTOR_ADDRESS (default 8880)</p>
</li>
</ul>
</div></p>
  	
		<a href="blog/2017/jenkins-docker-host.html"><h1>Jenkins in Docker using Docker</h1></a>
		<p class="postingdate"><em>23 September 2017</em></p>

		<p><div class="paragraph">
<p>Say you want to run your Jenkins itself in docker. But the Jenkins build-jobs also uses docker!?</p>
</div>
<div class="paragraph">
<p>Either you have to install docker in docker, or you let the Jenkins docker-client access the host&#8217;s docker-daemon.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Map the unix socket into the Jenkins container:</p>
<div class="listingblock">
<div class="content">
<pre>-v /var/run/docker.sock:/var/run/docker.sock</pre>
</div>
</div>
</li>
<li>
<p>But the jenkins user will not have permissions to access the socket by default. So, first check the GID of the group that owns the socket:</p>
<div class="listingblock">
<div class="content">
<pre>getent group dockerroot</pre>
</div>
</div>
</li>
<li>
<p>Now create a group (name is irrelevant; lets name it "docker") in the Jenkins container with the same GID and assign the jenkins user to it:</p>
<div class="listingblock">
<div class="content">
<pre>sudo groupadd -g 982 docker
sudo usermod -aG docker jenkins</pre>
</div>
</div>
</li>
</ol>
</div></p>
  	
		<a href="blog/2017/nashorn-jdk9.html"><h1>ES6 with Nashorn in JDK9</h1></a>
		<p class="postingdate"><em>14 June 2017</em></p>

		<p><div class="paragraph">
<p>JDK9 is planning to incrementally support the ES6 features of JavaScript. In the current early-access builds (tested with 9-ea+170), major features like classes are not supported yet; but keywords like let/const, arrow functions and string-interpolation already work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">#!jjs --language=es6
"use strict";

let hello = (from, to) =&gt; print(`Hello from ${from} to ${to}`);

if ($EXEC('uname -n')) {
    let hostname = $OUT.trim();
    hello(hostname, 'daniel');
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For details on what&#8217;s included by now, read <a href="http://openjdk.java.net/jeps/292">JEP 292</a>.</p>
</div></p>
  	
		<a href="blog/2017/aws-ec2.html"><h1>AWS ECS: Push a docker container</h1></a>
		<p class="postingdate"><em>28 May 2017</em></p>

		<p><div class="paragraph">
<p>Steps to deploy docker containers to AWS EC2:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Created a docker-repository with the name <code>de.dplatz/abc</code>, you will get a page with all the steps and coordinates for <code>docker login</code>, <code>docker tag</code> and <code>docker push</code>.</p>
</li>
<li>
<p>From CLI run:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>aws ecr get-login --region eu-central-1
docker tag de.dplatz/abc:latest &lt;my-aws-url&gt;/de.dplatz/abc:latest
docker push &lt;my-aws-url&gt;/de.dplatz/abc:latest</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>See <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/docker-basics.html">here</a> for starting the container.</p>
</div></p>
  	
		<a href="blog/2017/jdk9-httpclient.html"><h1>JDK9 HttpClient</h1></a>
		<p class="postingdate"><em>20 May 2017</em></p>

		<p><div class="paragraph">
<p>Required some clarification from the JDK team how to access the new HttpClient API (which actually is incubating now):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>$ ./jdk-9_168/bin/jshell --add-modules jdk.incubator.httpclient
|  Welcome to JShell -- Version 9-ea
|  For an introduction type: /help intro

jshell&gt; import jdk.incubator.http.*;

jshell&gt; import static jdk.incubator.http.HttpResponse.BodyHandler.*;

jshell&gt; URI uri = new URI("http://openjdk.java.net/projects/jigsaw/");
uri ==&gt; http://openjdk.java.net/projects/jigsaw/

jshell&gt; HttpRequest request = HttpRequest.newBuilder(uri).build();
request ==&gt; http://openjdk.java.net/projects/jigsaw/ GET

jshell&gt; HttpResponse response = HttpClient.newBuilder().build().send(request, discard(null));
response ==&gt; jdk.incubator.http.HttpResponseImpl@133814f

jshell&gt; response.statusCode();
$6 ==&gt; 200</code></pre>
</div>
</div>
<div class="paragraph">
<p>I really like the jshell-integration in Netbeans; unfortunately, it does not allow to set commandline-flags for the started shells yet. Filed an <a href="https://netbeans.org/bugzilla/show_bug.cgi?id=270692">issue</a> and got a workaround for now.</p>
</div></p>
  	
		<a href="blog/2017/wlp-admin-console.html"><h1>Websphere Liberty Admin Console</h1></a>
		<p class="postingdate"><em>12 May 2017</em></p>

		<p><div class="listingblock">
<div class="content">
<pre>$ bin/installUtility install adminCenter-1.0</pre>
</div>
</div>
<div class="listingblock">
<div class="title">server.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;!-- Enable features --&gt;
&lt;featureManager&gt;
    &lt;!-- ... --&gt;
    &lt;feature&gt;adminCenter-1.0&lt;/feature&gt;
&lt;/featureManager&gt;

&lt;keyStore id="defaultKeyStore" password="admin123" /&gt;

&lt;basicRegistry id="basic" realm="BasicRealm"&gt;
    &lt;user name="admin" password="admin123" /&gt;
&lt;/basicRegistry&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>[AUDIT   ] CWWKT0016I: Web application available (default_host): http://localhost:9090/adminCenter/</pre>
</div>
</div></p>
  	
		<a href="blog/2017/docker-jvm-params.html"><h1>Docker JVM Memory Settings</h1></a>
		<p class="postingdate"><em>01 May 2017</em></p>

		<p><div class="paragraph">
<p>Read <a href="http://trustmeiamadeveloper.com/2016/03/18/where-is-my-memory-java/">this</a>,
<a href="http://blog.jelastic.com/2017/04/13/java-ram-usage-in-containers-top-5-tips-not-to-lose-your-memory/">this</a> and
<a href="https://blogs.oracle.com/java-platform-group/java-se-support-for-docker-cpu-and-memory-limits">this</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK9 has <code>-XX:+UseCGroupMemoryLimitForHeap</code></p>
</li>
<li>
<p>JDK8 pre 131: Always specify <code>-Xmx1024m</code> and <code>-XX:MaxMetaspaceSize</code></p>
</li>
<li>
<p>JDK8 since 131: <code>-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap</code></p>
</li>
</ul>
</div></p>
  	
		<a href="blog/2017/strace.html"><h1>strace</h1></a>
		<p class="postingdate"><em>01 May 2017</em></p>

		<p><div class="paragraph">
<p>Read <a href="https://blog.packagecloud.io/eng/2017/03/14/using-strace-to-understand-java-performance-improvement/" class="bare">https://blog.packagecloud.io/eng/2017/03/14/using-strace-to-understand-java-performance-improvement/</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>strace -fopen,read,close,fstat java -jar Test.jar</pre>
</div>
</div></p>
  	
		<a href="blog/2017/docker-rest-api.html"><h1>Docker Rest API</h1></a>
		<p class="postingdate"><em>01 May 2017</em></p>

		<p><div class="paragraph">
<p>SSL keys are at <code>/cygdrive/c/Users/&lt;username&gt;/.docker/machine/machines/default</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre> curl --insecure -v --cert cert.pem --key key.pem -X GET https://192.168.99.100:2376/images/json</pre>
</div>
</div></p>
  	
		<a href="blog/2017/eclipse-stacktrace.html"><h1>Stacktrace in Eclipse Debugger</h1></a>
		<p class="postingdate"><em>12 April 2017</em></p>

		<p><div class="paragraph">
<p>How to see the stacktrace for an exception-variable within the eclipse debugger?</p>
</div>
<div class="paragraph">
<p>Go to Preferences / Java / Debug / Detail Formatter; Add for Throwable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">java.io.Writer stackTrace = new java.io.StringWriter();
java.io.PrintWriter printWriter = new java.io.PrintWriter(stackTrace);
printStackTrace(printWriter);
return getMessage() + "\n" + stackTrace;</code></pre>
</div>
</div></p>
  	
		<a href="blog/2017/java-debug-flags.html"><h1>Java debug-flags</h1></a>
		<p class="postingdate"><em>22 March 2017</em></p>

		<p><div class="listingblock">
<div class="content">
<pre>-Xdebug
// shared-memory (windows only)
-agentlib:jdwp=transport=dt_shmem,address=eclipse,server=y,suspend=n
// socket
-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=9999</pre>
</div>
</div></p>
  	
		<a href="blog/2017/inotifywait.html"><h1>inotifywait</h1></a>
		<p class="postingdate"><em>07 March 2017</em></p>

		<p><div class="paragraph">
<p>Monitor filesystem-changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>while inotifywait -qr /dir/to/monitor; do
    rsync -avz /dir/to/monitor/ /dir/to/sync/to
done</pre>
</div>
</div></p>
  	
		<a href="blog/2017/jar-list.html"><h1>List classes in Jar</h1></a>
		<p class="postingdate"><em>29 January 2017</em></p>

		<p><div class="paragraph">
<p>List all classes in a jar-file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ unzip -l MyJar.jar "*.class" | tail -n+4 | head -n-2 | tr -s ' ' | cut -d ' ' -f5 | tr / . | sed 's/\.class$//'</pre>
</div>
</div></p>
  	
		<a href="blog/2017/rsync-tricks.html"><h1>rsync tricks</h1></a>
		<p class="postingdate"><em>20 January 2017</em></p>

		<p><div class="paragraph">
<p>This command removes files that have been removed from the source directory but will not overwrite newer files in the destination:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ rsync -avu --delete sourcedir/ /cygwin/e/destdir/</pre>
</div>
</div>
<div class="paragraph">
<p>To rsync to another system with ssh over the net:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ rsync -avu --delete -e ssh sourcedir/ username@machine:~/destdir/</pre>
</div>
</div></p>
  	
		<a href="blog/2017/shell-alias-expansion.html"><h1>Shell Alias-Expansion</h1></a>
		<p class="postingdate"><em>17 January 2017</em></p>

		<p><div class="paragraph">
<p>Say, you have defined an alias:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ alias gg='git log --oneline --decorate --graph'</pre>
</div>
</div>
<div class="paragraph">
<p>But when typing 'gg' wouldn&#8217;t it be nice to expand the alias so you can make a small modification to the args?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ gg&lt;Ctrl+Alt+e&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Say, you want to easily clear the screen; there is a shortcut Ctrl+L. But maybe you also always want to print the contents of the current directory: you can rebind the shortcut:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bind -x '"\C-l": clear; ls -l'</pre>
</div>
</div></p>
  	
		<a href="blog/2017/java-major.html"><h1>Java Version Strings</h1></a>
		<p class="postingdate"><em>16 January 2017</em></p>

		<p><div class="paragraph">
<p>For what JDK version is a class compiled?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ javap -verbose MyClass.class | grep "major"</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Java 5: major version 49</p>
</li>
<li>
<p>Java 6: major version 50</p>
</li>
<li>
<p>Java 7: major version 51</p>
</li>
<li>
<p>Java 8: major version 52</p>
</li>
</ul>
</div></p>
  	
		<a href="blog/2017/ssh-keys.html"><h1>SSH Keys</h1></a>
		<p class="postingdate"><em>13 January 2017</em></p>

		<p><div class="paragraph">
<p>To connect to a remote-host without password-entry (for scripting):</p>
</div>
<div class="listingblock">
<div class="content">
<pre># generate ssh keys for local (if not already done)
$ ssh-keygen
$ ssh-copy-id -i ~/.ssh/id_rsa.pub &lt;remote-host&gt;
$ ssh &lt;remote-host&gt;</pre>
</div>
</div></p>
  	
		<a href="blog/2017/maven-fat-and-thin.html"><h1>Maven Fat & Thin Jar</h1></a>
		<p class="postingdate"><em>12 January 2017</em></p>

		<p><div class="paragraph">
<p>Building a fat and a thin jar in one go:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.4.3&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;shade&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
                &lt;shadedArtifactAttached&gt;true&lt;/shadedArtifactAttached&gt;
                &lt;shadedClassifierName&gt;all&lt;/shadedClassifierName&gt;
                &lt;transformers&gt;
                    &lt;transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"&gt;
                        &lt;mainClass&gt;com.mycompany.myproduct.Main&lt;/mainClass&gt;
                    &lt;/transformer&gt;
                &lt;/transformers&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div></p>
  	
		<a href="blog/2017/commandline-http-server.html"><h1>Commandline HTTP-Server</h1></a>
		<p class="postingdate"><em>10 January 2017</em></p>

		<p><div class="paragraph">
<p>A very simple http-server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>while true ; do echo -e  "HTTP/1.1 200 OK\nAccess-Control-Allow-Origin: *\n\n $(cat index.html)" |  nc -l localhost 1500; done</pre>
</div>
</div></p>
  	
	
	<hr />
	
	<p>Older posts are available in the <a href="archive.html">archive</a>.</p>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2018 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.7.0-rc.7</a></p>
      </div>
    </div>
    
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/prettify.js"></script>
    <script src="js/custom.js"></script>
  </body>
</html>